# ============================================================
# ðŸ”¥ FACE-RECOGNITION ATTENDANCE ROUTER
# FILE: app/routers/attendance/attendance_punch.py
# ============================================================

from fastapi import APIRouter, Request, Depends, HTTPException
from fastapi.responses import HTMLResponse
from sqlalchemy.orm import Session
from datetime import datetime, date
import base64, numpy as np, face_recognition

from app.database import get_db
from app.database.models.employee_registration import Employee
from app.database.models.attendance import Attendance


router = APIRouter(prefix="/attendance", tags=["Attendance"])



# ------------------------------------------------------------
# UI PAGE â€” OPEN ATTENDANCE FACE SCREEN
# ------------------------------------------------------------
@router.get("/entry", response_class=HTMLResponse)
def attendance_page(request: Request):
    return request.app.state.templates.TemplateResponse(
        "attendance/attendance_punch.html",
        {"request": request}
    )



# ============================================================
# FACE MATCH + ATTENDANCE SAVE
# ------------------------------------------------------------
@router.post("/verify")
def verify_and_log(data: dict, db: Session = Depends(get_db)):

    # Convert base64 â†’ numpy image
    def b64_to_img(b64):
        raw = base64.b64decode(b64.split(",")[1])
        img = face_recognition.load_image_file(np.frombuffer(raw, np.uint8))
        return img

    img_new = b64_to_img(data["photo"])
    new_enc = face_recognition.face_encodings(img_new)

    if not new_enc:
        return {"success": False, "msg": "Face not detected clearly"}

    # Load all employees from DB for matching
    employees = db.query(Employee).all()
    known_faces = []
    ref_list = []

    for e in employees:
        if e.face_img1:
            raw = base64.b64decode(e.face_img1.split(",")[1])
            img = face_recognition.load_image_file(np.frombuffer(raw, np.uint8))
            enc = face_recognition.face_encodings(img)
            if enc:
                known_faces.append(enc[0])
                ref_list.append(e)

    # Compare face with all stored faces
    matches = face_recognition.compare_faces(known_faces, new_enc[0])

    if True not in matches:
        return {"success": False, "msg": "Face not found in database"}

    emp = ref_list[matches.index(True)]  # matched employee row


    # ----------------------------------------
    # SAVE ATTENDANCE ENTRY
    # ----------------------------------------
    punch_type = data["punch"]    # IN / OUT
    now = datetime.now()

    rec = Attendance(
        employee_id = emp.employee_id,
        name = emp.name,
        punch_type = punch_type,
        date = date.today(),
        time = now.time()
    )

    db.add(rec)
    db.commit()

    return {
        "success": True,
        "employee_id": emp.employee_id,
        "name": emp.name,
        "status": f"PUNCH {punch_type} RECORDED"
    }
