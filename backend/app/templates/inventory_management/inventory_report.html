<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>INVENTORY REPORT</title>

<style>
  body{font-family:Arial, sans-serif;background:#e6f2ff;margin:0;}
  h2{background:#003366;color:white;text-align:center;padding:10px;margin:0;}

  .box{
    background:white;width:95%;margin:18px auto;padding:18px;
    border-radius:10px;box-shadow:0 0 6px rgba(0,0,0,.2);
  }

  .filter-row{
    display:flex;flex-wrap:wrap;gap:10px;margin-bottom:10px;
    align-items:center;
  }
  .filter-row label{font-size:13px;color:#003366;font-weight:600;margin-right:3px;}
  .filter-row select{
    padding:4px 6px;border-radius:5px;border:1px solid #a3bcd6;
    font-size:13px;background:#f7fbff;min-width:130px;
  }

  .summary-wrap{
    max-height:60vh;
    overflow-y:auto;
    border-radius:8px;
    box-shadow:0 0 4px rgba(0,0,0,0.15);
    background:white;
  }

  table{width:100%;border-collapse:collapse;background:white;}
  th,td{padding:8px;border:1px solid #ddd;font-size:13px;}
  th{
    background:#003366;color:#fff;position:sticky;top:0;z-index:2;
  }
  tr:hover:not(.subrow){background:#d9e7ff;cursor:pointer;}

  .subrow td{
    background:#f3f6ff;
  }

  .section-title{
    font-weight:bold;background:#004c99;color:white;
    padding:6px;border-radius:5px;margin-top:3px;
  }
  .section-title.green{
    background:#0a6d42;
  }

  .inner-table{margin-top:6px;border:1px solid #bbb;}
  .inner-table th{position:static;background:#004c99;}

</style>

</head>
<body>

<h2>INVENTORY SUMMARY</h2>

<div class="box">

  <!-- ðŸ” Filters -->
  <div class="filter-row">
    <label>Grade</label>
    <select id="gradeFilter" onchange="applyFilters()">
      <option value="">All</option>
    </select>

    <label>Variety</label>
    <select id="varietyFilter" onchange="applyFilters()">
      <option value="">All</option>
    </select>

    <label>Glaze</label>
    <select id="glazeFilter" onchange="applyFilters()">
      <option value="">All</option>
    </select>

    <label>Freezer</label>
    <select id="freezerFilter" onchange="applyFilters()">
      <option value="">All</option>
    </select>

    <label>Packing</label>
    <select id="packingFilter" onchange="applyFilters()">
      <option value="">All</option>
    </select>
  </div>

  <!-- SUMMARY TABLE (scrollable) -->
  <div class="summary-wrap">
    <table id="summaryTbl">
      <thead>
        <tr>
          <th>Batch</th>
          <th>Brand</th>
          <th>Variety</th>
          <th>Grade</th>
          <th>Glaze</th>
          <th>Freezer</th>
          <th>Packing</th>
          <th style="color:yellow;">TOTAL KG</th>
        </tr>
      </thead>
      <tbody>
      {% for key,total in summary.items() %}
        <tr class="sumRow"
            data-batch="{{key[0]}}"
            data-brand="{{key[1]}}"
            data-variety="{{key[2]}}"
            data-grade="{{key[3]}}"
            data-glaze="{{key[4]}}"
            data-freezer="{{key[5]}}"
            data-pack="{{key[6]}}"
            onclick="toggleExpand(this)">
          <td>{{key[0]}}</td>
          <td>{{key[1]}}</td>
          <td>{{key[2]}}</td>
          <td>{{key[3]}}</td>
          <td>{{key[4]}}</td>
          <td>{{key[5]}}</td>
          <td>{{key[6]}}</td>
          <td><b>{{"%.2f"|format(total)}}</b></td>
        </tr>
      {% endfor %}
      </tbody>
    </table>
  </div>

</div>

<script>
let openRow = null;

// --------- AUTO-BUILD FILTER OPTIONS FROM TABLE ----------
document.addEventListener("DOMContentLoaded", () => {
  const rows = document.querySelectorAll(".sumRow");
  const sets = {
    grade: new Set(),
    variety: new Set(),
    glaze: new Set(),
    freezer: new Set(),
    pack: new Set()
  };

  rows.forEach(r => {
    if(r.dataset.grade)   sets.grade.add(r.dataset.grade);
    if(r.dataset.variety) sets.variety.add(r.dataset.variety);
    if(r.dataset.glaze)   sets.glaze.add(r.dataset.glaze);
    if(r.dataset.freezer) sets.freezer.add(r.dataset.freezer);
    if(r.dataset.pack)    sets.pack.add(r.dataset.pack);
  });

  fillSelect("gradeFilter",   Array.from(sets.grade).sort());
  fillSelect("varietyFilter", Array.from(sets.variety).sort());
  fillSelect("glazeFilter",   Array.from(sets.glaze).sort());
  fillSelect("freezerFilter", Array.from(sets.freezer).sort());
  fillSelect("packingFilter", Array.from(sets.pack).sort());
});

function fillSelect(id, values){
  const sel = document.getElementById(id);
  values.forEach(v=>{
    const opt = document.createElement("option");
    opt.value = v;
    opt.textContent = v;
    sel.appendChild(opt);
  });
}

// --------- CLIENT SIDE FILTERING ----------
function applyFilters(){
  const g  = document.getElementById("gradeFilter").value;
  const v  = document.getElementById("varietyFilter").value;
  const gl = document.getElementById("glazeFilter").value;
  const f  = document.getElementById("freezerFilter").value;
  const p  = document.getElementById("packingFilter").value;

  document.querySelectorAll(".sumRow").forEach(row=>{
    const ok =
      (!g  || row.dataset.grade   === g)  &&
      (!v  || row.dataset.variety === v)  &&
      (!gl || row.dataset.glaze   === gl) &&
      (!f  || row.dataset.freezer === f)  &&
      (!p  || row.dataset.pack    === p);

    row.style.display = ok ? "" : "none";

    // also hide its expanded block (if open)
    const nxt = row.nextElementSibling;
    if(nxt && nxt.classList.contains("subrow")){
      nxt.style.display = ok ? "" : "none";
    }
  });
}

// --------- EXPAND / COLLAPSE ----------
function toggleExpand(row){
  // same row again â†’ collapse
  if(openRow === row){
    closeAll();
    openRow = null;
    return;
  }

  closeAll();
  openRow = row;
  loadDetailsForRow(row);
}

function closeAll(){
  document.querySelectorAll(".subrow").forEach(r => r.remove());
  openRow = null;
}

// --------- LOAD LOCATION + TRANSACTIONS (same block) ----------
function loadDetailsForRow(row){
  const payload = {
    batch:         row.dataset.batch,
    brand:         row.dataset.brand,
    variety:       row.dataset.variety,
    grade:         row.dataset.grade,
    glaze:         row.dataset.glaze,
    freezer:       row.dataset.freezer,
    packing_style: row.dataset.pack
  };

  // create one sub row just after clicked row
  const sub = document.createElement("tr");
  sub.className = "subrow";
  sub.innerHTML = `
    <td colspan="8">
      <div class="section-title">ðŸ“¦ LOCATION WISE SUMMARY</div>
      <table class="inner-table" id="loc_${row.rowIndex}">
        <tr><td>Loading...</td></tr>
      </table>

      <div class="section-title green">ðŸ“„ FULL STOCK TRANSACTIONS</div>
      <table class="inner-table" id="txn_${row.rowIndex}">
        <tr><td>Loading...</td></tr>
      </table>
    </td>
  `;
  row.insertAdjacentElement("afterend", sub);

  // 1) Location wise
  fetch("/inventory/inventory_report/location", {
    method: "POST",
    body: new URLSearchParams(payload)
  })
  .then(r => r.json())
  .then(data => {
    let html = `<tr><th>Location</th><th>Total KG</th></tr>`;
    const keys = Object.keys(data);
    if(keys.length === 0){
      html += `<tr><td colspan="2">No data</td></tr>`;
    }else{
      keys.forEach(loc => {
        html += `<tr>
                  <td><b>${loc}</b></td>
                  <td><b>${data[loc]}</b></td>
                 </tr>`;
      });
    }
    document.getElementById("loc_"+row.rowIndex).innerHTML = html;
  });

  // 2) All IN/OUT transactions
  fetch("/inventory/inventory_report/transactions", {
    method: "POST",
    body: new URLSearchParams(payload)
  })
  .then(r => r.json())
  .then(list => {
    let html = `
      <tr>
        <th>Date</th>
        <th>Movement</th>
        <th>No. of MC</th>
        <th>Loose</th>
        <th>KG</th>
        <th>PO</th>
        <th>Purpose</th>
        <th>Production At</th>
      </tr>
    `;

    if(!list.length){
      html += `<tr><td colspan="8">No transactions</td></tr>`;
    }else{
      list.forEach(r => {
        const qtyCell = (r.move === "OUT")
          ? `<td style="color:red;font-weight:bold;">${r.qty}</td>`
          : `<td>${r.qty}</td>`;
        html += `
          <tr>
            <td>${r.date}</td>
            <td>${r.move}</td>
            <td>${r.mc}</td>
            <td>${r.loose}</td>
            ${qtyCell}
            <td>${r.po}</td>
            <td>${r.purpose}</td>
            <td>${r.prod}</td>
          </tr>
        `;
      });
    }
    document.getElementById("txn_"+row.rowIndex).innerHTML = html;
  });
}

</script>

</body>
</html>
