<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Processing Summary – BKNR ERP</title>

<style>
:root{
  --border:#d6dde7;
  --text:#1f2937;
  --bg:#f4f6f9;
}
*{box-sizing:border-box;font-family:Segoe UI,Arial,sans-serif}
body{margin:0;background:var(--bg);color:var(--text)}

/* ================= HEADER ================= */
.header{
  position:sticky;
  top:0;
  z-index:100;
  background:var(--bg);
  padding:16px 18px 10px;
  border-bottom:1px solid var(--border);
}
.header h2{margin:0;font-size:24px;color:#1f3a5f}
.header p{margin:4px 0 0;font-size:13px;color:#6b7280}

/* ================= FILTERS ================= */
.filters{
  margin-top:10px;
  background:#fff;
  padding:12px;
  border-radius:10px;
  display:grid;
  grid-template-columns:repeat(3,1fr);
  gap:12px;
  border:1px solid var(--border)
}
.filters label{font-size:12px;font-weight:600}
.filters select,.filters input{
  margin-top:6px;
  padding:8px;
  border-radius:6px;
  border:1px solid var(--border)
}

/* ================= ACTIONS ================= */
.actions{
  margin-top:10px;
  display:flex;
  gap:8px;
}
.actions button{
  padding:6px 12px;
  border-radius:6px;
  border:1px solid var(--border);
  background:#fff;
  cursor:pointer;
  font-size:12px;
}

/* ================= CARDS ================= */
.cards{
  position:sticky;
  top:170px;
  z-index:90;
  background:var(--bg);
  padding:10px 18px;
  display:grid;
  grid-template-columns:repeat(8,1fr);
  gap:8px;
}
.card{
  padding:12px;
  border-radius:10px;
  border:1px solid var(--border);
  cursor:pointer;
}
.card span{font-size:11px;color:#475569}
.card h3{margin:6px 0 0;font-size:15px;font-weight:700}

.gate{background:#eef2ff}
.rmp{background:#ecfeff}
.de{background:#f0fdf4}
.peel{background:#fff7ed}
.soak{background:#fdf4ff}
.grade{background:#fefce8}
.prod{background:#fff1f2}
.yield{background:#e0f2fe}

/* ================= SECTIONS ================= */
.section{
  margin:26px 18px;
  background:#fff;
  padding:16px;
  border-radius:12px;
  border:1px solid var(--border)
}
.section h3{
  margin:0 0 10px;
  font-size:17px;
  color:#1f3a5f
}

/* ================= TABLE ================= */
.table-wrap{
  max-height:420px;
  overflow:auto;
}
table{
  width:100%;
  border-collapse:collapse;
  table-layout:fixed;
}
th,td{
  border-bottom:1px solid #edf2f7;
  padding:6px;
  font-size:11px;
  word-wrap:break-word;
}
th{
  background:#f1f5f9;
  position:sticky;
  top:0;
  z-index:2;
}
.subtotal td{
  background:#f8fafc;
  font-weight:600;
}
.grand td{
  background:#e5e7eb;
  font-weight:800;
}
</style>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
</head>

<body>

<!-- ================= HEADER ================= -->
<div class="header">
  <h2>Processing Summary</h2>
  <p>Gate Entry → RMP → De-Heading → Peeling → Soaking → Grading → Production</p>

  <form method="get" id="filterForm">
    <div class="filters">
      <div>
        <label>Batch</label>
        <select name="batch" onchange="submitForm()">
          <option value="">All</option>
          {% for b in batches %}
          <option value="{{ b }}" {% if selected_batch==b %}selected{% endif %}>{{ b }}</option>
          {% endfor %}
        </select>
      </div>
      <div>
        <label>From Date</label>
        <input type="date" name="from_date" value="{{ from_date }}" onchange="submitForm()">
      </div>
      <div>
        <label>To Date</label>
        <input type="date" name="to_date" value="{{ to_date }}" onchange="submitForm()">
      </div>
    </div>
  </form>

  <div class="actions">
    <button onclick="window.print()">Print</button>
    <button onclick="exportPDF()">PDF</button>
    <button onclick="exportExcel()">Excel</button>
  </div>
</div>

<!-- ================= CARDS ================= -->
<div class="cards">
  <div class="card gate" onclick="go('gate')"><span>Batches</span><h3>{{ total_batches }}</h3></div>
  <div class="card rmp" onclick="go('rmp')"><span>RMP Qty</span><h3>{{ total_rmp_qty }}</h3></div>
  <div class="card de" onclick="go('de')"><span>De-Heading</span><h3>{{ total_de_hoso }}</h3></div>
  <div class="card peel" onclick="go('peel')"><span>Peeling</span><h3>{{ total_peeling_qty }}</h3></div>
  <div class="card soak" onclick="go('soak')"><span>Soaking</span><h3>{{ total_soaking_qty }}</h3></div>
  <div class="card grade" onclick="go('grade')"><span>Grading</span><h3>{{ total_grading_qty }}</h3></div>
  <div class="card prod" onclick="go('prod')"><span>Production</span><h3>{{ total_production_qty }}</h3></div>
  <div class="card yield"><span>Yield %</span><h3>{{ overall_yield }}%</h3></div>
</div>

<!-- ================= SAFE TABLE MACRO ================= -->


{% macro render_table(id,title,rows,qty_field) %}
<div class="section" id="{{ id }}">
<h3>{{ title }}</h3>

{% if rows|length == 0 %}
<p style="font-size:12px;color:#6b7280">No data available</p>
{% else %}

{# ---- GET COLUMNS SAFELY ---- #}
{% set all_cols = rows[0].__table__.columns %}
{% set ns_cols = namespace(cols=[]) %}
{% for c in all_cols %}
  {% if c.name != 'company_id' %}
    {% set _ = ns_cols.cols.append(c) %}
  {% endif %}
{% endfor %}
{% set cols = ns_cols.cols %}
{% set col_count = cols|length %}

<div class="table-wrap">
<table>
<thead>
<tr>
{% for c in cols %}
<th>{{ c.name.replace('_',' ').title() }}</th>
{% endfor %}
</tr>
</thead>
<tbody>

{% set ns = namespace(pd=None,pv=None,ds=0,vs=0,gs=0) %}

{% for r in rows %}
{% set d = r.date %}
{% set v = r.variety_name if 'variety_name' in r.__dict__ and r.variety_name else 'N/A' %}
{% set q = r.__dict__.get(qty_field,0) or 0 %}

{# ---- VARIETY SUBTOTAL ---- #}
{% if ns.pv and ns.pv != v %}
<tr class="subtotal">
  <td colspan="{{ col_count }}">Variety Total ({{ ns.pv }}): {{ ns.vs }}</td>
</tr>
{% set ns.vs = 0 %}
{% endif %}

{# ---- DATE SUBTOTAL ---- #}
{% if ns.pd and ns.pd != d %}
<tr class="subtotal">
  <td colspan="{{ col_count }}">Date Total ({{ ns.pd }}): {{ ns.ds }}</td>
</tr>
{% set ns.ds = 0 %}
{% endif %}

<tr>
{% for c in cols %}
<td>{{ r.__dict__[c.name] }}</td>
{% endfor %}
</tr>

{% set ns.ds = ns.ds + q %}
{% set ns.vs = ns.vs + q %}
{% set ns.gs = ns.gs + q %}
{% set ns.pd = d %}
{% set ns.pv = v %}

{% endfor %}

<tr class="subtotal">
  <td colspan="{{ col_count }}">Variety Total ({{ ns.pv }}): {{ ns.vs }}</td>
</tr>
<tr class="subtotal">
  <td colspan="{{ col_count }}">Date Total ({{ ns.pd }}): {{ ns.ds }}</td>
</tr>
<tr class="grand">
  <td colspan="{{ col_count }}">GRAND TOTAL: {{ ns.gs }}</td>
</tr>

</tbody>
</table>
</div>

{% endif %}
</div>
{% endmacro %}


{{ render_table('gate','Gate Entry',gate_rows,'no_of_material_boxes') }}
{{ render_table('rmp','Raw Material Purchasing',rmp_rows,'received_qty') }}
{{ render_table('de','De-Heading',de_rows,'hoso_qty') }}
{{ render_table('peel','Peeling',peeling_rows,'peeled_qty') }}
{{ render_table('soak','Soaking',soaking_rows,'in_qty') }}
{{ render_table('grade','Grading',grading_rows,'quantity') }}
{{ render_table('prod','Production',production_rows,'production_qty') }}

<script>
function go(id){
  const y = document.getElementById(id).getBoundingClientRect().top + window.pageYOffset - 230;
  window.scrollTo({top:y,behavior:"smooth"});
}
function submitForm(){document.getElementById("filterForm").submit();}
function exportPDF(){
  html2pdf().set({
    filename:'Processing_Summary.pdf',
    html2canvas:{scale:2},
    jsPDF:{unit:'in',format:'a4',orientation:'portrait'}
  }).from(document.body).save();
}
function exportExcel(){
  let html = document.body.outerHTML;
  let a = document.createElement('a');
  a.href = 'data:application/vnd.ms-excel,' + encodeURIComponent(html);
  a.download = 'Processing_Summary.xls';
  a.click();
}
</script>

</body>
</html>
