<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>PRODUCTION TYPES MASTER | BKNR SOLUTIONS</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
  :root {
    --primary: #143465;
    --accent: #3b82f6;
    --border: #d1d5db;
    --bg: #f3f4f6;
    --text: #1f2937;
    --muted: #6b7280;
  }

  * { box-sizing: border-box; font-family: 'Inter', Segoe UI, sans-serif; }
  body { margin: 0; background: var(--bg); color: var(--text); overflow-x: hidden; }

  h2 {
    background: #fff; margin: 0; padding: 15px;
    text-align: center; color: var(--primary);
    font-size: 18px; font-weight: 800; text-transform: uppercase;
    border-bottom: 1px solid var(--border);
    letter-spacing: 1px;
  }

  /* ================= FORM CONTAINER ================= */
  .form-container {
    width: 90%; max-width: 1100px; margin: 25px auto;
    background: #fff; padding: 30px; border-radius: 12px;
    border: 1px solid var(--border);
    box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05);
  }

  .row { display: flex; flex-wrap: wrap; justify-content: center; gap: 20px; margin-bottom: 15px; }
  .col { flex: 1; min-width: 260px; display: flex; flex-direction: column; }

  label {
    font-size: 11px; font-weight: 700; color: var(--primary);
    text-transform: uppercase; margin-bottom: 6px;
    letter-spacing: 0.5px;
  }

  select, input {
    padding: 10px 14px; border: 1px solid var(--border);
    border-radius: 8px; font-size: 14px; background: #fff;
    transition: all 0.2s; outline: none; height: 42px;
  }
  
  select:focus, input:focus { 
    border-color: var(--accent); 
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1); 
  }

  /* ================= ACTIONS & BUTTONS ================= */
  .actions { text-align: center; margin-top: 25px; display: flex; justify-content: center; gap: 12px; }
  
  .btn {
    background: var(--primary); color: white; border: none;
    padding: 12px 30px; border-radius: 8px; font-size: 13px;
    font-weight: 700; cursor: pointer; transition: 0.2s;
    text-transform: uppercase; min-width: 150px;
  }
  
  .btn-clear { background: #f1f5f9; color: var(--muted); }
  
  .btn:hover { 
    background: var(--accent); 
    color: #fff; 
    transform: translateY(-1px);
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
  }

  /* ================= TABLE AREA ================= */
  table {
    width: 90%; max-width: 1100px; margin: 25px auto 40px;
    border-collapse: collapse; background: #fff;
    border-radius: 10px; overflow: hidden;
    border: 1px solid var(--border);
    box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05);
  }

  th {
    background: #f1f5f9; color: #475569; padding: 12px;
    font-size: 11px; text-transform: uppercase;
    border-bottom: 2px solid var(--border);
    text-align: left;
  }

  td {
    padding: 12px; border-bottom: 1px solid #f1f5f9;
    font-size: 13px; color: var(--text);
  }

  tr:hover { background: #f8fbff; cursor: pointer; }
  tr.selected { background: #eff6ff !important; border-left: 5px solid var(--accent); }

  /* ================= 3 DOTS MENU ================= */
  #menuWrap {
    display: none; width: 90%; max-width: 1100px;
    margin: 10px auto; text-align: right; position: relative;
  }

  #dotsBtn {
    background: var(--primary); color: white; border: none;
    padding: 6px 14px; font-size: 20px;
    border-radius: 6px; cursor: pointer; transition: 0.2s;
  }

  #dropdownMenu {
    display: none; position: absolute; right: 0; top: 40px;
    background: white; border: 1px solid var(--border);
    width: 180px; border-radius: 8px; z-index: 1000;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15); overflow: hidden;
  }

  .menu-item {
    padding: 12px 15px; font-size: 13px; font-weight: 600;
    color: var(--primary); border-bottom: 1px solid #f1f5f9;
    cursor: pointer; transition: 0.2s; text-align: left;
  }
  .menu-item:last-child { border-bottom: none; }
  .menu-item:hover { background: #f0f7ff; color: var(--accent); }

  @media(max-width: 768px){
    .form-container, table { width: 95%; }
    .col { min-width: 100%; }
    .actions { flex-direction: column; }
    .btn { width: 100%; }
  }
</style>
</head>

<body>

<h2>PRODUCTION TYPES MASTER</h2>

<form onsubmit="saveRecord(event)">
  <div class="form-container">

    <div class="row">

      <div class="col">
        <label>Production Type</label>
        <input type="text" id="production_type" required>
      </div>

      <div class="col">
        <label>Glaze Name</label>
        <select id="glaze_name" required>
          <option value="" disabled selected>Select Glaze</option>

          {% for g in lookup.glazes %}
            <option value="{{ g }}">{{ g }}</option>
          {% endfor %}

        </select>
      </div>

      <div class="col">
        <label>Freezer Name</label>
        <select id="freezer_name" required>
          <option value="" disabled selected>Select Freezer</option>

          {% for f in lookup.freezers %}
            <option value="{{ f }}">{{ f }}</option>
          {% endfor %}

        </select>
      </div>

    </div>

    <div class="row">
      <div class="col">
        <label>Production Charge (Per Kg)</label>
        <input type="number" step="0.01" id="production_charge_per_kg" required>
      </div>
    </div>

    <!-- Hidden -->
    <input type="hidden" id="record_id">
    <input type="hidden" id="meta_date">
    <input type="hidden" id="meta_time">

    <div class="actions">
      <button class="btn" type="submit">SAVE</button>
      <button class="btn btn-clear" type="button" onclick="clearForm()">CLEAR</button>
    </div>

  </div>
</form>

{% if today_data %}
<div id="menuWrap">
  <button id="dotsBtn">‚ãÆ</button>

  <div id="dropdownMenu">
    <div class="menu-item" onclick="editSelected()">‚úèÔ∏è Edit</div>
    <div class="menu-item" onclick="deleteSelected()">üóëÔ∏è Delete</div>
  </div>
</div>

<table id="dataTable">
  <thead>
    <tr>
      <th>ID</th>
      <th>Production Type</th>
      <th>Glaze</th>
      <th>Freezer</th>
      <th>Charge / Kg</th>
      <th>Date</th>
      <th>Time</th>
      <th>Email</th>
      <th>Company ID</th>
    </tr>
  </thead>

  <tbody>
    {% for row in today_data %}
    <tr
      data-id="{{ row.id }}"
      data-production_type="{{ row.production_type }}"
      data-glaze="{{ row.glaze_name }}"
      data-freezer="{{ row.freezer_name }}"
      data-charge="{{ row.production_charge_per_kg }}"
    >
      <td>{{ row.id }}</td>
      <td>{{ row.production_type }}</td>
      <td>{{ row.glaze_name }}</td>
      <td>{{ row.freezer_name }}</td>
      <td>{{ row.production_charge_per_kg }}</td>
      <td>{{ row.date }}</td>
      <td>{{ row.time }}</td>
      <td>{{ row.email }}</td>
      <td>{{ row.company_id }}</td>
    </tr>
    {% endfor %}
  </tbody>

</table>
{% endif %}

<script>
let selectedRow = null;

document.addEventListener("DOMContentLoaded", () => {

  // Auto timestamp
  const now = new Date();
  meta_date.value = now.toISOString().slice(0,10);
  meta_time.value = now.toTimeString().slice(0,8);

  const rows = document.querySelectorAll("#dataTable tbody tr");
  const menu = document.getElementById("menuWrap");

  rows.forEach(r => {
    r.onclick = function () {
      rows.forEach(x => x.classList.remove("selected"));
      r.classList.add("selected");
      selectedRow = r;
      menu.style.display = "block";
    };
  });

  dotsBtn.onclick = () => {
    dropdownMenu.style.display =
      dropdownMenu.style.display === "block" ? "none" : "block";
  };
});

/* SAVE */
async function saveRecord(e) {
  e.preventDefault();

  const fd = new FormData();

  if (record_id.value) fd.append("id", record_id.value);

  fd.append("production_type", production_type.value);
  fd.append("glaze_name", glaze_name.value);
  fd.append("freezer_name", freezer_name.value);
  fd.append("production_charge_per_kg", production_charge_per_kg.value);

  fd.append("date", meta_date.value);
  fd.append("time", meta_time.value);

  const res = await fetch("/criteria/production_types", {
    method: "POST",
    body: fd
  });

  if (res.ok) location.reload();
  else alert("Save Failed!");
}

/* EDIT */
function editSelected() {
  record_id.value = selectedRow.dataset.id;
  production_type.value = selectedRow.dataset.production_type;
  glaze_name.value = selectedRow.dataset.glaze;
  freezer_name.value = selectedRow.dataset.freezer;
  production_charge_per_kg.value = selectedRow.dataset.charge;

  window.scrollTo({ top:0, behavior:'smooth' });
}

/* DELETE */
async function deleteSelected() {
  if (!confirm("Delete this record?")) return;

  const id = selectedRow.dataset.id;

  const res = await fetch(`/criteria/production_types/delete/${id}`, {
    method: "POST"
  });

  if (res.ok) location.reload();
  else alert("Delete Failed");
}

/* CLEAR */
function clearForm() {
  record_id.value = "";
  production_type.value = "";
  glaze_name.value = "";
  freezer_name.value = "";
  production_charge_per_kg.value = "";

  document.querySelectorAll("tr.selected").forEach(r => r.classList.remove("selected"));
  menuWrap.style.display = "none";
}
</script>

</body>
</html>
