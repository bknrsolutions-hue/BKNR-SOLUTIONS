<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>COUNTRIES MASTER | BKNR SOLUTIONS</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
  :root{
    --primary: #143465;
    --accent: #3b82f6;
    --border: #d1d5db;
    --bg: #f3f4f6;
    --text: #1f2937;
    --muted: #6b7280;
  }

  *{ box-sizing: border-box; font-family: 'Inter', Segoe UI, sans-serif; }
  body{ margin: 0; background: var(--bg); color: var(--text); overflow-x: hidden; }

  h2 {
    background: #fff; margin: 0; padding: 15px;
    text-align: center; color: var(--primary);
    font-size: 18px; font-weight: 800; text-transform: uppercase;
    border-bottom: 1px solid var(--border);
    letter-spacing: 1px;
  }

  /* ================= FORM CONTAINER ================= */
  .form-container {
    width: 90%; max-width: 1100px; margin: 25px auto;
    background: #fff; padding: 30px; border-radius: 12px;
    border: 1px solid var(--border);
    box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05);
  }

  .row { display: flex; flex-wrap: wrap; justify-content: center; gap: 20px; margin-bottom: 15px; }
  .col { flex: 1; min-width: 280px; display: flex; flex-direction: column; }

  label {
    font-size: 11px; font-weight: 700; color: var(--primary);
    text-transform: uppercase; margin-bottom: 6px;
  }

  input {
    padding: 10px 14px; border: 1px solid var(--border);
    border-radius: 8px; font-size: 14px; background: #fff;
    transition: all 0.2s; outline: none;
  }
  input:focus { 
    border-color: var(--accent); 
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1); 
  }

  /* ================= ACTIONS & BUTTONS ================= */
  .actions { text-align: center; margin-top: 25px; display: flex; justify-content: center; gap: 12px; }
  .btn {
    background: var(--primary); color: white; border: none;
    padding: 12px 30px; border-radius: 8px; font-size: 13px;
    font-weight: 700; cursor: pointer; transition: 0.2s;
    text-transform: uppercase; min-width: 140px;
  }
  .btn-clear { background: #f1f5f9; color: var(--muted); }
  .btn:hover { background: var(--accent); color: #fff; transform: translateY(-1px); }

  /* ================= TABLE AREA ================= */
  table {
    width: 90%; max-width: 1100px; margin: 10px auto 40px;
    border-collapse: collapse; background: #fff;
    border-radius: 10px; overflow: hidden;
    border: 1px solid var(--border); box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05);
  }

  th {
    background: #f1f5f9; color: #475569; padding: 12px;
    font-size: 11px; text-transform: uppercase; border-bottom: 2px solid var(--border);
    text-align: left;
  }

  td { padding: 12px; border-bottom: 1px solid #f1f5f9; font-size: 13px; color: var(--text); }
  tr:hover { background: #f8fbff; cursor: pointer; }
  tr.selected { background: #eff6ff !important; border-left: 5px solid var(--accent); }

  /* Action Menu Styling */
  .menu-item {
    padding: 12px 15px; font-size: 13px; font-weight: 600;
    border-bottom: 1px solid #f1f5f9; cursor: pointer; color: var(--primary);
    transition: 0.2s; text-align: left;
  }
  .menu-item:hover { background: #f0f7ff; color: var(--accent); }

  @media(max-width: 768px){
    .form-container, table { width: 95%; }
    .col { min-width: 100%; }
    .actions { flex-direction: column; }
    .btn { width: 100%; }
  }
</style>
</head>

<body>

<h2>COUNTRIES MASTER</h2>

<form onsubmit="submitCountry(event)">
  <div class="form-container">
    <div class="row">
      <div class="col">
        <label>Country Name</label>
        <input type="text" id="country_name" required placeholder="Enter Country Name">
      </div>

      <div class="col">
        <label>Production Cost (‚Çπ/Kg)</label>
        <input type="number" id="production_cost_per_kg" step="0.01" placeholder="0.00">
      </div>
    </div>

    <input type="hidden" id="record_id">
    <input type="hidden" id="meta_email" value="{{ email }}">
    <input type="hidden" id="meta_company_id" value="{{ company_id }}">

    <div class="actions">
      <button class="btn" type="submit">SAVE</button>
      <button class="btn btn-clear" type="reset" onclick="clearForm()">CLEAR</button>
    </div>
  </div>
</form>

{% if today_data %}

<div id="threeDotsMenu" style="display:none;width:90%;max-width:1100px;margin:10px auto;text-align:right;position:relative;">
  <button id="dotsBtn" style="background:var(--primary);color:white;border:none;padding:6px 12px;border-radius:6px;cursor:pointer;font-weight:600;font-size:20px;">‚ãÆ</button>

  <div id="dropdownMenu" style="display:none;position:absolute;right:0;background:white;border:1px solid #ccc;border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,0.15);width:200px;z-index:1000;">
    <div onclick="editSelected()" class="menu-item">‚úèÔ∏è Edit</div>
    <div onclick="deleteSelected()" class="menu-item" style="color:red;">üóëÔ∏è Delete</div>
    <div onclick="printSelected()" class="menu-item">üñ®Ô∏è Print</div>
    <div onclick="exportPDF()" class="menu-item">üìÑ Export PDF</div>
    <div onclick="exportExcel()" class="menu-item">üìä Export Excel</div>
  </div>
</div>

<table id="dataTable">
  <thead>
    <tr>
      <th>ID</th>
      <th>Country Name</th>
      <th>Production Cost (‚Çπ/Kg)</th>
      <th>Date</th>
      <th>Time</th>
      <th>Email</th>
      <th>Company ID</th>
    </tr>
  </thead>
  <tbody>
    {% for row in today_data %}
    <tr 
      data-id="{{ row.id }}"
      data-name="{{ row.country_name }}"
      data-cost="{{ row.production_cost_per_kg }}"
    >
      <td>{{ row.id }}</td>
      <td style="font-weight:600; color:var(--primary);">{{ row.country_name }}</td>
      <td>‚Çπ {{ row.production_cost_per_kg }}</td>
      <td>{{ row.date }}</td>
      <td>{{ row.time }}</td>
      <td style="font-size:11px; color:var(--muted);">{{ row.email }}</td>
      <td>{{ row.company_id }}</td>
    </tr>
    {% endfor %}
  </tbody>
</table>

{% endif %}

<script>
let selectedRow=null;

/* ------------------- SAVE / UPDATE ------------------- */
async function submitCountry(e){
  e.preventDefault();
  const name=document.getElementById("country_name").value.trim();
  const cost=document.getElementById("production_cost_per_kg").value;
  const record_id=document.getElementById("record_id").value;

  const now=new Date();
  const date=now.toISOString().slice(0,10);
  const time=now.toTimeString().slice(0,8);
  const email=document.getElementById("meta_email").value;
  const company_id=document.getElementById("meta_company_id").value;

  const fd=new FormData();
  if(record_id) fd.append("id",record_id);
  fd.append("country_name",name);
  fd.append("production_cost_per_kg",cost);
  fd.append("date",date);
  fd.append("time",time);
  fd.append("email",email);
  fd.append("company_id",company_id);

  const res=await fetch("/criteria/countries",{method:"POST",body:fd});
  if(res.ok){ alert("Saved Successfully!"); location.reload(); }
  else alert("Save Failed!");
}

/* ------------------- SELECT ROW ------------------- */
document.addEventListener("DOMContentLoaded",()=>{
  const rows=document.querySelectorAll("#dataTable tbody tr");
  const menu=document.getElementById("threeDotsMenu");
  const dotsBtn=document.getElementById("dotsBtn");
  const dropdownMenu=document.getElementById("dropdownMenu");

  rows.forEach(row=>{
    row.addEventListener("click",()=>{
      rows.forEach(r=>r.classList.remove("selected"));
      row.classList.add("selected");
      selectedRow=row;
      menu.style.display="block";
    });
  });

  dotsBtn.onclick=(e)=>{
    e.stopPropagation();
    dropdownMenu.style.display=(dropdownMenu.style.display==="block")?"none":"block";
  };
  
  document.onclick=()=>{ dropdownMenu.style.display="none"; };
});

/* ------------------- EDIT ------------------- */
function editSelected(){
  if(!selectedRow) return;
  document.getElementById("record_id").value=selectedRow.dataset.id;
  document.getElementById("country_name").value=selectedRow.dataset.name;
  document.getElementById("production_cost_per_kg").value=selectedRow.dataset.cost;
  window.scrollTo({top:0,behavior:"smooth"});
}

/* ------------------- DELETE ------------------- */
async function deleteSelected(){
  if(!selectedRow || !confirm("Are you sure?")) return;
  const id=selectedRow.dataset.id;
  const res=await fetch(`/criteria/countries/delete/${id}`,{method:"POST"});
  if(res.ok) location.reload();
  else alert("Delete Failed");
}

/* ------------------- EXPORTS ------------------- */
function printSelected(){
  if(!selectedRow) return;
  const p=window.open("","_blank");
  p.document.write("<h3>Country Details</h3><hr>");
  p.document.write("<p><b>Name:</b> "+selectedRow.dataset.name+"</p>");
  p.document.write("<p><b>Cost:</b> ‚Çπ "+selectedRow.dataset.cost+"</p>");
  p.document.close();
  p.print();
}
function exportPDF(){ printSelected(); }
function exportExcel(){
  if(!selectedRow) return;
  const name=selectedRow.dataset.name;
  const cost=selectedRow.dataset.cost;
  const data=`Country\tCost\n${name}\t${cost}`;
  const blob=new Blob([data],{type:"application/vnd.ms-excel"});
  const url=URL.createObjectURL(blob);
  const a=document.createElement("a");
  a.href=url;
  a.download="country_"+name+".xls";
  a.click();
}

/* ------------------- CLEAR ------------------- */
function clearForm(){
  selectedRow=null;
  document.getElementById("record_id").value="";
  document.getElementById("country_name").value="";
  document.getElementById("production_cost_per_kg").value="";
  document.querySelectorAll("tr.selected").forEach(r=>r.classList.remove("selected"));
  document.getElementById("threeDotsMenu").style.display="none";
}
</script>
</body>
</html>