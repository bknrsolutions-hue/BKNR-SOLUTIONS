<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>CONTRACTORS MASTER ‚Äì BKNR ERP</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
:root{
  --primary: #143465;
  --accent: #3b82f6;
  --border: #d1d5db;
  --bg: #f3f4f6;
  --text: #1f2937;
  --muted: #6b7280;
}
*{ box-sizing: border-box; font-family: 'Inter', Segoe UI, sans-serif; }
body{ margin: 0; background: var(--bg); color: var(--text); overflow-x: hidden; }

/* ================= HEADER ================= */
h2 {
  background: #fff; margin: 0; padding: 15px;
  text-align: center; color: var(--primary);
  font-size: 18px; font-weight: 800; text-transform: uppercase;
  border-bottom: 1px solid var(--border);
  letter-spacing: 1px;
}

/* ================= FORM CONTAINER ================= */
.form-container{
  width: 98%; max-width: 1400px; margin: 20px auto;
  background: #fff; padding: 25px; border-radius: 12px;
  border: 1px solid var(--border);
  box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05);
}

.grid{
  display: grid;
  grid-template-columns: repeat(6, 1fr);
  gap: 15px;
}

.field{ display: flex; flex-direction: column; }

label{
  font-size: 11px; font-weight: 700; color: var(--primary);
  text-transform: uppercase; margin-bottom: 6px;
}

input, select, textarea{
  padding: 10px; border: 1px solid var(--border);
  border-radius: 8px; font-size: 13px; background: #fff;
  transition: all 0.2s; outline: none;
}
input:focus, select:focus, textarea:focus {
  border-color: var(--accent);
  box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
}
textarea{ resize: none; height: 38px; }

/* ================= ACTIONS ================= */
.actions{
  grid-column: span 6;
  text-align: center;
  margin-top: 20px;
  padding-top: 15px;
  border-top: 1px solid #f1f5f9;
}
.btn{
  background: var(--primary); color: #fff; border: none;
  padding: 12px 25px; border-radius: 8px; font-size: 13px;
  font-weight: 700; cursor: pointer; transition: 0.2s;
  text-transform: uppercase; width: 160px; margin: 0 5px;
}
.btn-clear{ background: #f1f5f9; color: var(--muted); }
.btn:hover{ background: var(--accent); color: #fff; transform: translateY(-1px); }

/* ================= 3 DOT MENU ================= */
.menu-wrap{
  width: 98%; max-width: 1400px; margin: 10px auto;
  text-align: right; position: relative;
  display: none; /* Hidden until a row is selected */
}
.menu-btn{
  background: var(--primary); color: #fff; border: none;
  width: 38px; height: 38px; border-radius: 8px;
  cursor: pointer; font-size: 20px; transition: 0.2s;
}
.menu{
  position: absolute; right: 0; top: 45px;
  background: #fff; border: 1px solid var(--border);
  border-radius: 10px; width: 180px; z-index: 1000;
  box-shadow: 0 10px 25px rgba(0,0,0,0.1); overflow: hidden;
  display: none;
}
.menu div{
  padding: 12px 15px; font-size: 12px; font-weight: 600;
  color: var(--primary); border-bottom: 1px solid #f1f5f9;
  cursor: pointer; text-align: left;
}
.menu div:hover{ background: #f0f7ff; color: var(--accent); }

/* ================= TABLE ================= */
.table-wrap { width: 98%; max-width: 1400px; margin: 0 auto 40px; overflow-x: auto; }
table{
  width: 100%; border-collapse: collapse; background: #fff;
  border-radius: 10px; overflow: hidden;
  border: 1px solid var(--border);
  box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05);
}
th, td{ padding: 12px 10px; font-size: 12px; border-bottom: 1px solid #f1f5f9; text-align: center; white-space: nowrap; }
th{ background: #f1f5f9; color: #475569; font-weight: 700; text-transform: uppercase; font-size: 10px; }
tr:hover{ background: #f8fbff; cursor: pointer; }
tr.selected{ background: #eff6ff !important; border-left: 5px solid var(--accent); }

/* ================= RESPONSIVE ================= */
@media(max-width: 1100px){
  .grid{ grid-template-columns: repeat(3, 1fr); }
  .actions{ grid-column: span 3; }
}
@media(max-width: 600px){
  .grid{ grid-template-columns: 1fr; }
  .actions{ grid-column: span 1; }
  .btn { width: 100%; margin: 5px 0; }
}
</style>
</head>

<body>

<h2>CONTRACTORS MASTER</h2>

<form onsubmit="submitContractor(event)" id="contractorForm">
<div class="form-container">
<div class="grid">

<div class="field"><label>Contractor Name</label><input id="contractor_name" required placeholder="Enter Name"></div>
<div class="field"><label>Phone Number</label><input id="phone" placeholder="98480xxxxx"></div>
<div class="field"><label>Email Address</label><input type="email" id="contractor_email" placeholder="example@mail.com"></div>
<div class="field"><label>GST No</label><input id="gst_number" placeholder="GSTIN12345"></div>
<div class="field"><label>GST %</label><input type="number" step="0.01" id="gst_percent" placeholder="18"></div>
<div class="field"><label>GST Applicable From</label><input type="date" id="gst_applicable_from"></div>

<div class="field"><label>Bank Name</label><input id="bank_name" placeholder="SBI / HDFC"></div>
<div class="field"><label>Account No</label><input id="account_no" placeholder="1234567890"></div>
<div class="field"><label>IFSC Code</label><input id="ifsc" placeholder="SBIN000123"></div>

<div class="field" style="grid-column:span 3">
  <label>Office Address</label><textarea id="address" placeholder="Full Address..."></textarea>
</div>

<input type="hidden" id="record_id">
<input type="hidden" id="date">
<input type="hidden" id="time">

<div class="actions">
  <button type="submit" class="btn">SAVE</button>
  <button type="reset" class="btn btn-clear" onclick="clearForm()">CLEAR</button>
</div>

</div>
</div>
</form>

<div class="menu-wrap" id="menuWrap">
  <button class="menu-btn" onclick="toggleMenu(event)">‚ãÆ</button>
  <div class="menu" id="menu">
    <div onclick="editRow()">‚úèÔ∏è Edit Contractor</div>
    <div onclick="deleteRow()">üóëÔ∏è Delete Record</div>
    <div onclick="printRow()">üñ®Ô∏è Print Details</div>
  </div>
</div>

<div class="table-wrap">
{% if today_data %}
<table id="dataTable">
<thead>
<tr>
<th>ID</th><th>Name</th><th>Phone</th><th>Email</th>
<th>GST No</th><th>GST %</th><th>GST From</th>
<th>Bank Name</th><th>Account No</th><th>IFSC</th><th>Address</th>
</tr>
</thead>
<tbody>
{% for r in today_data %}
<tr onclick="selectRow(this)"
 data-id="{{r.id}}"
 data-name="{{r.contractor_name}}"
 data-phone="{{r.phone}}"
 data-email="{{r.contractor_email}}"
 data-gst="{{r.gst_number}}"
 data-gstp="{{r.gst_percent}}"
 data-gstfrom="{{r.gst_applicable_from}}"
 data-bank="{{r.bank_name}}"
 data-acc="{{r.account_no}}"
 data-ifsc="{{r.ifsc}}"
 data-addr="{{r.address}}">
<td>{{r.id}}</td>
<td>{{r.contractor_name}}</td>
<td>{{r.phone}}</td>
<td>{{r.contractor_email}}</td>
<td>{{r.gst_number}}</td>
<td>{{r.gst_percent}}</td>
<td>{{r.gst_applicable_from}}</td>
<td>{{r.bank_name}}</td>
<td>{{r.account_no}}</td>
<td>{{r.ifsc}}</td>
<td>{{r.address}}</td>
</tr>
{% endfor %}
</tbody>
</table>
{% else %}
<p style="text-align:center; color:var(--muted); font-size:13px;">No contractors found.</p>
{% endif %}
</div>

<script>
let selectedRowElement = null;

/* SET CURRENT DATE & TIME */
function setDateTime(){
 let d = new Date();
 document.getElementById('date').value = d.toISOString().slice(0,10);
 document.getElementById('time').value = d.toTimeString().slice(0,8);
}

/* SUBMIT FORM */
async function submitContractor(e){
 e.preventDefault(); 
 setDateTime();
 
 const fd = new FormData();
 const fields = [
   "contractor_name","phone","contractor_email","gst_number","gst_percent",
   "gst_applicable_from","bank_name","account_no","ifsc","address","date","time"
 ];
 
 fields.forEach(id => {
   fd.append(id, document.getElementById(id).value);
 });
 
 const recId = document.getElementById('record_id').value;
 if(recId) fd.append("id", recId);

 try {
   const response = await fetch("/criteria/contractors", { method: "POST", body: fd });
   if(response.ok){
     alert("Data Saved Successfully!");
     location.reload();
   } else {
     alert("Failed to save data.");
   }
 } catch (err) {
   console.error(err);
   alert("Server Error!");
 }
}

/* ROW SELECTION */
function selectRow(row){
 document.querySelectorAll("#dataTable tr").forEach(x => x.classList.remove("selected"));
 row.classList.add("selected"); 
 selectedRowElement = row;
 
 document.getElementById('menuWrap').style.display = "block";
 // Close menu if it was open
 document.getElementById('menu').style.display = "none";
}

/* TOGGLE 3-DOT MENU */
function toggleMenu(e){
 e.stopPropagation();
 const menu = document.getElementById('menu');
 menu.style.display = menu.style.display === "block" ? "none" : "block";
}

/* EDIT FUNCTION */
function editRow(){
 if(!selectedRowElement) return;
 
 const d = selectedRowElement.dataset;
 document.getElementById('record_id').value = d.id;
 document.getElementById('contractor_name').value = d.name;
 document.getElementById('phone').value = d.phone;
 document.getElementById('contractor_email').value = d.email;
 document.getElementById('gst_number').value = d.gst;
 document.getElementById('gst_percent').value = d.gstp;
 document.getElementById('gst_applicable_from').value = d.gstfrom;
 document.getElementById('bank_name').value = d.bank;
 document.getElementById('account_no').value = d.acc;
 document.getElementById('ifsc').value = d.ifsc;
 document.getElementById('address').value = d.addr;
 
 window.scrollTo({ top: 0, behavior: "smooth" });
 document.getElementById('menu').style.display = "none";
}

/* DELETE FUNCTION */
async function deleteRow(){
 if(!selectedRowElement) return;
 if(!confirm("Are you sure you want to delete this contractor?")) return;
 
 const id = selectedRowElement.dataset.id;
 try {
   const response = await fetch(`/criteria/contractors/delete/${id}`, { method: "POST" });
   if(response.ok) location.reload(); 
   else alert("Delete failed!");
 } catch (err) {
   alert("Error deleting record.");
 }
}

/* PRINT FUNCTION */
function printRow(){
 if(!selectedRowElement) return;
 const d = selectedRowElement.dataset;
 const win = window.open("", "_blank");
 win.document.write(`
   <html>
   <head><title>Contractor Details</title></head>
   <body style="font-family:sans-serif; padding:20px;">
     <h2>Contractor Profile</h2>
     <hr>
     <p><b>Name:</b> ${d.name}</p>
     <p><b>Phone:</b> ${d.phone}</p>
     <p><b>Email:</b> ${d.email}</p>
     <p><b>GST No:</b> ${d.gst} (${d.gstp}%)</p>
     <p><b>Bank:</b> ${d.bank} | <b>Acc:</b> ${d.acc} | <b>IFSC:</b> ${d.ifsc}</p>
     <p><b>Address:</b> ${d.addr}</p>
   </body>
   </html>
 `);
 win.document.close();
 win.print();
}

/* CLEAR FORM */
function clearForm(){
 selectedRowElement = null;
 document.getElementById('record_id').value = "";
 document.getElementById('menuWrap').style.display = "none";
 document.querySelectorAll("#dataTable tr").forEach(x => x.classList.remove("selected"));
}

/* CLOSE MENU ON CLICK OUTSIDE */
window.onclick = function(event) {
 if (!event.target.matches('.menu-btn')) {
   document.getElementById('menu').style.display = "none";
 }
}
</script>

</body>
</html>