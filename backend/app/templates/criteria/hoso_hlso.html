<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>HOSO ‚Üí HLSO YIELDS MASTER | BKNR SOLUTIONS</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
  body{font-family:Arial,sans-serif;background:#e6f2ff;margin:0;padding:0;}
  h2{text-align:center;color:#003366;margin:20px 0;font-weight:700;}

  .form-container{
    width:90%;max-width:1100px;margin:0 auto;background:#fff;
    padding:25px;border-radius:10px;
    box-shadow:0 0 8px rgba(0,0,0,0.15);
  }

  .row{display:flex;flex-wrap:wrap;justify-content:space-between;margin-bottom:18px;}
  .col{width:32%;min-width:260px;display:flex;flex-direction:column;margin-bottom:10px;}

  label{font-weight:600;color:#003366;margin-bottom:6px;}
  select,input{
    padding:10px;border:1px solid #a3bcd6;border-radius:6px;
    background:#f9fcff;font-size:14px;
  }
  select:focus,input:focus{
    border-color:#003366;outline:none;box-shadow:0 0 6px rgba(0,51,102,0.25);
  }

  .actions{text-align:center;margin-top:25px;}
  .btn{
    background:#003366;color:white;border:none;
    padding:10px 20px;border-radius:6px;
    width:150px;font-weight:600;cursor:pointer;
  }
  .btn-clear{background:#777;}
  .btn:hover{opacity:0.9;}

  table{
    width:90%;max-width:1100px;margin:25px auto;
    border-collapse:collapse;background:white;
    border-radius:8px;overflow:hidden;
    box-shadow:0 0 8px rgba(0,0,0,0.1);
  }
  th,td{padding:10px 12px;border-bottom:1px solid #ccc;font-size:14px;}
  th{background:#003366;color:white;}
  tr:hover{background:#eef5ff;cursor:pointer;}
  tr.selected{background:#cce5ff!important;}

  #menuWrap{
    display:none;width:90%;max-width:1100px;margin:10px auto;text-align:right;position:relative;
  }
  #dotsBtn{
    background:#003366;color:white;border:none;padding:6px 12px;
    font-size:22px;border-radius:6px;cursor:pointer;font-weight:600;
  }
  #dropdownMenu{
    display:none;position:absolute;right:0;background:white;
    border:1px solid #ccc;width:180px;border-radius:8px;
    box-shadow:0 3px 8px rgba(0,0,0,0.25);
  }
  .menu-item{
    padding:10px;font-size:14px;font-weight:600;color:#003366;
    border-bottom:1px solid #eee;cursor:pointer;
  }
  .menu-item:hover{background:#e6f2ff;}
</style>
</head>

<body>

<h2>HOSO ‚Üí HLSO YIELDS MASTER</h2>

<form onsubmit="saveRecord(event)">
<div class="form-container">

<div class="row">
  <div class="col">
    <label>Species</label>
    <select id="species" required onchange="addNewSpecies(this)">
      <option value="" disabled selected>Select Species</option>
      {% for s in species_list %}
        <option value="{{ s }}">{{ s }}</option>
      {% endfor %}
      <option value="__add__">‚ûï Add New Species</option>
    </select>
  </div>

  <div class="col">
    <label>HOSO Count (Eg: 10 or 10 to 20)</label>
    <input type="text" id="hoso_count" required>
  </div>

  <div class="col">
    <label>HLSO Yield (%)</label>
    <input type="number" id="hlso_yield_pct" step="0.01" required>
  </div>
</div>

<input type="hidden" id="record_id">
<input type="hidden" id="meta_email" value="{{ email }}">
<input type="hidden" id="meta_company_id" value="{{ company_id }}">
<input type="hidden" id="meta_date">
<input type="hidden" id="meta_time">

<div class="actions">
  <button class="btn" type="submit">SAVE</button>
  <button class="btn btn-clear" type="button" onclick="clearForm()">CLEAR</button>
</div>

</div>
</form>

{% if today_data %}
<div id="menuWrap">
  <button id="dotsBtn">‚ãÆ</button>
  <div id="dropdownMenu">
    <div class="menu-item" onclick="editSelected()">‚úèÔ∏è Edit</div>
    <div class="menu-item" onclick="deleteSelected()">üóëÔ∏è Delete</div>
    <div class="menu-item" onclick="printSelected()">üñ®Ô∏è Print</div>
  </div>
</div>

<table id="dataTable">
<thead>
<tr>
  <th>ID</th>
  <th>Species</th>
  <th>HOSO Count</th>
  <th>HLSO Yield (%)</th>
  <th>Date</th>
  <th>Time</th>
</tr>
</thead>
<tbody>
{% for row in today_data %}
<tr data-id="{{ row.id }}"
    data-species="{{ row.species }}"
    data-hoso="{{ row.hoso_count }}"
    data-yield="{{ row.hlso_yield_pct }}">
  <td>{{ row.id }}</td>
  <td>{{ row.species }}</td>
  <td>{{ row.hoso_count }}</td>
  <td>{{ row.hlso_yield_pct }}%</td>
  <td>{{ row.date }}</td>
  <td>{{ row.time }}</td>
</tr>
{% endfor %}
</tbody>
</table>
{% endif %}

<script>
let selectedRow=null;

/* INIT */
document.addEventListener("DOMContentLoaded",()=>{
  const now=new Date();
  meta_date.value=now.toISOString().slice(0,10);
  meta_time.value=now.toTimeString().slice(0,8);

  document.querySelectorAll("#dataTable tbody tr").forEach(r=>{
    r.onclick=()=>{
      document.querySelectorAll("tr").forEach(x=>x.classList.remove("selected"));
      r.classList.add("selected");
      selectedRow=r;
      menuWrap.style.display="block";
    }
  });

  dotsBtn.onclick=()=>{
    dropdownMenu.style.display=
      dropdownMenu.style.display==="block"?"none":"block";
  }
});

/* SPECIES ADD */
function addNewSpecies(sel){
  if(sel.value==="__add__"){
    const v=prompt("Enter New Species");
    if(v){
      const o=document.createElement("option");
      o.value=v;o.textContent=v;
      sel.insertBefore(o,sel.lastElementChild);
      sel.value=v;
    }else sel.value="";
  }
}

/* RANGE PARSER */
function parseRange(v){
  if(v.includes("to")){
    let [s,e]=v.split("to").map(x=>parseInt(x.trim()));
    return Array.from({length:e-s+1},(_,i)=>s+i);
  }
  return [parseInt(v)];
}

/* SAVE (RANGE SUPPORT) */
async function saveRecord(e){
  e.preventDefault();

  const counts=parseRange(hoso_count.value);
  const yieldPct=parseFloat(hlso_yield_pct.value);

  for(let c of counts){
    const fd=new FormData();
    fd.append("species",species.value);
    fd.append("hoso_count",c);
    fd.append("hlso_yield_pct",yieldPct);
    fd.append("date",meta_date.value);
    fd.append("time",meta_time.value);

    await fetch("/criteria/hoso_hlso",{method:"POST",body:fd});
  }
  location.reload();
}

/* EDIT */
function editSelected(){
  if(!selectedRow) return;
  species.value=selectedRow.dataset.species;
  hoso_count.value=selectedRow.dataset.hoso;
  hlso_yield_pct.value=selectedRow.dataset.yield;
  window.scrollTo({top:0,behavior:"smooth"});
}

/* DELETE */
async function deleteSelected(){
  if(!selectedRow) return;
  if(!confirm("Delete this record?")) return;
  await fetch(`/criteria/hoso_hlso/delete/${selectedRow.dataset.id}`,{method:"POST"});
  location.reload();
}

/* PRINT */
function printSelected(){
  if(!selectedRow) return;
  const w=window.open();
  w.document.write(`<h2>HOSO ‚Üí HLSO Yield</h2>
    <p>Species: ${selectedRow.dataset.species}</p>
    <p>HOSO: ${selectedRow.dataset.hoso}</p>
    <p>Yield: ${selectedRow.dataset.yield}%</p>`);
  w.print();
}

/* CLEAR */
function clearForm(){
  selectedRow=null;
  species.value="";
  hoso_count.value="";
  hlso_yield_pct.value="";
  menuWrap.style.display="none";
}
</script>

</body>
</html>
