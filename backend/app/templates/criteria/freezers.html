<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>FREEZERS MASTER</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
  body {font-family:Arial,sans-serif;background:#e6f2ff;margin:0;padding:0;}
  h2 {text-align:center;color:#003366;margin:20px 0;font-weight:700;}

  .form-container {
    width:90%;max-width:1100px;margin:0 auto;background:#fff;
    box-shadow:0 0 8px rgba(0,0,0,0.15);padding:25px;border-radius:10px;
  }

  .row {display:flex;flex-wrap:wrap;justify-content:space-between;margin-bottom:18px;}
  .col {width:32%;display:flex;flex-direction:column;margin-bottom:10px;}

  label {font-weight:600;color:#003366;margin-bottom:6px;}
  input {
    padding:10px;border:1px solid #a3bcd6;border-radius:6px;
    font-size:14px;background:#f9fcff;
  }
  input:focus {
    border-color:#003366;outline:none;
    box-shadow:0 0 5px rgba(0,51,102,0.3);
  }

  .actions{text-align:center;margin-top:25px;}
  .btn{
    background:#003366;color:white;border:none;
    padding:10px 20px;border-radius:6px;font-weight:600;
    cursor:pointer;width:160px;
  }
  .btn-clear{background:#777;}
  .btn:hover{opacity:0.9;}

  /* ==== TABLE ==== */
  table{
    width:90%;max-width:1100px;margin:10px auto 30px;border-collapse:collapse;
    background:#f7f7f7;box-shadow:0 0 8px rgba(0,0,0,0.15);
    border-radius:8px;overflow:hidden;
  }
  th,td{
    padding:10px 12px;text-align:left;border-bottom:1px solid #ccc;
    font-size:14px;
  }
  th{background:#003366;color:white;}
  tr:hover{background:#e0ebff;cursor:pointer;}
  tr.selected{background:#cce5ff !important;}

  /* ==== DROPDOWN MENU ==== */
  .menu-item{
    padding:10px;cursor:pointer;font-size:14px;border-bottom:1px solid #eee;
  }
  .menu-item:hover{background:#e6f2ff;}

  @media(max-width:768px){
    .col{width:100%;}
    .btn{width:100%;margin-bottom:10px;}
  }
</style>
</head>

<body>

<h2>FREEZERS MASTER</h2>

<form onsubmit="submitFreezer(event)">
  <div class="form-container">

    <div class="row">
      <div class="col">
        <label>Freezer Name</label>
        <input type="text" id="freezer_name" required placeholder="Enter Freezer Name">
      </div>

      <div class="col">
        <label>Capacity (in Tons)</label>
        <input type="number" id="capacity" step="0.01" placeholder="Enter Capacity">
      </div>

      <div class="col">
        <label>Location</label>
        <input type="text" id="location" placeholder="Enter Location">
      </div>
    </div>

    <input type="hidden" id="record_id">
    <input type="hidden" id="meta_email" value="{{ email }}">
    <input type="hidden" id="meta_company_id" value="{{ company_id }}">

    <div class="actions">
      <button class="btn" type="submit">SAVE</button>
      <button class="btn btn-clear" type="reset" onclick="clearForm()">CLEAR</button>
    </div>

  </div>
</form>

{% if message %}
<p style="text-align:center;color:green;font-weight:600;">{{ message }}</p>
{% endif %}

{% if today_data %}

<!-- 3 DOTS MENU -->
<div id="threeDotsMenu" style="
  display:none;width:90%;max-width:1100px;margin:10px auto;
  text-align:right;position:relative;">
  <button id="dotsBtn" style="
    background:#003366;color:white;border:none;padding:6px 12px;
    border-radius:6px;cursor:pointer;font-weight:600;font-size:20px;">‚ãÆ</button>

  <div id="dropdownMenu" style="
    display:none;position:absolute;right:0;background:white;border:1px solid #ccc;
    border-radius:8px;box-shadow:0 2px 6px rgba(0,0,0,0.2);
    width:200px;z-index:1000;">
    <div onclick="editSelected()" class="menu-item">‚úèÔ∏è Edit</div>
    <div onclick="deleteSelected()" class="menu-item">üóëÔ∏è Delete</div>
    <div onclick="printSelected()" class="menu-item">üñ®Ô∏è Print</div>
    <div onclick="exportPDF()" class="menu-item">üìÑ Export PDF</div>
    <div onclick="exportExcel()" class="menu-item">üìä Export Excel</div>
  </div>
</div>

<table id="dataTable">
  <thead>
    <tr>
      <th>ID</th>
      <th>Freezer Name</th>
      <th>Capacity (Tons)</th>
      <th>Location</th>
      <th>Date</th>
      <th>Time</th>
      <th>Email</th>
      <th>Company ID</th>
    </tr>
  </thead>

  <tbody>
    {% for row in today_data %}
    <tr 
      data-id="{{ row.id }}"
      data-name="{{ row.freezer_name }}"
      data-capacity="{{ row.capacity }}"
      data-location="{{ row.location }}"
    >
      <td>{{ row.id }}</td>
      <td>{{ row.freezer_name }}</td>
      <td>{{ row.capacity }}</td>
      <td>{{ row.location }}</td>
      <td>{{ row.date }}</td>
      <td>{{ row.time }}</td>
      <td>{{ row.email }}</td>
      <td>{{ row.company_id }}</td>
    </tr>
    {% endfor %}
  </tbody>
</table>

{% endif %}

<script>

let selectedRow=null;

/* -------------------------------------
   SAVE / UPDATE
-------------------------------------- */
async function submitFreezer(e){
  e.preventDefault();

  const name=document.getElementById("freezer_name").value.trim();
  const capacity=document.getElementById("capacity").value;
  const location=document.getElementById("location").value;
  const record_id=document.getElementById("record_id").value;

  const now=new Date();
  const date=now.toISOString().slice(0,10);
  const time=now.toTimeString().slice(0,8);

  const email=document.getElementById("meta_email").value;
  const company_id=document.getElementById("meta_company_id").value;

  const fd=new FormData();
  if(record_id) fd.append("id",record_id);

  fd.append("freezer_name",name);
  fd.append("capacity",capacity);
  fd.append("location",location);
  fd.append("date",date);
  fd.append("time",time);
  fd.append("email",email);
  fd.append("company_id",company_id);

  const res=await fetch("/criteria/freezers",{method:"POST",body:fd});

  if(res.ok){ alert("Saved Successfully!"); location.reload(); }
  else alert("Save Failed: "+await res.text());
}

/* -------------------------------------
   SELECT ROW
-------------------------------------- */
document.addEventListener("DOMContentLoaded",()=>{
  const rows=document.querySelectorAll("#dataTable tbody tr");
  const menu=document.getElementById("threeDotsMenu");

  rows.forEach(row=>{
    row.addEventListener("click",()=>{
      rows.forEach(r=>r.classList.remove("selected"));
      row.classList.add("selected");

      selectedRow=row;
      menu.style.display="block";
    });
  });
});

document.getElementById("dotsBtn").addEventListener("click",()=>{
  const d=document.getElementById("dropdownMenu");
  d.style.display=d.style.display==="block"?"none":"block";
});

/* -------------------------------------
   EDIT
-------------------------------------- */
function editSelected(){
  if(!selectedRow) return alert("Select a row!");

  document.getElementById("record_id").value=selectedRow.dataset.id;
  document.getElementById("freezer_name").value=selectedRow.dataset.name;
  document.getElementById("capacity").value=selectedRow.dataset.capacity;
  document.getElementById("location").value=selectedRow.dataset.location;

  window.scrollTo({top:0,behavior:"smooth"});
}

/* -------------------------------------
   DELETE
-------------------------------------- */
async function deleteSelected(){
  if(!selectedRow) return alert("Select a row!");
  if(!confirm("Are you sure?")) return;

  const id=selectedRow.dataset.id;
  const res=await fetch(`/criteria/freezers/delete/${id}`,{method:"POST"});

  if(res.ok) location.reload();
  else alert("Delete Failed");
}

/* -------------------------------------
   PRINT / PDF / EXCEL
-------------------------------------- */
function printSelected(){
  if(!selectedRow) return alert("Select a row!");

  const p=window.open("","_blank");
  p.document.write("<h3>Freezer Details</h3>");
  p.document.write("<p><b>Name:</b> "+selectedRow.dataset.name+"</p>");
  p.document.write("<p><b>Capacity:</b> "+selectedRow.dataset.capacity+"</p>");
  p.document.write("<p><b>Location:</b> "+selectedRow.dataset.location+"</p>");
  p.document.close();
  p.print();
}

function exportPDF(){ printSelected(); }

function exportExcel(){
  if(!selectedRow) return alert("Select a row!");

  const name=selectedRow.dataset.name;
  const capacity=selectedRow.dataset.capacity;
  const location=selectedRow.dataset.location;

  const data=`Name\tCapacity\tLocation\n${name}\t${capacity}\t${location}`;
  const blob=new Blob([data],{type:"application/vnd.ms-excel"});

  const url=URL.createObjectURL(blob);
  const a=document.createElement("a");
  a.href=url;
  a.download="freezer_record.xls";
  a.click();
}

/* -------------------------------------
   CLEAR FORM
-------------------------------------- */
function clearForm(){
  selectedRow=null;
  document.getElementById("record_id").value="";
  document.getElementById("freezer_name").value="";
  document.getElementById("capacity").value="";
  document.getElementById("location").value="";
  document.querySelectorAll("tr.selected").forEach(r=>r.classList.remove("selected"));
  document.getElementById("threeDotsMenu").style.display="none";
}

</script>

</body>
</html>
