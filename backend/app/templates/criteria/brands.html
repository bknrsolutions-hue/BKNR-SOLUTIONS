<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>BRANDS MASTER</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
:root{
  --primary: #143465;
  --accent: #3b82f6;
  --border: #d1d5db;
  --bg: #f3f4f6;
  --text: #1f2937;
  --muted: #6b7280;
  --success: #059669;
}
*{ box-sizing: border-box; font-family: 'Inter', Segoe UI, sans-serif; }
body{ margin: 0; background: var(--bg); color: var(--text); overflow-x: hidden; }

h2 {
  background: #fff; margin: 0; padding: 15px;
  text-align: center; color: var(--primary);
  font-size: 18px; font-weight: 800; text-transform: uppercase;
  border-bottom: 1px solid var(--border);
  letter-spacing: 1px;
}

/* ================= FORM CONTAINER ================= */
.form-container {
  width: 90%; max-width: 1100px; margin: 25px auto;
  background: #fff; padding: 30px; border-radius: 12px;
  border: 1px solid var(--border);
  box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05);
}

.row { display: flex; justify-content: center; margin-bottom: 10px; }
.col { width: 100%; max-width: 500px; display: flex; flex-direction: column; }

label {
  font-size: 11px; font-weight: 700; color: var(--primary);
  text-transform: uppercase; margin-bottom: 8px; text-align: left;
}

input {
  padding: 12px; border: 1px solid var(--border);
  border-radius: 8px; font-size: 14px; background: #fff;
  transition: all 0.2s; outline: none;
}
input:focus { border-color: var(--accent); box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1); }

/* Buttons */
.actions { text-align: center; margin-top: 25px; display: flex; justify-content: center; gap: 12px; }
.btn {
  background: var(--primary); color: white; border: none;
  padding: 12px 30px; border-radius: 8px; font-size: 13px;
  font-weight: 700; cursor: pointer; transition: 0.2s;
  text-transform: uppercase; min-width: 140px;
}
.btn-clear { background: #f1f5f9; color: var(--muted); }
.btn:hover { background: var(--accent); color: #fff; transform: translateY(-1px); }

/* ================= TABLE AREA ================= */
#threeDotsMenu {
  width: 90%; max-width: 1100px; margin: 15px auto;
  position: relative;
}
#dotsBtn {
  background: var(--primary); color: #fff; border: none;
  width: 38px; height: 38px; border-radius: 8px;
  cursor: pointer; font-size: 20px; transition: 0.2s;
}

#dropdownMenu {
  position: absolute; right: 0; top: 45px; width: 180px;
  background: #fff; border: 1px solid var(--border);
  border-radius: 10px; box-shadow: 0 10px 25px rgba(0,0,0,0.1);
  display: none; z-index: 1000; overflow: hidden;
}
.menu-item {
  padding: 12px 15px; font-size: 12px; font-weight: 600;
  border-bottom: 1px solid #f1f5f9; cursor: pointer; color: var(--primary);
  text-align: left;
}
.menu-item:hover { background: #f0f7ff; color: var(--accent); }

table {
  width: 90%; max-width: 1100px; margin: 10px auto 40px;
  border-collapse: collapse; background: #fff;
  border-radius: 10px; overflow: hidden;
  border: 1px solid var(--border); box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05);
}
th {
  background: #f1f5f9; color: #475569; padding: 12px;
  font-size: 11px; text-transform: uppercase; border-bottom: 2px solid var(--border);
  text-align: center;
}
td { padding: 12px; border-bottom: 1px solid #f1f5f9; font-size: 12px; text-align: center; color: var(--text); }
tr:hover { background: #f8fbff; cursor: pointer; }
tr.selected { background: #eff6ff !important; border-left: 5px solid var(--accent); }

/* Column Customization */
td:nth-child(2) { font-weight: 700; color: var(--primary); } /* Brand Name Column */

@media(max-width: 768px){
  .form-container, table, #threeDotsMenu { width: 95%; }
  .actions { flex-direction: column; }
  .btn { width: 100%; }
}
</style>
</head>
<body>

<h2>BRANDS MASTER</h2>

<!-- FORM -->
<form onsubmit="submitBrand(event)">
  <div class="form-container">
    <div class="row">
      <div class="col">
        <label>Brand Name</label>
        <input type="text" id="brand_name" required placeholder="Enter Brand Name">
      </div>
    </div>

    <!-- Hidden Fields -->
    <input type="hidden" id="record_id">
    <input type="hidden" id="meta_email">
    <input type="hidden" id="meta_company_id">

    <div class="actions">
      <button class="btn" type="submit">SAVE</button>
      <button class="btn btn-clear" type="reset" onclick="clearForm()">CLEAR</button>
    </div>
  </div>
</form>

{% if message %}
<p style="text-align:center;color:green;font-weight:600;">{{ message }}</p>
{% endif %}

{% if today_data %}

<div id="threeDotsMenu" style="display:none;width:90%;max-width:1100px;
  margin:10px auto;text-align:right;position:relative;">
  <button id="dotsBtn" style="
    background:#003366;color:white;border:none;padding:6px 12px;
    border-radius:6px;cursor:pointer;font-weight:600;font-size:20px;">‚ãÆ</button>

  <div id="dropdownMenu" style="
    display:none;position:absolute;right:0;background:white;border:1px solid #ccc;
    border-radius:8px;box-shadow:0 2px 6px rgba(0,0,0,0.2);width:180px;z-index:1000;">
    <div onclick="editSelected()" class="menu-item">‚úèÔ∏è Edit</div>
    <div onclick="deleteSelected()" class="menu-item">üóëÔ∏è Delete</div>
    <div onclick="printSelected()" class="menu-item">üñ®Ô∏è Print</div>
    <div onclick="exportPDF()" class="menu-item">üìÑ Export PDF</div>
    <div onclick="exportExcel()" class="menu-item">üìä Export Excel</div>
  </div>
</div>

<table id="dataTable">
  <thead>
    <tr>
      <th>ID</th>
      <th>Brand Name</th>
      <th>Date</th>
      <th>Time</th>
      <th>Email</th>
      <th>Company ID</th>
    </tr>
  </thead>
  <tbody>
    {% for row in today_data %}
    <tr data-id="{{ row.id }}" data-name="{{ row.brand_name }}">
      <td>{{ row.id }}</td>
      <td>{{ row.brand_name }}</td>
      <td>{{ row.date }}</td>
      <td>{{ row.time }}</td>
      <td>{{ row.email }}</td>
      <td>{{ row.company_id }}</td>
    </tr>
    {% endfor %}
  </tbody>
</table>

{% endif %}

<script>

let selectedRow = null;

/* -------------------------------------
   LOAD LOGIN MAIL + COMPANY ID
-------------------------------------- */
function loadLoginData() {
    const email = localStorage.getItem("userEmail");
    const company = localStorage.getItem("companyID");

    console.log("Loaded Email:", email);
    console.log("Loaded Company:", company);

    document.getElementById("meta_email").value = email || "";
    document.getElementById("meta_company_id").value = company || "";
}

document.addEventListener("DOMContentLoaded", loadLoginData);


/* -------------------------------------
   SUBMIT FORM USING FORMDATA
-------------------------------------- */
async function submitBrand(e){
  e.preventDefault();

  const brand_name = document.getElementById("brand_name").value.trim();
  const record_id = document.getElementById("record_id").value;

  const now = new Date();
  const date = now.toISOString().slice(0,10);
  const time = now.toTimeString().slice(0,8);

  const email = document.getElementById("meta_email").value;
  const company_id = document.getElementById("meta_company_id").value;

  const fd = new FormData();

  if (record_id && record_id.trim() !== "") {
      fd.append("id", record_id);
  }

  fd.append("brand_name", brand_name);
  fd.append("date", date);
  fd.append("time", time);
  fd.append("email", email);
  fd.append("company_id", company_id);

  const res = await fetch("/criteria/brands", {
    method: "POST",
    body: fd
  });

  if(res.ok){
    alert("Saved Successfully!");
    location.reload();
  } else {
    alert("Save Failed: " + await res.text());
  }
}

/* -------------------------------------
   SELECT + EDIT + DELETE
-------------------------------------- */
document.addEventListener('DOMContentLoaded', ()=>{
  const rows = document.querySelectorAll('#dataTable tbody tr');
  const menu = document.getElementById('threeDotsMenu');

  rows.forEach(row=>{
    row.addEventListener('click', ()=>{
      rows.forEach(r => r.classList.remove('selected'));
      row.classList.add('selected');
      selectedRow = row;
      menu.style.display = "block";
    });
  });
});


document.getElementById('dotsBtn').addEventListener('click', ()=>{
  const d = document.getElementById('dropdownMenu');
  d.style.display = (d.style.display==="block") ? "none" : "block";
});


function editSelected(){
  if(!selectedRow) return alert("Select a row!");

  document.getElementById("record_id").value = selectedRow.dataset.id;
  document.getElementById("brand_name").value = selectedRow.dataset.name;

  window.scrollTo({top:0,behavior:'smooth'});
}


async function deleteSelected(){
  if(!selectedRow) return alert("Select row!");
  if(!confirm("Are you sure?")) return;

  const id = selectedRow.dataset.id;

  const res = await fetch(`/criteria/brands/delete/${id}`, {
    method:"POST"
  });

  if(res.ok) location.reload();
  else alert("Delete failed");
}


function printSelected(){
  if(!selectedRow) return alert("Select a row!");

  const id = selectedRow.children[0].innerText;
  const name = selectedRow.children[1].innerText;

  const p = window.open("", "_blank");
  p.document.write("<h3>Brand Details</h3>");
  p.document.write("<p><b>ID:</b> "+id+"</p>");
  p.document.write("<p><b>Brand Name:</b> "+name+"</p>");
  p.document.close();
  p.print();
}

function exportPDF(){ printSelected(); }

function exportExcel(){
  if(!selectedRow) return alert("Select a row!");

  const id = selectedRow.children[0].innerText;
  const name = selectedRow.children[1].innerText;

  const data = `ID\tBrand Name\n${id}\t${name}`;
  const blob = new Blob([data], {type:"application/vnd.ms-excel"});

  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "brand_record.xls";
  a.click();
}

function clearForm(){
  selectedRow = null;
  document.querySelectorAll("tr.selected")
    .forEach(r => r.classList.remove("selected"));
  document.getElementById("threeDotsMenu").style.display="none";
}

</script>

</body>
</html>
