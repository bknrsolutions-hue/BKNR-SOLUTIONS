<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>STOCK ENTRY (IN / OUT) - BKNR SOLUTIONS</title>
<style>
  body{font-family:Arial,sans-serif;background:#e6f2ff;margin:0;padding:0;}
  h2{text-align:center;color:#003366;margin:20px 0;font-weight:700;}
  .form-container{width:90%;max-width:1150px;margin:0 auto;background:#fff;
    box-shadow:0 0 8px rgba(0,0,0,0.15);padding:25px;border-radius:8px;}
  .row{display:flex;justify-content:space-between;margin-bottom:18px;flex-wrap:wrap;}
  .col{width:32%;display:flex;flex-direction:column;}
  label{font-weight:600;color:#003366;margin-bottom:6px;}
  select,input{padding:8px;border:1px solid #a3bcd6;border-radius:6px;font-size:14px;
    background:#f9fcff;transition:all 0.2s ease;}
  select:focus,input:focus{border-color:#003366;outline:none;box-shadow:0 0 5px rgba(0,51,102,0.3);}
  #quantity.red-text{color:red;font-weight:700;}
  .actions{text-align:center;margin-top:25px;}
  .btn{background:#003366;color:white;border:none;padding:9px 18px;border-radius:6px;
    font-weight:600;cursor:pointer;margin:0 8px;width:120px;}
  .btn-clear{background:#777;}
  .btn:hover{opacity:0.9;}
  /* Popup Modal */
  .modal-overlay{position:fixed;top:0;left:0;width:100%;height:100%;
    background:rgba(0,0,0,0.5);display:none;align-items:center;justify-content:center;}
  .modal{background:#fff;border-radius:10px;box-shadow:0 0 10px rgba(0,0,0,0.3);
    padding:25px;width:350px;max-width:90%;text-align:center;}
  .modal h3{margin-top:0;color:#003366;}
  .modal input{width:90%;margin:10px 0;padding:8px;}
  .modal-buttons{margin-top:15px;}
  .modal-buttons button{margin:0 5px;}
</style>
</head>
<body>
  <h2>STOCK ENTRY (IN / OUT)</h2>

  <form action="/inventory/stock_entry" method="post" onsubmit="fillMeta(this)">
    <div class="form-container">

      <!-- Row 1 -->
      <div class="row">
        <div class="col">
          <label>Batch Number</label>
          <input type="text" name="batch_number" placeholder="Enter Batch Number" required>
        </div>
        <div class="col">
          <label>Type of Production</label>
          <select name="type_of_production" id="typeOfProduction" required></select>
        </div>
        <div class="col">
          <label>Cargo Movement Type</label>
          <select name="cargo_movement_type" id="movementType" required>
            <option value="" disabled selected>Select</option>
            <option value="IN">IN</option>
            <option value="OUT">OUT</option>
          </select>
        </div>
      </div>

      <!-- Row 2 -->
      <div class="row">
        <div class="col"><label>Brand</label><select id="brand" name="brand" required></select></div>
        <div class="col"><label>Freezer</label><select id="freezer" name="freezer" required></select></div>
        <div class="col"><label>Packing Style</label><select id="packingStyle" name="packing_style" required></select></div>
      </div>

      <!-- Row 3 -->
      <div class="row">
        <div class="col"><label>Glaze %</label><select id="glaze" name="glaze" required></select></div>
        <div class="col"><label>Variety</label><select id="variety" name="variety" required></select></div>
        <div class="col"><label>Grade</label><select id="grade" name="grade" required></select></div>
      </div>

      <!-- Row 4 -->
      <div class="row">
        <div class="col"><label>No. of MC</label><input type="number" id="noOfMc" name="no_of_mc" min="0" required></div>
        <div class="col"><label>Loose</label><input type="number" id="loose" name="loose" min="0" required></div>
        <div class="col"><label>Quantity (Kg)</label><input type="number" id="quantity" name="quantity" disabled></div>
      </div>

      <!-- Row 5 -->
      <div class="row">
        <div class="col"><label>Purpose</label><select id="purpose" name="purpose" required></select></div>
        <div class="col"><label>PO Number</label><select id="poNumber" name="po_number"></select></div>
        <div class="col"><label>Location</label><select id="location" name="location"></select></div>
      </div>

      <!-- Row 6 -->
      <div class="row">
        <div class="col"><label>Storage At</label><select id="storageAt" name="storage_at" required></select></div>
      </div>

      <!-- Hidden Fields -->
      <input type="hidden" name="date" id="meta_date">
      <input type="hidden" name="time" id="meta_time">
      <input type="hidden" name="email" id="meta_email">
      <input type="hidden" name="company_id" id="meta_company_id">

      <div class="actions">
        <button class="btn" type="submit">SAVE</button>
        <button class="btn btn-clear" type="reset">CLEAR</button>
      </div>
    </div>
  </form>

  <!-- Popup Modal -->
  <div id="popup" class="modal-overlay">
    <div class="modal">
      <h3 id="popupTitle">Add New Item</h3>
      <input type="text" id="popupInput" placeholder="Enter new value">
      <div class="modal-buttons">
        <button class="btn" onclick="saveNewValue()">Save</button>
        <button class="btn btn-clear" onclick="closePopup()">Cancel</button>
      </div>
    </div>
  </div>

  <script>
    let activeDropdown = null;

    // Fill meta automatically
    function fillMeta(form){
      const now=new Date();
      form.date.value=now.toISOString().slice(0,10);
      form.time.value=now.toTimeString().slice(0,8);
      form.email.value=localStorage.getItem('userEmail')||'bknr.solutions@gmail.com';
      form.company_id.value=localStorage.getItem('companyID')||'BKNR001';
    }

    // Lookup data
    const lookups={
      typeOfProduction:["Block Freezing","IQF","Cooking"],
      brand:["SeaFresh","OceanBlue","BKNR"],
      freezer:["Freezer 1","Freezer 2"],
      packingStyle:[{name:"10Kg Block",mc:10,slab:1.5},{name:"5Kg Box",mc:5,slab:1.0}],
      glaze:["0%","5%","10%","20%"],
      variety:["Vannamei","Tiger Shrimp","White Prawn"],
      grade:["20/25","25/30","30/40"],
      purpose:["Export","Local Sale","Processing"],
      poNumber:["PO-1001","PO-1002"],
      location:["Warehouse A","Warehouse B"],
      storageAt:["Bay 1","Bay 2"]
    };

    function fillSelect(id,list,valKey="name"){
      const sel=document.getElementById(id);
      sel.innerHTML="";
      const defaultOpt=document.createElement("option");
      defaultOpt.text="Select";defaultOpt.disabled=true;defaultOpt.selected=true;
      sel.appendChild(defaultOpt);
      list.forEach(v=>{
        const opt=document.createElement("option");
        opt.value=typeof v==='object'?v[valKey]:v;
        opt.textContent=opt.value;
        sel.appendChild(opt);
      });
      const addOpt=document.createElement("option");
      addOpt.value="__add__";addOpt.textContent="ï¼‹ Add new...";
      sel.appendChild(addOpt);
      sel.addEventListener("change",()=>{if(sel.value==="__add__")openPopup(id);});
    }

    for(let key in lookups){fillSelect(key,lookups[key]);}

    // Popup control
    function openPopup(id){
      activeDropdown=id;
      document.getElementById("popupTitle").textContent="Add New "+id.replace(/([A-Z])/g,' $1');
      document.getElementById("popupInput").value="";
      document.getElementById("popup").style.display="flex";
    }
    function closePopup(){document.getElementById("popup").style.display="none";}
    function saveNewValue(){
      const val=document.getElementById("popupInput").value.trim();
      if(val && activeDropdown){
        const sel=document.getElementById(activeDropdown);
        const opt=document.createElement("option");
        opt.value=val;opt.textContent=val;
        sel.insertBefore(opt, sel.lastElementChild);
        sel.value=val;
      }
      closePopup();
    }

    // Quantity calculation
    const mc=document.getElementById("noOfMc");
    const loose=document.getElementById("loose");
    const packSelect=document.getElementById("packingStyle");
    const qty=document.getElementById("quantity");
    const movement=document.getElementById("movementType");
    function calcQty(){
      const mcVal=parseFloat(mc.value)||0;
      const looseVal=parseFloat(loose.value)||0;
      const selected=lookups.packingStyle.find(p=>p.name===packSelect.value);
      qty.value=selected?(mcVal*selected.mc)+(looseVal*selected.slab):"";
    }
    [mc,loose,packSelect].forEach(e=>e.addEventListener("input",calcQty));
    movement.addEventListener("change",()=>qty.classList.toggle("red-text",movement.value==="OUT"));

    fillMeta(document.forms[0]);
  </script>
</body>
</html>
