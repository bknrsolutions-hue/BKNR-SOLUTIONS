<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>GENERAL STOCK - BKNR SOLUTIONS</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
:root{
  --primary: #143465;
  --accent: #3b82f6;
  --border: #d1d5db;
  --bg: #f3f4f6;
  --text: #1f2937;
  --muted: #6b7280;
  --danger: #dc2626;
  --success: #059669;
}
*{ box-sizing: border-box; font-family: 'Inter', Segoe UI, sans-serif; }
body{ margin: 0; background: var(--bg); color: var(--text); overflow-x: hidden; }

h2 {
  background: #fff; margin: 0; padding: 15px;
  text-align: center; color: var(--primary);
  font-size: 18px; font-weight: 800; text-transform: uppercase;
  border-bottom: 1px solid var(--border);
  letter-spacing: 1px;
}

/* ================= FORM CONTAINER ================= */
.form-container{
  width: 95%; max-width: 1100px; margin: 20px auto;
  background: #fff; padding: 25px; border-radius: 12px;
  border: 1px solid var(--border);
  box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05);
}

.row { display: flex; flex-wrap: wrap; gap: 20px; margin-bottom: 15px; }
.col { flex: 1; min-width: 250px; display: flex; flex-direction: column; }

label {
  font-size: 11px; font-weight: 700; color: var(--primary);
  text-transform: uppercase; margin-bottom: 6px;
}

select, input {
  padding: 10px; border: 1px solid var(--border);
  border-radius: 8px; font-size: 13px; background: #fff;
  transition: all 0.2s; outline: none;
}
select:focus, input:focus { border-color: var(--accent); box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1); }
input[readonly] { background: #f9fafb; cursor: not-allowed; color: var(--muted); }

/* Dynamic Status Colors */
#quantity.out-selected { color: var(--danger); font-weight: 800; border-color: var(--danger); }
#availableStock.low-stock { background: #fef2f2; color: var(--danger); font-weight: 800; border-color: var(--danger); }

/* Buttons */
.btn {
  background: var(--primary); color: white; border: none;
  padding: 12px 25px; border-radius: 8px; font-size: 13px;
  font-weight: 700; cursor: pointer; transition: 0.2s;
  text-transform: uppercase;
}
.btn:hover { background: var(--accent); transform: translateY(-1px); }

/* ================= TABLE AREA ================= */
#actionBar {
  width: 95%; max-width: 1100px; margin: 10px auto;
  display: flex; justify-content: flex-end; position: relative;
}
#dots {
  background: var(--primary); color: #fff; border: none;
  width: 35px; height: 35px; border-radius: 8px;
  cursor: pointer; font-size: 20px;
}

#menuBox {
  position: absolute; right: 0; top: 40px; width: 180px;
  background: #fff; border: 1px solid var(--border);
  border-radius: 10px; box-shadow: 0 10px 25px rgba(0,0,0,0.1);
  display: none; z-index: 100; overflow: hidden;
}
.menu-item {
  padding: 12px 15px; font-size: 12px; font-weight: 600;
  border-bottom: 1px solid #f1f5f9; cursor: pointer; color: var(--primary);
}
.menu-item:hover { background: #f0f7ff; color: var(--accent); }

table {
  width: 95%; max-width: 1100px; margin: 10px auto 40px;
  border-collapse: collapse; background: #fff;
  border-radius: 10px; overflow: hidden;
  border: 1px solid var(--border); box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05);
}
th {
  background: #f1f5f9; color: #475569; padding: 12px;
  font-size: 11px; text-transform: uppercase; border-bottom: 2px solid var(--border);
}
td { padding: 10px 12px; border-bottom: 1px solid #f1f5f9; font-size: 12px; text-align: left; }
tr:hover { background: #f8fbff; }
tr.selected { background: #eff6ff !important; border-left: 4px solid var(--accent); }

/* ================= MODAL ================= */
.modal-overlay {
  position: fixed; top: 0; left: 0; width: 100%; height: 100%;
  background: rgba(15, 23, 42, 0.6); backdrop-filter: blur(4px);
  display: none; align-items: center; justify-content: center; z-index: 9999;
}
.modal {
  background: #fff; padding: 30px; border-radius: 15px; width: 380px;
  box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1); text-align: center;
}
.modal h3 { margin: 0 0 20px; color: var(--primary); font-size: 16px; }
.modal input { width: 100%; margin-bottom: 20px; }
.modal-buttons { display: flex; gap: 10px; justify-content: center; }
.modal-buttons button {
  padding: 10px 20px; border-radius: 8px; border: none;
  font-size: 12px; font-weight: 700; cursor: pointer;
}
.save { background: var(--primary); color: #fff; }
.cancel { background: #f1f5f9; color: var(--muted); }

@media(max-width: 768px){
  .row { flex-direction: column; gap: 10px; }
  .col { width: 100%; }
}
</style>
</head>

<body>

<h2>GENERAL STOCK</h2>

<form id="generalStockForm" action="/inventory/general_stock" method="post" onsubmit="return validateForm(event)">
  <div class="form-container">

    <div class="row">
      <div class="col">
        <label>GRN Number</label>
        <select id="grnNumber" name="grn_number" required onchange="handleAddNew(this)">
          <option value="" disabled selected>Select GRN</option>
          {% for g in grn_list %}
            <option value="{{ g }}">{{ g }}</option>
          {% endfor %}
          <option value="add_new">‚ûï Add New</option>
        </select>
      </div>

      <div class="col">
        <label>Item Name</label>
        <select id="itemName" name="item_name" required onchange="handleAddNew(this)">
          <option value="" disabled selected>Select Item</option>
          {% for i in items %}
            <option value="{{ i }}">{{ i }}</option>
          {% endfor %}
          <option value="add_new">‚ûï Add New</option>
        </select>
      </div>

      <div class="col">
        <label>Unit Name</label>
        <select id="unitName" name="unit_name" required onchange="handleAddNew(this)">
          <option value="" disabled selected>Select Unit</option>
          {% for u in units %}
            <option value="{{ u }}">{{ u }}</option>
          {% endfor %}
          <option value="add_new">‚ûï Add New</option>
        </select>
      </div>
    </div>

    <div class="row">
      <div class="col">
        <label>Movement Type</label>
        <select id="movementType" name="movement_type" required onchange="updateColor(); handleAddNew(this)">
          <option value="" disabled selected>Select Movement</option>
          <option value="IN">IN</option>
          <option value="OUT">OUT</option>
        </select>
      </div>

      <div class="col">
        <label>Quantity</label>
        <input type="number" id="quantity" name="quantity" step="0.01" min="0" required>
      </div>

      <div class="col">
        <label>Opening Stock</label>
        <input type="number" id="openingStock" name="opening_stock" step="0.01" min="0" required>
      </div>
    </div>

    <div class="row">
      <div class="col">
        <label>Available Stock</label>
        <input type="number" id="availableStock" name="available_stock" step="0.01" min="0" required oninput="checkStockLevel()">
      </div>

      <div class="col">
        <label>Minimum Level</label>
        <input type="number" id="minimumLevel" name="minimum_level" step="0.01" min="0" oninput="checkStockLevel()">
      </div>

      <div class="col actions">
        <button class="btn" type="submit">SAVE</button>
      </div>
    </div>
  </div>
</form>

{% if today_data %}
<div id="actionBar">
  <button id="dots">‚ãÆ</button>

  <div id="menuBox">
    <div class="menu-item" onclick="editSelected()">‚úèÔ∏è Edit</div>
    <div class="menu-item" onclick="deleteSelected()">üóëÔ∏è Delete</div>
    <div class="menu-item" onclick="printSelected()">üñ®Ô∏è Print</div>
    <div class="menu-item" onclick="exportExcel()">üìÑ Export Excel</div>
  </div>
</div>

<table id="dataTable">
  <thead>
    <tr>
      <th>ID</th><th>GRN</th><th>Item</th><th>Unit</th>
      <th>Movement</th><th>Qty</th><th>Opening</th>
      <th>Available</th><th>Minimum</th><th>Date</th><th>Time</th>
    </tr>
  </thead>
  <tbody>
    {% for row in today_data %}
    <tr 
      data-id="{{ row.id }}"
      data-grn="{{ row.grn_number }}"
      data-item="{{ row.item_name }}"
      data-unit="{{ row.unit_name }}"
      data-move="{{ row.movement_type }}"
      data-qty="{{ row.quantity }}"
      data-open="{{ row.opening_stock }}"
      data-avail="{{ row.available_stock }}"
      data-min="{{ row.minimum_level }}"
    >
      <td>{{ row.id }}</td>
      <td>{{ row.grn_number }}</td>
      <td>{{ row.item_name }}</td>
      <td>{{ row.unit_name }}</td>
      <td>{{ row.movement_type }}</td>
      <td>{{ row.quantity }}</td>
      <td>{{ row.opening_stock }}</td>
      <td>{{ row.available_stock }}</td>
      <td>{{ row.minimum_level }}</td>
      <td>{{ row.date }}</td>
      <td>{{ row.time }}</td>
    </tr>
    {% endfor %}
  </tbody>
</table>
{% endif %}

<!-- ADD NEW MODAL -->
<div id="addNewModal" class="modal-overlay">
  <div class="modal">
    <h3 id="modalTitle">Add New</h3>
    <input type="text" id="newValueInput" placeholder="Enter new value">
    <div class="modal-buttons">
      <button class="cancel" onclick="closeModal()">Cancel</button>
      <button class="save" onclick="saveNewValue()">Save</button>
    </div>
  </div>
</div>

<script>
/* -------------------------------------------- */
/* ADD NEW option modal */
/* -------------------------------------------- */
let currentSelect=null;

function handleAddNew(el){
  if(el.value==="add_new"){
    currentSelect=el;
    document.getElementById('newValueInput').value="";
    document.getElementById('modalTitle').innerText="Add New "+el.previousElementSibling.innerText;
    document.getElementById('addNewModal').style.display="flex";
  }
}
function closeModal(){document.getElementById('addNewModal').style.display="none";currentSelect.value="";}
function saveNewValue(){
  const v=document.getElementById('newValueInput').value.trim();
  if(v){
    let opt=document.createElement("option");
    opt.value=v;opt.text=v;
    currentSelect.insertBefore(opt,currentSelect.lastElementChild);
    currentSelect.value=v;
  }
  closeModal();
}

/* -------------------------------------------- */
/* STOCK color logic */
/* -------------------------------------------- */
function updateColor(){
  const mv=movementType.value;
  if(mv==="OUT") quantity.classList.add("out-selected");
  else quantity.classList.remove("out-selected");
}
function checkStockLevel(){
  const a=parseFloat(availableStock.value)||0;
  const m=parseFloat(minimumLevel.value)||0;
  if(a<m) availableStock.classList.add("low-stock");
  else availableStock.classList.remove("low-stock");
}

/* ADMIN lock */
const isAdmin=false;
window.onload=()=>{ if(!isAdmin){ minimumLevel.readOnly=true; minimumLevel.title="Admin only"; } }

/* -------------------------------------------- */
/* TABLE ROW SELECTION + MENU */
/* -------------------------------------------- */
let selectedRow=null;

document.addEventListener("DOMContentLoaded",()=>{
  const rows=document.querySelectorAll("#dataTable tbody tr");
  rows.forEach(r=>{
    r.onclick=()=>{
      rows.forEach(x=>x.classList.remove("selected"));
      r.classList.add("selected");
      selectedRow=r;
      actionBar.style.display="block";
    };
  });
});

dots.onclick=()=>{menuBox.style.display=(menuBox.style.display==="block")?"none":"block";};

/* -------------------------------------------- */
/* EDIT */
/* -------------------------------------------- */
function editSelected(){
  if(!selectedRow) return;

  grnNumber.value=selectedRow.dataset.grn;
  itemName.value=selectedRow.dataset.item;
  unitName.value=selectedRow.dataset.unit;
  movementType.value=selectedRow.dataset.move;
  quantity.value=selectedRow.dataset.qty;
  openingStock.value=selectedRow.dataset.open;
  availableStock.value=selectedRow.dataset.avail;
  minimumLevel.value=selectedRow.dataset.min;

  window.scrollTo({top:0,behavior:"smooth"});
}

/* -------------------------------------------- */
/* DELETE */
/* -------------------------------------------- */
async function deleteSelected(){
  if(!selectedRow) return;
  if(!confirm("Delete this entry?")) return;

  const id=selectedRow.dataset.id;
  const res=await fetch(`/inventory/general_stock/delete/${id}`,{method:"POST"});
  if(res.ok) location.reload();
  else alert("Delete failed");
}

/* -------------------------------------------- */
/* PRINT */
/* -------------------------------------------- */
function printSelected(){
  if(!selectedRow) return;
  const w=window.open("", "_blank");
  w.document.write("<h2>General Stock Record</h2>");
  w.document.write(`<p><b>GRN:</b> ${selectedRow.dataset.grn}</p>`);
  w.document.write(`<p><b>Item:</b> ${selectedRow.dataset.item}</p>`);
  w.document.write(`<p><b>Unit:</b> ${selectedRow.dataset.unit}</p>`);
  w.document.write(`<p><b>Movement:</b> ${selectedRow.dataset.move}</p>`);
  w.document.write(`<p><b>Qty:</b> ${selectedRow.dataset.qty}</p>`);
  w.print();
}

/* -------------------------------------------- */
/* EXPORT EXCEL */
/* -------------------------------------------- */
function exportExcel(){
  if(!selectedRow) return;

  let csv=`ID,GRN,Item,Unit,Movement,Qty,Opening,Available,Minimum\n`;
  csv+=`${selectedRow.dataset.id},${selectedRow.dataset.grn},${selectedRow.dataset.item},${selectedRow.dataset.unit},${selectedRow.dataset.move},${selectedRow.dataset.qty},${selectedRow.dataset.open},${selectedRow.dataset.avail},${selectedRow.dataset.min}`;

  const blob=new Blob([csv],{type:"application/vnd.ms-excel"});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download="general_stock.xls";
  a.click();
}

/* -------------------------------------------- */
/* FORM VALIDATION */
/* -------------------------------------------- */
function validateForm(e){
  checkStockLevel();
  return true;
}
</script>

</body>
</html>
