<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Pending Orders Detailed Report – BKNR ERP</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">

<style>
:root{
  --primary:#143465; --border:#d6dde7; --bg:#f4f6f9; --accent: #3b82f6; --card:#ffffff;
  --success: #16a34a; --danger: #dc2626;
}
*{box-sizing:border-box; font-family: 'Inter', sans-serif;}
body{margin:0; background:var(--bg); color: #334155; font-size: 8px;}

/* HEADER */
.header{
  position:sticky; top:0; z-index: 1000;
  background:#fff; padding:12px 20px;
  border-bottom:1px solid var(--border);
  display:flex; justify-content:space-between; align-items:center;
}
.header h2{margin:0; color:var(--primary); font-weight: 800; font-size: 16px; text-transform: uppercase;}

/* FILTER SECTION */
.section-filter{
  margin:15px; background:#fff; padding:15px;
  border-radius:12px; border:1px solid var(--border);
  display: grid; grid-template-columns: repeat(5, 1fr); gap: 12px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.02);
}
.field{display:flex; flex-direction:column; gap: 3px;}
.field label{font-size:7.5px; font-weight:700; color: #64748b; text-transform: uppercase;}
.field input, .field select{
  padding:5px; border-radius:5px; border:1px solid var(--border); font-size: 9px; outline: none;
}

/* SUMMARY CARDS */
.summary-container {
    display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin: 0 15px 15px;
}
.summary-card {
    background: #fff; border-radius: 12px; border: 1px solid var(--border);
    overflow: hidden; box-shadow: 0 4px 6px rgba(0,0,0,0.02);
}
.summary-header {
    background: #f8fafc; padding: 10px 15px; cursor: pointer;
    border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center;
}
.summary-header h3 { margin: 0; font-size: 10px; color: var(--primary); font-weight: 800; }
.summary-content { padding: 10px; display: block; }

.sum-table { width: 100%; border-collapse: collapse; font-size: 9px; }
.sum-table th { background: var(--primary); color: white; padding: 6px; text-align: left; }
.sum-table td { padding: 6px; border-bottom: 1px solid var(--border); font-weight: 600; }
.sum-total-row { background: #f1f5f9; font-weight: 800 !important; color: var(--primary); }

/* DRILL DOWN STYLE (SUMARY EXPAND) */
.drill-row td { background: #fffbeb !important; padding: 0 !important; }
.drill-container { padding: 5px; border: 1px dashed #fcd34d; margin: 5px; border-radius: 6px; background: #fff; }
.drill-mini-table { width: 100%; border-collapse: collapse; font-size: 8px; }
.drill-mini-table th { 
    background: #fef3c7; color: #92400e; padding: 3px 5px; 
    border: 1px solid #fde68a; height: 20px !important; /* Header height reduced */
}
.drill-mini-table td { padding: 3px 5px; border: 1px solid #fde68a; text-align: center; color: #334155; }

.clickable-count { color: var(--accent); text-decoration: underline; cursor: pointer; font-weight: 800; }

/* MAIN DATA TABLE */
.table-wrap{
  margin:0 15px 30px; background:#fff; border-radius:12px; border:1px solid var(--border);
  overflow: hidden; box-shadow: 0 4px 6px rgba(0,0,0,0.05);
}
table { width: 100%; border-collapse: collapse; table-layout: fixed; }

thead th {
    background: #f1f5f9; color: #475569; padding: 6px 2px; height: 55px;
    font-size: 6.5px; font-weight: 700; border: 1px solid var(--border);
    text-transform: uppercase; white-space: normal; word-wrap: break-word;
}

tbody td {
    padding: 6px 2px; border: 1px solid var(--border);
    text-align: center; word-wrap: break-word; vertical-align: middle;
}

thead th, tbody td { width: 3.44%; }

.po-cell { background: #f8faff; font-weight: 700; color: var(--accent); }
.subtotal-row td { background: #f3f6fb; font-weight: 800; color: var(--primary); border-top: 2px solid var(--border); }
.grand-total { background: var(--primary) !important; color: white !important; font-weight: 800; }
.calc-col { background: #f0fdf4; color: #15803d; font-weight: 700; }
.currency-col { background: #fffbeb; color: #b45309; font-weight: 700; }

.stock-btn { 
    background: #eff6ff; color: var(--accent); font-weight: 800; padding: 2px;
    border-radius: 4px; border: 1px solid #bfdbfe; cursor: pointer; display: block;
    text-decoration: underline;
}

/* CORPORATE EXPAND STYLES */
.detail-container { padding: 12px; background: #f8fafc; border: 1px solid #e2e8f0; margin: 5px 10px; border-radius: 8px; }
.detail-title { font-size: 9px; font-weight: 800; color: var(--primary); margin-bottom: 6px; display: flex; align-items: center; gap: 5px; text-transform: uppercase; }
.corp-table { width: 100%; border-collapse: separate; border-spacing: 0; font-size: 8.5px; background: #fff; border: 1px solid var(--border); border-radius: 5px; overflow: hidden; }
.corp-table th { background: #f1f5f9; padding: 6px 10px; text-align: left; border-bottom: 2px solid var(--border); }
.corp-table td { padding: 6px 10px; border-bottom: 1px solid #f1f5f9; }
.badge-po { background: #e0f2fe; color: #0369a1; padding: 1px 4px; border-radius: 3px; font-weight: 700; }
.txt-red { color: var(--danger) !important; font-weight: 700; }
.txt-green { color: var(--success) !important; font-weight: 700; }

@media print { .header, .section-filter, .summary-header i { display: none !important; } }
</style>
</head>

<body>

<div class="header">
  <h2><i class="fa-solid fa-chart-line"></i> Pending Orders Detailed Report</h2>
  <div style="display: flex; gap: 10px; align-items: center;">
    <button onclick="resetFilters()" style="background:#64748b; color:white; border:none; padding:5px 12px; border-radius:6px; cursor:pointer; font-weight:700; font-size:9px;">
        RESET ALL
    </button>
    <button onclick="window.print()" style="background:var(--accent); color:white; border:none; padding:5px 12px; border-radius:6px; cursor:pointer; font-weight:700; font-size:9px;">
        <i class="fa fa-print"></i> PRINT
    </button>
  </div>
</div>

<div class="section-filter">
    <div class="field"><label>Ship From</label><input type="date" id="from_date"></div>
    <div class="field"><label>Ship To</label><input type="date" id="to_date"></div>
    <div class="field"><label>PO Dropdown</label>
        <select id="f_po_drop" onchange="applyFilters()">
            <option value="">All Active POs</option>
            {% for po in f_po %}<option value="{{ po }}">{{ po }}</option>{% endfor %}
        </select>
    </div>
    <div class="field"><label>Search Anything</label><input type="text" id="f_search" placeholder="Buyer, Variety..." oninput="applyFilters()"></div>
    <div class="field"><label>Summary Status</label><div id="rowCount" style="font-weight:800; color:var(--accent); padding-top:4px;">Loading...</div></div>
</div>

<div class="summary-container">
    <div class="summary-card">
        <div class="summary-header" onclick="toggleSum('hlso_box')">
            <h3>HLSO REQUIREMENT SUMMARY</h3>
            <i class="fa fa-chevron-up"></i>
        </div>
        <div id="hlso_box" class="summary-content">
            <table class="sum-table">
                <thead><tr><th>Species | Variety</th><th>Count</th><th style="text-align:right;">Total KG</th></tr></thead>
                <tbody id="hlso_summary_body"></tbody>
            </table>
        </div>
    </div>
    <div class="summary-card">
        <div class="summary-header" onclick="toggleSum('hoso_box')">
            <h3>HOSO REQUIREMENT SUMMARY</h3>
            <i class="fa fa-chevron-up"></i>
        </div>
        <div id="hoso_box" class="summary-content">
            <table class="sum-table">
                <thead><tr><th>Species | Variety</th><th>Count</th><th style="text-align:right;">Total KG</th></tr></thead>
                <tbody id="hoso_summary_body"></tbody>
            </table>
        </div>
    </div>
</div>

<div class="table-wrap">
    <table id="mainTable">
        <thead>
            <tr>
                <th style="width: 2%;">Sl</th>
                <th>Company</th> <th>PO Number</th>
                <th>Buyer</th>
                <th>Ship Date</th>
                <th>Packing Style</th>
                <th>Brand</th>
                <th>Sps</th>
                <th>Var</th>
                <th>CG %</th>
                <th>WG %</th>
                <th>Grd</th>
                <th>NW Grd</th>
                <th>Pcs</th>
                <th>Ord MC</th>
                <th>Price ($)</th> <th>Exch Rate</th> <th>Stk MC</th>
                <th>Pnd MC</th>
                <th>Net Cnt</th>
                <th>HL Cnt</th>
                <th>HO Cnt</th>
                <th>Ord Qty</th>
                <th>Avl Stk</th>
                <th>Pnd Prd</th>
                <th>Ref Stk</th>
                <th>Stk Util</th>
                <th>Req HL</th>
                <th>Req HO</th>
            </tr>
        </thead>
        <tbody id="tbody">
            {% if rows %}
            {% set sorted_rows = rows|sort(attribute='sl_no') %}
            {% for po, items in sorted_rows|groupby('po_number') %}
                {% for r in items %}
                <tr class="data-row" 
                    data-sl="{{ r.sl_no }}"
                    data-po="{{ po }}" 
                    data-species="{{ r.species }}" 
                    data-variety="{{ r.variety }}" 
                    data-hl-cnt="{{ r.hl_count_calc | round | int }}" 
                    data-ho-cnt="{{ r.hoso_count_calc | round | int }}"
                    data-net-cnt="{{ r.net_count_calc }}"
                    data-r-hl="{{ r.req_hlso_qty }}" 
                    data-r-ho="{{ r.req_hoso_qty }}">
                    
                    {% if loop.first %}
                    <td rowspan="{{ items|length }}" class="po-cell" style="background:#f1f5f9; color:#1e293b;">{{ r.sl_no }}</td>
                    <td rowspan="{{ items|length }}" class="po-cell" style="font-size: 6px; color: #64748b;">{{ r.company_name }}</td> 
                    <td rowspan="{{ items|length }}" class="po-cell">{{ po }}</td>
                    <td rowspan="{{ items|length }}" class="po-cell">{{ r.buyer }}</td>
                    <td rowspan="{{ items|length }}" class="po-cell">{{ r.shipment_date }}</td>
                    {% endif %}
                    
                    <td>{{ r.packing_style }}</td><td>{{ r.brand }}</td><td style="font-weight:700;">{{ r.species }}</td><td>{{ r.variety }}</td>
                    <td>{{ r.count_glaze }}</td><td>{{ r.weight_glaze }}</td><td>{{ r.grade }}</td><td style="background:#f8fafc; font-weight:700;">{{ r.nw_grade or '-' }}</td><td>{{ r.no_of_pieces }}</td>
                    <td class="v-mc">{{ r.no_of_mc }}</td>
                    <td class="currency-col">$ {{ r.selling_price }}</td> <td class="currency-col">₹ {{ r.exchange_rate }}</td> <td class="v-smc">{{ r.stock_mc }}</td><td class="v-ppmc">{{ r.prod_pending_mc }}</td>
                    <td class="calc-col">{{ r.net_count_calc }}</td><td class="calc-col">{{ r.hl_count_calc }}</td><td class="calc-col">{{ r.hoso_count_calc }}</td>
                    <td class="v-ord">{{ r.ordered_qty }}</td><td class="v-avail">{{ r.available_stock }}</td><td class="v-pend">{{ r.pending_production }}</td>
                    <td><span class="stock-btn" data-history='{{ r.ref_json | safe }}' onclick="toggleDetail(this, 'Referral Details')">{{ r.ref_opt_stock }}</span></td>
                    <td><span class="stock-btn" data-history='{{ r.util_json | safe }}' onclick="toggleDetail(this, 'Utilization History')">{{ r.existed_stock_util }}</span></td>
                    <td class="v-hl" style="font-weight:800;">{{ r.req_hlso_qty }}</td><td class="v-ho" style="font-weight:800;">{{ r.req_hoso_qty }}</td>
                </tr>
                <tr class="expand-row" style="display:none;"><td colspan="29" style="padding:0; background:#f8fafc;"><div></div></td></tr>
                {% endfor %}
                <tr class="subtotal-row" data-po-sub="{{ po }}">
                    <td colspan="14" style="text-align:right; padding-right:15px;">TOTAL FOR PO {{ po }}:</td>
                    <td class="s-mc">0</td>
                    <td colspan="2"></td> <td class="s-smc">0</td><td class="s-ppmc">0</td><td colspan="3"></td>
                    <td class="s-ord">0</td><td class="s-avail">0</td><td class="s-pend">0</td><td colspan="2"></td>
                    <td class="s-hl">0</td><td class="s-ho">0</td>
                </tr>
            {% endfor %}
            {% endif %}
        </tbody>
        <tfoot>
            <tr class="grand-total">
                <td colspan="14" style="text-align:right; padding-right:15px;">GRAND TOTAL:</td>
                <td id="gt_mc">0</td><td colspan="7"></td>
                <td id="gt_ord">0</td><td id="gt_avail">0</td><td id="gt_pend">0</td><td colspan="2"></td>
                <td id="gt_hl">0</td><td id="gt_ho">0</td>
            </tr>
        </tfoot>
    </table>
</div>

<script>
function toggleSum(id) {
    const el = document.getElementById(id);
    el.style.display = (el.style.display === "none") ? "block" : "none";
}

function sortTableBySlNo() {
    const tbody = document.getElementById("tbody");
    const rows = Array.from(tbody.children);
    const groups = [];
    let currentGroup = null;

    rows.forEach(row => {
        if (row.classList.contains('data-row') && row.querySelector('.po-cell[rowspan]')) {
            if (currentGroup) groups.push(currentGroup);
            currentGroup = { sl: parseInt(row.getAttribute('data-sl')) || 0, rows: [row] };
        } else if (currentGroup) {
            currentGroup.rows.push(row);
        }
    });
    if (currentGroup) groups.push(currentGroup);

    groups.sort((a, b) => a.sl - b.sl);
    tbody.innerHTML = "";
    groups.forEach(g => g.rows.forEach(r => tbody.appendChild(r)));
}

function calculateTotals() {
    const rows = document.querySelectorAll(".data-row");
    const hlSum = {}; const hoSum = {};
    const poData = {};
    let g = { mc:0, ord:0, avail:0, pend:0, hl:0, ho:0 };

    rows.forEach(row => {
        if (row.style.display === "none") return;
        const po = row.getAttribute("data-po");
        if(!poData[po]) poData[po] = { mc:0, smc:0, ppmc:0, ord:0, avail:0, pend:0, hl:0, ho:0 };
        
        const getV = (cls) => {
            const el = row.querySelector("."+cls);
            if(!el) return 0;
            return parseFloat(el.innerText.replace(/[^0-9.-]/g, '')) || 0;
        };

        const v = {
            mc: getV("v-mc"), smc: getV("v-smc"), ppmc: getV("v-ppmc"),
            ord: getV("v-ord"), avail: getV("v-avail"), pend: getV("v-pend"),
            hl: parseFloat(row.getAttribute("data-r-hl")) || 0,
            ho: parseFloat(row.getAttribute("data-r-ho")) || 0
        };

        Object.keys(v).forEach(k => { poData[po][k] += v[k]; if(g[k] !== undefined) g[k] += v[k]; });

        const keyBase = `${row.getAttribute("data-species")} | ${row.getAttribute("data-variety")}`;
        const hlCnt = Math.round(parseFloat(row.getAttribute("data-hl-cnt")) || 0);
        const hoCnt = Math.round(parseFloat(row.getAttribute("data-ho-cnt")) || 0);
        const netCnt = row.getAttribute("data-net-cnt") || "-";

        if(v.hl > 0) { 
            const k = keyBase + "||" + hlCnt; 
            if(!hlSum[k]) hlSum[k] = { total: 0, details: [] };
            hlSum[k].total += v.hl;
            hlSum[k].details.push({ po: po, qty: v.hl, exact: netCnt });
        }
        if(v.ho > 0) { 
            const k = keyBase + "||" + hoCnt; 
            if(!hoSum[k]) hoSum[k] = { total: 0, details: [] };
            hoSum[k].total += v.ho;
            hoSum[k].details.push({ po: po, qty: v.ho, exact: netCnt });
        }
    });

    document.querySelectorAll(".subtotal-row").forEach(sr => {
        const po = sr.getAttribute("data-po-sub");
        const d = poData[po];
        if(d) {
            sr.querySelector(".s-mc").innerText = d.mc; sr.querySelector(".s-smc").innerText = d.smc;
            sr.querySelector(".s-ord").innerText = d.ord.toFixed(2); sr.querySelector(".s-hl").innerText = d.hl.toFixed(2);
            sr.querySelector(".s-ho").innerText = d.ho.toFixed(2);
            sr.querySelector(".s-avail").innerText = d.avail.toFixed(2);
            sr.querySelector(".s-pend").innerText = d.pend.toFixed(2);
        }
    });

    document.getElementById("gt_mc").innerText = g.mc;
    document.getElementById("gt_ord").innerText = g.ord.toFixed(2);
    document.getElementById("gt_avail").innerText = g.avail.toFixed(2);
    document.getElementById("gt_pend").innerText = g.pend.toFixed(2);
    document.getElementById("gt_hl").innerText = g.hl.toFixed(2);
    document.getElementById("gt_ho").innerText = g.ho.toFixed(2);

    renderSum(hlSum, "hlso_summary_body");
    renderSum(hoSum, "hoso_summary_body");
}

function renderSum(dataObj, containerId) {
    const tbody = document.getElementById(containerId);
    tbody.innerHTML = "";
    let grandTotal = 0;

    Object.keys(dataObj).sort().forEach(key => {
        const [text, count] = key.split("||");
        const data = dataObj[key];
        grandTotal += data.total;
        const drillId = `drill_${containerId}_${key.replace(/[^a-z0-9]/gi, '_')}`;

        tbody.innerHTML += `
            <tr>
                <td>${text}</td>
                <td class="clickable-count" onclick="toggleSumDrill('${drillId}')">${count}</td>
                <td style="text-align:right; font-weight:700; color:var(--accent);">${data.total.toFixed(2)}</td>
            </tr>
            <tr id="${drillId}" class="drill-row" style="display:none;">
                <td colspan="3">
                    <div class="drill-container">
                        <table class="drill-mini-table">
                            <thead><tr><th>PO Number</th><th>Exact Cnt</th><th>Qty (KG)</th></tr></thead>
                            <tbody>
                                ${data.details.map(d => `<tr><td>${d.po}</td><td>${d.exact}</td><td>${d.qty.toFixed(2)}</td></tr>`).join('')}
                            </tbody>
                        </table>
                    </div>
                </td>
            </tr>`;
    });
    
    if(Object.keys(dataObj).length > 0) {
        tbody.innerHTML += `<tr class="sum-total-row"><td colspan="2">TOTAL REQUIREMENT</td><td style="text-align:right;">${grandTotal.toFixed(2)}</td></tr>`;
    }
}

function toggleSumDrill(id) {
    const el = document.getElementById(id);
    el.style.display = (el.style.display === "none") ? "table-row" : "none";
}

function applyFilters() {
    const fPo = document.getElementById("f_po_drop").value.toLowerCase();
    const fSearch = document.getElementById("f_search").value.toLowerCase();
    
    document.querySelectorAll(".data-row").forEach(row => {
        const m = (!fPo || row.getAttribute("data-po").toLowerCase() === fPo) &&
                  (!fSearch || row.innerText.toLowerCase().includes(fSearch));
        row.style.display = m ? "" : "none";
    });
    updateSubtotalsAndStatus();
}

function updateSubtotalsAndStatus() {
    let count = 0;
    document.querySelectorAll(".subtotal-row").forEach(sr => {
        const po = sr.getAttribute("data-po-sub");
        const hasVisibleRows = Array.from(document.querySelectorAll(`.data-row[data-po="${po}"]`)).some(r => r.style.display !== "none");
        sr.style.display = hasVisibleRows ? "" : "none";
        if(hasVisibleRows) count += Array.from(document.querySelectorAll(`.data-row[data-po="${po}"]`)).filter(r => r.style.display !== "none").length;
    });
    document.getElementById("rowCount").innerText = count + " Items Filtered";
    calculateTotals();
}

function resetFilters() {
    document.getElementById("f_po_drop").value = "";
    document.getElementById("f_search").value = "";
    applyFilters();
}

function toggleDetail(el, title) {
    const nextTr = el.closest("tr").nextElementSibling;
    const isVisible = nextTr.style.display === "table-row";
    nextTr.style.display = isVisible ? "none" : "table-row";
    
    if(!isVisible) {
        const history = JSON.parse(el.getAttribute("data-history") || "[]");
        let h = `
            <div class="detail-container">
                <div class="detail-title"><i class="fa fa-info-circle"></i> ${title}</div>
                <table class="corp-table">
                    <thead><tr><th>Source / Ref</th><th>Opening (KG)</th><th>Utilized (KG)</th><th>Balance (KG)</th></tr></thead>
                    <tbody>`;
        if(history.length === 0) h += `<tr><td colspan="4" style="text-align:center;">No Records Found</td></tr>`;
        history.forEach(i => {
            const bal = parseFloat(i.balance);
            const balClass = bal < 0 ? "txt-red" : "txt-green";
            h += `<tr>
                <td><span class="badge-po">${i.po_no}</span></td>
                <td>${i.available}</td>
                <td class="txt-red">-${i.utilized}</td>
                <td class="${balClass}">${bal.toFixed(2)}</td>
            </tr>`;
        });
        nextTr.querySelector("div").innerHTML = h + `</tbody></table></div>`;
    }
}

window.onload = () => {
    sortTableBySlNo();
    calculateTotals();
    document.getElementById("rowCount").innerText = document.querySelectorAll(".data-row").length + " Total Items";
};
</script>
</body>
</html>