<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>SOAKING REPORT</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
:root{
  --primary:#003366;
  --light:#f3f7ff;
  --border:#cfd9ea;
  --card:#ffffff;
}
*{box-sizing:border-box;font-family:Arial,sans-serif}
body{margin:0;padding:18px;background:var(--light)}

.page-title{
  text-align:center;font-size:22px;font-weight:700;
  color:var(--primary);margin-bottom:15px
}

/* FILTERS */
.filters{
  display:flex;gap:10px;flex-wrap:wrap;
  background:var(--card);border:1px solid var(--border);
  padding:12px;border-radius:8px;
  max-width:1400px;margin:0 auto 12px;
}
.fbox{display:flex;flex-direction:column;gap:4px}
.fbox label{font-size:12px;font-weight:700;color:var(--primary)}
select,input[type=date]{
  padding:7px;border:1px solid var(--border);
  border-radius:5px;min-width:150px;font-size:13px
}
#searchBox{
  padding:8px;width:260px;
  border:1px solid var(--border);
  border-radius:5px;font-size:13px
}

/* ACTION BAR */
.actions{
  max-width:1400px;margin:8px auto;
  display:flex;justify-content:space-between;align-items:center
}
#rowCount{font-size:13px;color:#444}

/* MENU */
.menu-box{position:relative}
.dots{
  width:36px;height:36px;background:var(--primary);
  color:#fff;border-radius:6px;
  display:flex;align-items:center;justify-content:center;
  font-size:20px;cursor:pointer
}
.menu-list{
  position:absolute;right:0;top:42px;
  width:220px;background:#fff;
  border-radius:8px;border:1px solid #ddd;
  display:none;z-index:999;
  box-shadow:0 8px 22px rgba(0,0,0,.12)
}
.menu-list div{
  padding:10px;font-size:14px;
  border-bottom:1px solid #f0f0f0;
  cursor:pointer
}
.menu-list div:hover{background:#eef5ff}

/* TABLE */
.table-wrap{
  max-width:1400px;margin:0 auto;
  background:#fff;border-radius:10px;
  overflow:auto;border:1px solid #dce6f4;
  box-shadow:0 6px 22px rgba(0,0,0,.06)
}
table{width:100%;border-collapse:collapse;min-width:1200px}
thead th{
  background:var(--primary);color:#fff;
  padding:10px;font-size:13px;position:sticky;top:0
}
tbody td{
  padding:8px;font-size:13px;
  border-bottom:1px solid #eee;white-space:nowrap
}
tbody tr:hover{background:#eef6ff}
tfoot td{
  padding:10px;font-weight:700;
  background:#f8fbff;border-top:2px solid #c4d1e0
}
</style>
</head>

<body>

<div class="page-title">SOAKING REPORT</div>

<!-- FILTERS -->
<div class="filters">
  <div class="fbox"><label>From Date</label><input type="date" id="f_from"></div>
  <div class="fbox"><label>To Date</label><input type="date" id="f_to"></div>

  <div class="fbox"><label>Batch</label>
    <select id="f_batch">
      <option value="">All</option>
      {% for b in batches %}<option>{{b}}</option>{% endfor %}
    </select>
  </div>

  <div class="fbox"><label>Count</label>
    <select id="f_count">
      <option value="">All</option>
      {% for c in counts %}<option>{{c}}</option>{% endfor %}
    </select>
  </div>

  <div class="fbox"><label>Chemical</label>
    <select id="f_chemical">
      <option value="">All</option>
      {% for c in chemicals %}<option>{{c}}</option>{% endfor %}
    </select>
  </div>

  <input id="searchBox" placeholder="Search batch / chemical">
</div>

<!-- ACTIONS -->
<div class="actions">
  <div id="rowCount">0 rows</div>
  <div class="menu-box">
    <div class="dots" id="dotsBtn">‚ãÆ</div>
    <div class="menu-list" id="menu">
      <div onclick="editSelected()">‚úèÔ∏è Edit Selected</div>
      <div onclick="deleteSelected()">üóë Delete Selected</div>
      <div onclick="printTable()">üñ® Print</div>
      <div onclick="exportExcel()">üìä Export Excel</div>
    </div>
  </div>
</div>

<!-- TABLE -->
<div class="table-wrap">
<table>
<thead>
<tr>
  <th><input type="checkbox" id="chk_all"></th>
  <th>ID</th>
  <th>Date</th>
  <th>Batch</th>
  <th>Count</th>
  <th>Qty (Kg)</th>
  <th>Chemical</th>
  <th>Chem %</th>
  <th>Chem Qty</th>
  <th>Salt %</th>
  <th>Salt Qty</th>
</tr>
</thead>

<tbody id="tbody">
{% for r in rows %}
<tr data-id="{{r.id}}">
  <td><input type="checkbox" class="rowCheck"></td>
  <td>{{r.id}}</td>
  <td>{{r.date}}</td>
  <td>{{r.batch_number}}</td>
  <td>{{r.in_count}}</td>
  <td class="qty">{{r.in_qty}}</td>
  <td>{{r.chemical_name}}</td>
  <td>{{r.chemical_percent}}</td>
  <td class="chem">{{(r.in_qty * r.chemical_percent / 100) | round(2)}}</td>
  <td>{{r.salt_percent}}</td>
  <td class="salt">{{(r.in_qty * r.salt_percent / 100) | round(2)}}</td>
</tr>
{% endfor %}
</tbody>

<tfoot>
<tr>
  <td colspan="5">TOTAL</td>
  <td id="tot_qty">0</td>
  <td colspan="2"></td>
  <td id="tot_chem">0</td>
  <td></td>
  <td id="tot_salt">0</td>
</tr>
</tfoot>
</table>
</div>

<script>
const rows=[...document.querySelectorAll("#tbody tr")];
const num=v=>parseFloat(v)||0;

/* MENU */
dotsBtn.onclick=e=>{
 e.stopPropagation();
 menu.style.display=menu.style.display==="block"?"none":"block";
};
document.onclick=()=>menu.style.display="none";

/* TOTALS */
function totals(v){
 let q=0,c=0,s=0;
 v.forEach(r=>{
  q+=num(r.querySelector(".qty").innerText);
  c+=num(r.querySelector(".chem").innerText);
  s+=num(r.querySelector(".salt").innerText);
 });
 tot_qty.innerText=q.toFixed(2);
 tot_chem.innerText=c.toFixed(2);
 tot_salt.innerText=s.toFixed(2);
}

/* FILTER */
function applyFilters(){
 let vis=[];
 rows.forEach(r=>{
  let ok=true;
  if(f_batch.value && r.children[3].innerText!==f_batch.value) ok=false;
  if(f_count.value && r.children[4].innerText!==f_count.value) ok=false;
  if(f_chemical.value && r.children[6].innerText!==f_chemical.value) ok=false;
  if(searchBox.value && !r.innerText.toLowerCase().includes(searchBox.value.toLowerCase())) ok=false;
  r.style.display=ok?"":"none";
  if(ok) vis.push(r);
 });
 rowCount.innerText=`${vis.length} rows`;
 totals(vis);
}
[f_batch,f_count,f_chemical].forEach(e=>e.onchange=applyFilters);
searchBox.oninput=applyFilters;
applyFilters();

/* ACTIONS */
const ids=()=>[...document.querySelectorAll(".rowCheck:checked")].map(c=>c.closest("tr").dataset.id);
function editSelected(){if(ids().length!==1)alert("Select one");else location=`/processing/soaking/edit/${ids()[0]}`;}
function deleteSelected(){alert("Delete API");}
function printTable(){window.print();}
function exportExcel(){location=`/reports/soaking/export_excel?ids=${ids().join(",")}`;}
</script>

</body>
</html>
