<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>GATE ENTRY REPORT - BKNR SOLUTIONS</title>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<style>
    /* RMP Color Scheme */
    :root{
      --accent:#003366;
      --muted:#a3bcd6;
      --light:#eaf4ff;
    }
    
    *{box-sizing:border-box}
    body { font-family:Arial,sans-serif; background:var(--light); margin:0; padding:0; }
    h2 { text-align:center; color:var(--accent); margin:20px 0; font-weight:700; font-size: 20px;}

    /* RMP FILTER / CONTROLS Structure */
    .controls { /* Changed from .filter-container */
        width:92%; max-width:1200px;
        margin:10px auto;
        display:flex; gap:10px; flex-wrap:wrap;
        align-items:center; /* Align items to center */
    }
    .filter { /* Changed from .filter-item */
        display:flex; flex-direction:column;
        width:19%; /* 5 filters across, slightly less than 20% to account for gap */
        min-width:140px;
    }
    .filter label { /* Label style like RMP */
        font-weight:600; color:var(--accent); margin-bottom:6px; font-size:13px;
    }
    .filter select { /* Select style like RMP */
        padding:8px; border:1px solid var(--muted); border-radius:6px;
        background:#fff; font-size:14px;
    }
    
    /* ACTION BAR + 3 DOT MENU (Kept mostly same, using RMP colors) */
    .action-bar {
        width:92%; max-width:1200px;
        margin:5px auto; display:flex; align-items:center; justify-content:flex-end;
    }
    .dots {
        background:var(--accent); color:white; /* RMP accent color */
        width:38px; height:38px; border-radius:8px;
        cursor:pointer; display:flex; justify-content:center;
        align-items:center; font-size:24px; margin-left:8px;
    }
    .menu-box {
        position:absolute; top:42px; right:0;
        background:white; border:1px solid #ddd; /* Lighter border */
        border-radius:6px; width:160px; display:none;
        box-shadow:0 6px 18px rgba(0,0,0,0.12); /* Softer shadow */
        z-index: 100;
    }
    .menu-box div {
        padding:10px; cursor:pointer; font-size:14px;
        border-bottom:1px solid #eee;
    }
    .menu-box div:hover { background:#f0f8ff; } /* RMP hover color */

    /* TABLE EXACTLY LIKE RMP */
    .table-container { /* Changed from .table-wrap, using RMP's box-shadow */
        width:92%; max-width:1200px;
        margin:10px auto 30px;
        overflow-x:auto;
        background:#fff; /* White background */
        border-radius:8px;
        box-shadow:0 4px 14px rgba(0,0,0,0.06); /* RMP shadow */
        min-width:1100px;
    }
    table {
        width:100%; border-collapse:collapse;
        overflow:hidden;
    }
    th,td { padding:9px 10px; border-bottom:1px solid #eee; font-size:13px; white-space:nowrap; } /* Padding and border like RMP */
    th { background:var(--accent); color:white; text-align:left; position: sticky; top: 0; z-index: 10;} /* Sticky header like RMP */
    tr:hover { background:#f5fbff; cursor:pointer; } /* RMP hover color */
    tr.selected { background:#cfe9ff !important; } /* RMP selected color */
    
    /* FOOTER TOTALS LIKE RMP */
    tfoot td { font-weight:700; background:#f8fbff; padding:10px; border-top: 2px solid var(--muted); }

    /* Responsive adjustments for filters */
    @media(max-width:1000px){ .filter { width:48%; } } /* Changed from .filter-item */
    @media(max-width:500px){ .filter { width:100%; } } /* Changed from .filter-item */
</style>
</head>

<body>

<h2>GATE ENTRY REPORT</h2>

<form id="filterForm" method="GET" action="/reports/gate_entry_report">
    <div class="controls"> 

        <div class="filter">
            <label>Batch</label>
            <select id="f_batch" name="batch">
                <option value="">All</option>
                {% for b in batches %}
                <option value="{{ b }}" {% if selected_batch == b %}selected{% endif %}>{{ b }}</option>
                {% endfor %}
            </select>
        </div>

        <div class="filter">
            <label>Challan</label>
            <select id="f_challan" name="challan">
                <option value="">All</option>
                {% for c in challans %}
                <option value="{{ c }}" {% if selected_challan == c %}selected{% endif %}>{{ c }}</option>
                {% endfor %}
            </select>
        </div>

        <div class="filter">
            <label>Gate Pass</label>
            <select id="f_gatepass" name="gatepass">
                <option value="">All</option>
                {% for g in gates %}
                <option value="{{ g }}" {% if selected_gatepass == g %}selected{% endif %}>{{ g }}</option>
                {% endfor %}
            </select>
        </div>

        <div class="filter">
            <label>Supplier</label>
            <select id="f_supplier" name="supplier">
                <option value="">All</option>
                {% for s in suppliers %}
                <option value="{{ s }}" {% if selected_supplier == s %}selected{% endif %}>{{ s }}</option>
                {% endfor %}
            </select>
        </div>

        <div class="filter">
            <label>Date</label>
            <select id="f_date" name="date">
                <option value="">All</option>
                {% for d in dates %}
                <option value="{{ d }}" {% if selected_date == d %}selected{% endif %}>{{ d }}</option>
                {% endfor %}
            </select>
        </div>

    </div>
</form>

<div class="action-bar">
    <span id="rowCount" style="font-size:13px; color:#555;">Showing 0 rows</span>
    <div style="position:relative; display:inline-block;">
        <div class="dots" onclick="toggleMenu()">‚ãÆ</div>
        <div class="menu-box" id="menu">
            <div onclick="editRow()">‚úè Edit Selected</div>
            <div onclick="deleteSelectedRows()">üóë Delete Selected</div>
            <div onclick="printSelectedRow()">üñ® Print Selected</div>
            <div onclick="pdfSelectedRow()">üìÑ Export PDF Selected</div>
            <div onclick="excelSelectedRow()">üìä Export Excel Selected</div>
        </div>
    </div>
</div>

<div class="table-container">
<table id="reportTable">
<thead>
<tr>
    <th style="width:36px;"><input type="checkbox" id="chk_all" title="Select all visible rows"></th>
    <th>ID</th>
    <th>Batch</th>
    <th>Challan</th>
    <th>Gate Pass</th>
    <th>Supplier</th>
    <th>Location</th>
    <th>Vehicle</th>
    <th>Material Boxes</th>
    <th>Empty</th>
    <th>Ice</th>
    <th>Date</th>
    <th>Time</th>
    <th>Email</th>
</tr>
</thead>

<tbody id="tbody">
{% for row in data %}
<tr data-id="{{ row.id }}">
    <td><input type="checkbox" class="rowCheck"></td>
    <td>{{ row.id }}</td>
    <td>{{ row.batch_number }}</td>
    <td>{{ row.challan_number }}</td>
    <td>{{ row.gate_pass_number }}</td>
    <td>{{ row.supplier_name }}</td>
    <td>{{ row.purchasing_location }}</td>
    <td class="col-vehicle">{{ row.vehicle_number }}</td>
    <td class="col-material">{{ row.no_of_material_boxes or 0 }}</td>
    <td class="col-empty">{{ row.no_of_empty_boxes or 0 }}</td>
    <td class="col-ice">{{ row.no_of_ice_boxes or 0 }}</td>
    <td>{{ row.date }}</td>
    <td>{{ row.time }}</td>
    <td>{{ row.email }}</td>
</tr>
{% endfor %}
</tbody>

<tfoot>
    <tr>
        <td colspan="7">Totals</td> 
        <td id="tot_material">0</td> 
        <td id="tot_empty">0</td>    
        <td id="tot_ice">0</td>      
        <td colspan="3"></td>        
    </tr>
</tfoot>
</table>
</div>

<script>
const filterForm = document.getElementById("filterForm");
const tbody = document.getElementById("tbody");
const rowsAll = Array.from(tbody.querySelectorAll('tr')); // All rows in DOM (current filtered set)
const chk_all = document.getElementById('chk_all');
const rowCountEl = document.getElementById('rowCount');

// Total Elements
const tot_material = document.getElementById("tot_material");
const tot_empty = document.getElementById("tot_empty");
const tot_ice = document.getElementById("tot_ice");

// Utility function to convert text to number
function toNum(v){ return parseFloat(String(v).replace(/,/g,'')) || 0; }

/* -------------------------
    TOTALS CALCULATION
    ------------------------- */
function computeTotals(){
    let t_material = 0;
    let t_empty = 0;
    let t_ice = 0;
    let visibleRowCount = 0;

    // Iterate over all rows in the DOM (which are the current filtered data)
    rowsAll.forEach(r => {
        // Find cells by class name
        const materialCell = r.querySelector('.col-material');
        const emptyCell = r.querySelector('.col-empty');
        const iceCell = r.querySelector('.col-ice');

        if (materialCell) t_material += toNum(materialCell.innerText);
        if (emptyCell) t_empty += toNum(emptyCell.innerText);
        if (iceCell) t_ice += toNum(iceCell.innerText);
        visibleRowCount++;
    });

    // Update footer cells
    tot_material.innerText = t_material.toFixed(0);
    tot_empty.innerText = t_empty.toFixed(0);
    tot_ice.innerText = t_ice.toFixed(0);
    
    // Update row count display
    rowCountEl.innerText = `Showing ${visibleRowCount} rows`;
}

/* -------------------------
    MULTI-SELECTION LOGIC
    ------------------------- */

// Helper to get all IDs of currently selected rows
function getSelectedIds(){
    // Select all checkboxes with class 'rowCheck' that are checked
    return Array.from(document.querySelectorAll('#tbody .rowCheck:checked'))
             .map(cb => cb.closest('tr').dataset.id);
}

// Master Checkbox Logic
chk_all.addEventListener('change', function(){
    const on = this.checked;
    
    // Since we are using server-side filtering, all rows in rowsAll are visible/filtered.
    rowsAll.forEach(r=>{
        const cb = r.querySelector('.rowCheck');
        cb.checked = on;
        r.classList.toggle('selected', on);
    });
});

// Row Click and Individual Checkbox Logic
rowsAll.forEach(row=>{
    // Click row toggles only that row's checkbox and selection class
    row.addEventListener('click', function(e){
        // Do not toggle if the click target is the checkbox itself
        if(e.target.tagName.toLowerCase() === 'input') return;
        
        const cb = this.querySelector('.rowCheck');
        cb.checked = !cb.checked;
        this.classList.toggle('selected', cb.checked);
        
        // Update master checkbox status (optional, but good practice)
        if (!cb.checked) {
            chk_all.checked = false;
        } else if (getSelectedIds().length === rowsAll.length) {
            chk_all.checked = true;
        }
    });

    // Individual checkbox change highlights row
    const cb = row.querySelector('.rowCheck');
    cb.addEventListener('change', function(){
        const tr = this.closest('tr');
        tr.classList.toggle('selected', this.checked);

        // Update master checkbox status
        if (!this.checked) {
            chk_all.checked = false;
        } else if (getSelectedIds().length === rowsAll.length) {
            chk_all.checked = true;
        }
    });
});


/* -------------------------
    MENU and ACTIONS
    ------------------------- */
function toggleMenu(){
    let m = document.getElementById("menu");
    m.style.display = m.style.display==="block" ? "none":"block";
}
document.addEventListener('click', (e)=> {
    const dotsBtn = document.querySelector('.dots');
    const menu = document.getElementById("menu");
    if(!dotsBtn.contains(e.target) && !menu.contains(e.target)) {
        menu.style.display='none';
    }
});

// EDIT (Only allows editing if exactly one row is selected)
function editRow(){
    const ids = getSelectedIds();
    if(ids.length === 0) return Swal.fire('Select exactly one row to edit.', '', 'warning');
    if(ids.length > 1) return Swal.fire('Please select only one row to edit.', '', 'warning');
    
    const id = ids[0];
    window.location = `/processing/gate_entry/edit/${id}`;
}

// DELETE SELECTED ROWS (Changed from single delete)
async function deleteSelectedRows(){
    const ids = getSelectedIds();
    if(!ids.length) return Swal.fire('Select one or more rows to delete.', '', 'warning');

    const ok = await Swal.fire({ 
        title: `Delete ${ids.length} records?`, 
        text: "You won't be able to revert this!",
        icon:'warning', 
        showCancelButton:true, 
        confirmButtonText:'Yes, delete them!' 
    });
    if(!ok.isConfirmed) return;

    // Assuming your server expects a list of IDs for mass deletion
    // If your server endpoint only handles single ID deletion: 
    // You would loop through ids and make multiple fetch calls here.

    // If your server supports batch deletion (recommended):
    try {
        const response = await fetch(`/processing/gate_entry/delete_batch`, { 
            method:"POST",
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ ids: ids })
        });
        
        if (response.ok) {
            Swal.fire('Deleted!', `${ids.length} records have been deleted.`, 'success')
                .then(() => location.reload()); // Reload page to show updated data
        } else {
            Swal.fire('Error', 'Deletion failed on the server.', 'error');
        }
    } catch(error) {
        Swal.fire('Error', 'Network or server error during deletion.', 'error');
    }
}

// PRINT/EXPORT (Modified to handle selected IDs, although usually exports use ALL filtered data)
function printSelectedRow(){
    const ids = getSelectedIds();
    if(ids.length === 0) return Swal.fire('Select rows first.', '', 'warning');
    // Assuming API takes comma-separated IDs or first ID
    window.open(`/reports/gate_entry/print_selected?ids=${ids.join(',')}`, "_blank");
}

function pdfSelectedRow(){
    const ids = getSelectedIds();
    if(ids.length === 0) return Swal.fire('Select rows first.', '', 'warning');
    window.location = `/reports/gate_entry/export_pdf_selected?ids=${ids.join(',')}`;
}

function excelSelectedRow(){
    const ids = getSelectedIds();
    if(ids.length === 0) return Swal.fire('Select rows first.', '', 'warning');
    window.location = `/reports/gate_entry/export_xlsx_selected?ids=${ids.join(',')}`;
}

/* FILTER AUTO APPLY */
document.querySelectorAll(".controls select").forEach(s=>{
    s.addEventListener("change", ()=>{
        filterForm.submit(); 
    });
});

// Initial call to compute totals when the page loads
document.addEventListener("DOMContentLoaded", computeTotals);

</script>

</body>
</html>