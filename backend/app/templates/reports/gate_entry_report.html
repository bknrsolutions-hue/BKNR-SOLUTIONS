<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>GATE ENTRY REPORT - BKNR SOLUTIONS</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
    :root {
        --accent:#003366;
        --muted:#a3bcd6;
        --light:#eaf4ff;
    }

    body {
        font-family: Arial, sans-serif;
        background: var(--light);
        margin: 0;
        padding: 0;
    }

    header {
        text-align:left;
        padding:18px 20px;
        font-size:22px;
        font-weight:700;
        color:var(--accent);
    }

    /* FILTER SECTION */
    .controls {
        width:96%; 
        max-width:1200px;
        margin:10px auto;
        display:flex;
        gap:10px;
        flex-wrap:wrap;
    }

    .filter {
        width:15%;
        min-width:100px;
        display:flex;
        flex-direction:column;
    }

    .filter label {
        font-size:13px;
        font-weight:600;
        margin-bottom:4px;
        color:var(--accent);
    }

    .filter select,
    .filter input {
        padding:7px;
        border:1px solid var(--muted);
        border-radius:6px;
        background:white;
    }

    .controls .right {
        margin-left:auto;
        display:flex;
        align-items:center;
    }

    /* ACTION BAR */
    .action-bar {
        width:96%; 
        max-width:1200px; 
        margin:10px auto;
        display:flex;
        align-items:center;
        justify-content:space-between;
    }

    .menu-box { position:relative; }

    .dots {
        background:var(--accent);
        color:white;
        font-size:22px;
        padding:6px 12px;
        cursor:pointer;
        border-radius:6px;
    }

    .menu-list {
        position:absolute;
        right:0;
        top:40px;
        background:#fff;
        border:1px solid #ccc;
        border-radius:6px;
        width:170px;
        display:none;
        box-shadow:0 6px 18px rgba(0,0,0,0.15);
        z-index:10;
    }

    .menu-list div {
        padding:10px;
        cursor:pointer;
        font-size:14px;
        border-bottom:1px solid #eee;
    }
    .menu-list div:hover {
        background:#eaf4ff;
    }

    /* TABLE */
    .table-wrap {
        width:96%; 
        max-width:1200px;
        margin:10px auto;
        background:#fff;
        border-radius:8px;
        overflow:auto;
        box-shadow:0 4px 14px rgba(0,0,0,0.1);
    }

    table {
        width:100%;
        border-collapse:collapse;
    }

    /* HEADER WRAP TEXT */
    th {
        background:#003366;
        color:white;
        padding:6px 8px;
        border-bottom:1px solid #ddd;
        white-space:normal;
        word-wrap:break-word;
        font-size:12px;
        text-align:left;
        position:sticky;
        top:0;
        z-index:5;
        line-height:14px;
    }

    /* ROW HEIGHT SMALL */
    td {
        padding:4px 8px;
        border-bottom:1px solid #eee;
        white-space:nowrap;
        overflow:hidden;
        text-overflow:ellipsis;
        font-size:12px;
        line-height:16px;
    }

    tfoot td {
        font-weight:bold;
        background:#f2f7ff;
        padding:6px;
        font-size:13px;
    }

    tr:hover { background:#f0f8ff; cursor:pointer; }
    tr.selected { background:#cfe9ff !important; }

    /* PAGINATION */
    .pager {
        width:96%; max-width:1200px;
        margin:10px auto 40px;
        display:flex;
        justify-content:space-between;
    }

    .pager button {
        padding:6px;
        border:1px solid #ccc;
        border-radius:6px;
        background:white;
        cursor:pointer;
    }

    .pager button.current {
        background:var(--accent);
        color:white;
    }
</style>
</head>

<body>

<header>Gate Entry Report</header>

<!-- ================= FILTERS ================= -->
<div class="controls">

    <div class="filter">
        <label>Batch Number</label>
        <select id="flt_batch">
            <option value="">All</option>
            {% for b in batches %}
            <option value="{{ b }}">{{ b }}</option>
            {% endfor %}
        </select>
    </div>

    <div class="filter">
        <label>Challan Number</label>
        <select id="flt_challan">
            <option value="">All</option>
            {% for c in challans %}
            <option value="{{ c }}">{{ c }}</option>
            {% endfor %}
        </select>
    </div>

    <div class="filter">
        <label>Supplier Name</label>
        <select id="flt_supplier">
            <option value="">All</option>
            {% for s in suppliers %}
            <option value="{{ s }}">{{ s }}</option>
            {% endfor %}
        </select>
    </div>

    <div class="filter">
        <label>Gate Pass Number</label>
        <select id="flt_gatepass">
            <option value="">All</option>
            {% for g in gates %}
            <option value="{{ g }}">{{ g }}</option>
            {% endfor %}
        </select>
    </div>

    <!-- üî• DATE RANGE FILTER -->
    <div class="filter">
        <label>From Date</label>
        <input type="date" id="flt_from">
    </div>

    <div class="filter">
        <label>To Date</label>
        <input type="date" id="flt_to">
    </div>

    <div class="right">
        <input id="quickSearch" placeholder="Search anything..." 
        style="padding:8px;width:250px;border-radius:6px;border:1px solid var(--muted)">
    </div>

</div>

<!-- ================= ACTION BAR ================= -->
<div class="action-bar">
    <div id="rowCount">Showing 0 rows</div>

    <div class="menu-box">
        <div class="dots" onclick="toggleMenu()">‚ãÆ</div>

        <div class="menu-list" id="menuList">
            <div onclick="editSelected()">‚úè Edit Selected</div>
            <div onclick="deleteSelected()">üóë Delete Selected</div>
            <div onclick="printSelected()">üñ® Print Selected</div>
            <div onclick="pdfSelected()">üìÑ Export PDF</div>
            <div onclick="excelSelected()">üìä Export Excel</div>
        </div>
    </div>
</div>

<!-- ================= TABLE ================= -->
<div class="table-wrap">
<table id="gateTable">
<thead>
<tr>
    <th><input type="checkbox" id="chk_all"></th>
    <th>ID</th>
    <th>Date</th>
    <th>Time</th>
    <th>Batch Number</th>
    <th>Challan Number</th>
    <th>Gate Pass Number</th>
    <th>Supplier Name</th>
    <th>Purchasing Location</th>
    <th>Vehicle Number</th>
    <th>Material Boxes</th>
    <th>Empty Boxes</th>
    <th>Ice Boxes</th>
    <th>Email</th>
    <th>Company ID</th>
</tr>
</thead>

<tbody id="reportBody">
{% for r in rows %}
<tr data-id="{{ r.id }}">
    <td><input type="checkbox" class="rowCheck"></td>
    <td>{{ r.id }}</td>
    <td>{{ r.date }}</td>
    <td>{{ r.time.strftime("%H:%M:%S") }}</td>
    <td>{{ r.batch_number }}</td>
    <td>{{ r.challan_number }}</td>
    <td>{{ r.gate_pass_number }}</td>
    <td>{{ r.supplier_name }}</td>
    <td>{{ r.purchasing_location }}</td>
    <td>{{ r.vehicle_number }}</td>
    <td>{{ r.no_of_material_boxes }}</td>
    <td>{{ r.no_of_empty_boxes }}</td>
    <td>{{ r.no_of_ice_boxes }}</td>
    <td>{{ r.email }}</td>
    <td>{{ r.company_id }}</td>
</tr>
{% endfor %}
</tbody>

<!-- üî• SUBTOTAL -->
<tfoot>
<tr>
    <td></td>
    <td colspan="9" style="text-align:right;">TOTAL BOXES :</td>
    <td id="sub_material">0</td>
    <td id="sub_empty">0</td>
    <td id="sub_ice">0</td>
    <td colspan="2"></td>
</tr>
</tfoot>

</table>
</div>

<!-- ================= SCRIPT ================= -->
<script>

const rows = Array.from(document.querySelectorAll("#reportBody tr"));
const batch = document.getElementById("flt_batch");
const challan = document.getElementById("flt_challan");
const supplier = document.getElementById("flt_supplier");
const gatepass = document.getElementById("flt_gatepass");
const flt_from = document.getElementById("flt_from");
const flt_to = document.getElementById("flt_to");
const search = document.getElementById("quickSearch");
const chk_all = document.getElementById("chk_all");

/* MENU */
function toggleMenu(){
    let m = document.getElementById("menuList");
    m.style.display = m.style.display==="block" ? "none" : "block";
}
window.onclick = e=>{
    if(!e.target.closest(".menu-box"))
        document.getElementById("menuList").style.display="none";
};

/* SELECTED ROWS */
function getSelected(){
    return Array.from(document.querySelectorAll(".rowCheck:checked"))
        .map(cb => cb.closest("tr").dataset.id);
}

chk_all.onclick = ()=>{
    let on = chk_all.checked;
    rows.forEach(r=>{
        let cb = r.querySelector(".rowCheck");
        cb.checked = on;
        r.classList.toggle("selected", on);
    });
};

/* EDIT */
function editSelected(){
    let ids = getSelected();
    if(ids.length !== 1) return alert("Select 1 row to edit");
    window.location = `/processing/gate_entry/edit/${ids[0]}`;
}

/* DELETE */
async function deleteSelected(){
    let ids = getSelected();
    if(ids.length === 0) return alert("Select rows to delete");

    if(!confirm("Delete selected rows?")) return;

    await fetch("/reports/gate_entry/delete", {
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body: JSON.stringify({ids})
    });

    location.reload();
}

/* PRINT */
function printSelected(){
    let ids = getSelected();
    if(ids.length === 0) return alert("Select rows");

    window.open(`/reports/gate_entry/print?ids=${ids.join(",")}`, "_blank");
}

/* EXPORT PDF */
function pdfSelected(){
    let ids = getSelected();
    if(ids.length === 0) return alert("Select rows");
    window.location = `/reports/gate_entry/export_pdf?ids=${ids.join(",")}`;
}

/* EXCEL */
function excelSelected(){
    let ids = getSelected();
    if(ids.length === 0) return alert("Select rows");
    window.location = `/reports/gate_entry/export_xlsx?ids=${ids.join(",")}`;
}

/* SUBTOTAL CALC */
function calculateSubtotal(){
    let mat=0, emp=0, ice=0;

    rows.forEach(r=>{
        if(r.style.display !== "none"){
            mat += parseInt(r.children[10].innerText) || 0;
            emp += parseInt(r.children[11].innerText) || 0;
            ice += parseInt(r.children[12].innerText) || 0;
        }
    });

    document.getElementById("sub_material").innerText = mat;
    document.getElementById("sub_empty").innerText = emp;
    document.getElementById("sub_ice").innerText = ice;
}

/* FILTERS */
function applyFilters(){
    rows.forEach(r => {
        let ok = true;
        let rowDate = r.children[2].innerText;

        if(flt_from.value && rowDate < flt_from.value) ok=false;
        if(flt_to.value && rowDate > flt_to.value) ok=false;

        if(batch.value && r.children[4].innerText !== batch.value) ok=false;
        if(challan.value && r.children[5].innerText !== challan.value) ok=false;
        if(supplier.value && r.children[7].innerText !== supplier.value) ok=false;
        if(gatepass.value && r.children[6].innerText !== gatepass.value) ok=false;

        if(search.value.trim() && 
           !r.innerText.toLowerCase().includes(search.value.toLowerCase()))
            ok=false;

        r.style.display = ok ? "" : "none";
    });

    calculateSubtotal();
}

document.querySelectorAll(".controls select").forEach(s=>{
    s.onchange = applyFilters;
});
flt_from.onchange = applyFilters;
flt_to.onchange = applyFilters;
search.oninput = applyFilters;

applyFilters();

</script>

</body>
</html>
