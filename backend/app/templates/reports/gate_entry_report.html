<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Gate Entry Report ‚Äì BKNR ERP</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
:root{
  --border:#d6dde7;
  --bg:#f4f6f9;
  --card:#ffffff;
  --text:#1f2937;
  --primary:#003366;
}
*{box-sizing:border-box;font-family:Segoe UI,Arial,sans-serif}
body{margin:0;background:var(--bg);color:var(--text)}

/* ================= HEADER ================= */
.header{
  position:sticky;
  top:0;
  z-index:100;
  background:var(--bg);
  padding:16px 18px 12px;
  border-bottom:1px solid var(--border);
}
.header h2{margin:0;font-size:22px;color:var(--primary)}
.header p{margin:4px 0 0;font-size:12px;color:#6b7280}

/* ================= FILTERS ================= */
.filters{
  margin-top:12px;
  background:#fff;
  padding:12px;
  border-radius:10px;
  border:1px solid var(--border);
  display:grid;
  grid-template-columns:repeat(4,1fr);
  gap:12px;
}
.filters label{
  font-size:12px;
  font-weight:600;
}
.filters select,
.filters input{
  margin-top:6px;
  padding:6px;
  border-radius:6px;
  border:1px solid var(--border);
  font-size:12px;
}

/* ================= ACTION BAR ================= */
.actions{
  margin-top:10px;
  display:flex;
  justify-content:space-between;
  align-items:center;
}
#rowCount{font-size:12px;font-weight:600}

.menu{position:relative}
.menu-btn{
  border:1px solid var(--border);
  background:#fff;
  border-radius:6px;
  padding:4px 10px;
  cursor:pointer;
  font-size:16px;
}
.menu-list{
  display:none;
  position:absolute;
  right:0;
  top:36px;
  background:#fff;
  border:1px solid var(--border);
  border-radius:8px;
  min-width:180px;
  z-index:50;
}
.menu-list div{
  padding:8px 12px;
  font-size:12px;
  cursor:pointer;
}
.menu-list div:hover{background:#f1f5f9}

/* ================= TABLE CARD ================= */
.section{
  margin:20px 18px;
  background:#fff;
  padding:14px;
  border-radius:12px;
  border:1px solid var(--border);
}
.table-wrap{
  overflow:auto;
  max-height:520px;
}

table{
  width:100%;
  border-collapse:collapse;
  table-layout:fixed;
}
th,td{
  border-bottom:1px solid #edf2f7;
  padding:6px;
  font-size:11px;
  text-align:left;
  word-wrap:break-word;
}
th{
  background:#f1f5f9;
  position:sticky;
  top:0;
  z-index:2;
  font-weight:700;
}

tr:hover{background:#f8fbff}
tr.selected{background:#e0efff !important}

tfoot td{
  background:#fafafa;
  font-weight:700;
}
</style>
</head>

<body>

<div class="header">
  <h2>Gate Entry Report</h2>
  <p>Inbound material ¬∑ supplier wise gate entries</p>

  <!-- FILTERS -->
  <div class="filters">
    <div>
      <label>Batch Number</label>
      <select id="flt_batch">
        <option value="">All</option>
        {% for b in batches %}<option value="{{ b }}">{{ b }}</option>{% endfor %}
      </select>
    </div>

    <div>
      <label>Challan Number</label>
      <select id="flt_challan">
        <option value="">All</option>
        {% for c in challans %}<option value="{{ c }}">{{ c }}</option>{% endfor %}
      </select>
    </div>

    <div>
      <label>Supplier</label>
      <select id="flt_supplier">
        <option value="">All</option>
        {% for s in suppliers %}<option value="{{ s }}">{{ s }}</option>{% endfor %}
      </select>
    </div>

    <div>
      <label>Gate Pass</label>
      <select id="flt_gatepass">
        <option value="">All</option>
        {% for g in gates %}<option value="{{ g }}">{{ g }}</option>{% endfor %}
      </select>
    </div>

    <div>
      <label>From Date</label>
      <input type="date" id="flt_from">
    </div>

    <div>
      <label>To Date</label>
      <input type="date" id="flt_to">
    </div>

    <div>
      <label>Quick Search</label>
      <input id="quickSearch" placeholder="Search anything...">
    </div>
  </div>

  <!-- ACTIONS -->
  <div class="actions">
    <div id="rowCount">0 rows</div>
    <div class="menu">
      <button class="menu-btn" onclick="toggleMenu()">‚ãÆ</button>
      <div class="menu-list" id="menuList">
        <div onclick="editSelected()">‚úè Edit Selected</div>
        <div onclick="deleteSelected()">üóë Delete Selected</div>
        <div onclick="printSelected()">üñ® Print Selected</div>
        <div onclick="pdfSelected()">üìÑ Export PDF</div>
        <div onclick="excelSelected()">üìä Export Excel</div>
      </div>
    </div>
  </div>
</div>

<!-- TABLE -->
<div class="section">
<div class="table-wrap">
<table id="gateTable">
<thead>
<tr>
  <th><input type="checkbox" id="chk_all"></th>
  <th>ID</th>
  <th>Date</th>
  <th>Time</th>
  <th>Batch</th>
  <th>Challan</th>
  <th>Gate Pass</th>
  <th>Supplier</th>
  <th>Purchase Location</th>
  <th>Vehicle</th>
  <th>Material Boxes</th>
  <th>Empty Boxes</th>
  <th>Ice Boxes</th>
  <th>Email</th>
  <th>Company</th>
</tr>
</thead>

<tbody id="reportBody">
{% for r in rows %}
<tr data-id="{{ r.id }}">
  <td><input type="checkbox" class="rowCheck"></td>
  <td>{{ r.id }}</td>
  <td>{{ r.date }}</td>
  <td>{{ r.time.strftime("%H:%M:%S") }}</td>
  <td>{{ r.batch_number }}</td>
  <td>{{ r.challan_number }}</td>
  <td>{{ r.gate_pass_number }}</td>
  <td>{{ r.supplier_name }}</td>
  <td>{{ r.purchasing_location }}</td>
  <td>{{ r.vehicle_number }}</td>
  <td>{{ r.no_of_material_boxes }}</td>
  <td>{{ r.no_of_empty_boxes }}</td>
  <td>{{ r.no_of_ice_boxes }}</td>
  <td>{{ r.email }}</td>
  <td>{{ r.company_id }}</td>
</tr>
{% endfor %}
</tbody>

<tfoot>
<tr>
  <td></td>
  <td colspan="9" style="text-align:right">TOTAL BOXES</td>
  <td id="sub_material">0</td>
  <td id="sub_empty">0</td>
  <td id="sub_ice">0</td>
  <td colspan="2"></td>
</tr>
</tfoot>
</table>
</div>
</div>
<!-- ================= SCRIPT ================= -->
<script>

const rows = Array.from(document.querySelectorAll("#reportBody tr"));
const batch = document.getElementById("flt_batch");
const challan = document.getElementById("flt_challan");
const supplier = document.getElementById("flt_supplier");
const gatepass = document.getElementById("flt_gatepass");
const flt_from = document.getElementById("flt_from");
const flt_to = document.getElementById("flt_to");
const search = document.getElementById("quickSearch");
const chk_all = document.getElementById("chk_all");

/* MENU */
function toggleMenu(){
    let m = document.getElementById("menuList");
    m.style.display = m.style.display==="block" ? "none" : "block";
}
window.onclick = e=>{
    if(!e.target.closest(".menu-box"))
        document.getElementById("menuList").style.display="none";
};

/* SELECTED ROWS */
function getSelected(){
    return Array.from(document.querySelectorAll(".rowCheck:checked"))
        .map(cb => cb.closest("tr").dataset.id);
}

chk_all.onclick = ()=>{
    let on = chk_all.checked;
    rows.forEach(r=>{
        let cb = r.querySelector(".rowCheck");
        cb.checked = on;
        r.classList.toggle("selected", on);
    });
};

/* EDIT */
function editSelected(){
    let ids = getSelected();
    if(ids.length !== 1) return alert("Select 1 row to edit");
    window.location = `/processing/gate_entry/edit/${ids[0]}`;
}

/* DELETE */
async function deleteSelected(){
    let ids = getSelected();
    if(ids.length === 0) return alert("Select rows to delete");

    if(!confirm("Delete selected rows?")) return;

    await fetch("/reports/gate_entry/delete", {
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body: JSON.stringify({ids})
    });

    location.reload();
}

/* PRINT */
function printSelected(){
    let ids = getSelected();
    if(ids.length === 0) return alert("Select rows");

    window.open(`/reports/gate_entry/print?ids=${ids.join(",")}`, "_blank");
}

/* EXPORT PDF */
function pdfSelected(){
    let ids = getSelected();
    if(ids.length === 0) return alert("Select rows");
    window.location = `/reports/gate_entry/export_pdf?ids=${ids.join(",")}`;
}

/* EXCEL */
function excelSelected(){
    let ids = getSelected();
    if(ids.length === 0) return alert("Select rows");
    window.location = `/reports/gate_entry/export_xlsx?ids=${ids.join(",")}`;
}

/* SUBTOTAL CALC */
function calculateSubtotal(){
    let mat=0, emp=0, ice=0;

    rows.forEach(r=>{
        if(r.style.display !== "none"){
            mat += parseInt(r.children[10].innerText) || 0;
            emp += parseInt(r.children[11].innerText) || 0;
            ice += parseInt(r.children[12].innerText) || 0;
        }
    });

    document.getElementById("sub_material").innerText = mat;
    document.getElementById("sub_empty").innerText = emp;
    document.getElementById("sub_ice").innerText = ice;
}

/* FILTERS */
function applyFilters(){
    rows.forEach(r => {
        let ok = true;
        let rowDate = r.children[2].innerText;

        if(flt_from.value && rowDate < flt_from.value) ok=false;
        if(flt_to.value && rowDate > flt_to.value) ok=false;

        if(batch.value && r.children[4].innerText !== batch.value) ok=false;
        if(challan.value && r.children[5].innerText !== challan.value) ok=false;
        if(supplier.value && r.children[7].innerText !== supplier.value) ok=false;
        if(gatepass.value && r.children[6].innerText !== gatepass.value) ok=false;

        if(search.value.trim() && 
           !r.innerText.toLowerCase().includes(search.value.toLowerCase()))
            ok=false;

        r.style.display = ok ? "" : "none";
    });

    calculateSubtotal();
}

document.querySelectorAll(".controls select").forEach(s=>{
    s.onchange = applyFilters;
});
flt_from.onchange = applyFilters;
flt_to.onchange = applyFilters;
search.oninput = applyFilters;

applyFilters();

</script

</body>
</html>
