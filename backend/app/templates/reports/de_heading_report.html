<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>DE-HEADING REPORT â€“ BKNR ERP</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
:root{
  --border:#d6dde7;
  --bg:#f4f6f9;
  --card:#ffffff;
  --text:#1f2937;
}
*{box-sizing:border-box;font-family:Segoe UI,Arial,sans-serif}
body{margin:0;background:var(--bg);color:var(--text)}

.header{
  position:sticky;
  top:0;
  z-index:100;
  background:var(--bg);
  padding:16px 18px 10px;
  border-bottom:1px solid var(--border);
}
.header h2{margin:0;font-size:22px}
.header p{margin:4px 0 0;font-size:12px;color:#6b7280}

/* ================= FILTERS ================= */
.filters{
  margin-top:10px;
  background:#fff;
  padding:12px;
  border-radius:10px;
  border:1px solid var(--border);
  display:grid;
  grid-template-columns:repeat(4,1fr);
  gap:12px;
}
.filters label{font-size:12px;font-weight:600}
.filters select,
.filters input{
  margin-top:6px;
  padding:6px;
  border-radius:6px;
  border:1px solid var(--border);
  font-size:12px;
  background:#fff;
}

/* ================= ACTIONS ================= */
.actions{
  margin-top:10px;
  display:flex;
  justify-content:space-between;
  align-items:center;
}
#rowCount{font-size:12px;font-weight:600}

.menu{position:relative}
.menu-btn{
  border:1px solid var(--border);
  background:#fff;
  border-radius:6px;
  padding:4px 10px;
  cursor:pointer;
  font-size:16px;
}
.menu-list{
  display:none;
  position:absolute;
  right:0;
  top:36px;
  background:#fff;
  border:1px solid var(--border);
  border-radius:8px;
  min-width:200px;
  z-index:50;
}
.menu-list div{
  padding:8px 12px;
  font-size:12px;
  cursor:pointer;
}
.menu-list div:hover{background:#f1f5f9}

/* ================= TABLE ================= */
.section{
  margin:20px 18px;
  background:#fff;
  padding:14px;
  border-radius:12px;
  border:1px solid var(--border);
}
.table-wrap{
  overflow:auto;
  max-height:520px;
}

table{
  width:100%;
  border-collapse:collapse;
  table-layout:fixed;
}
th,td{
  border-bottom:1px solid #edf2f7;
  padding:6px;
  font-size:11px;
  text-align:center;
  white-space:nowrap;
}
th{
  background:#f1f5f9;
  position:sticky;
  top:0;
  z-index:2;
  font-weight:700;
}

tfoot td{
  background:#fafafa;
  font-weight:700;
}
</style>
</head>

<body>

<div class="header">
  <h2>De-Heading Report</h2>
  <p>Batch Â· Contractor Â· Yield analysis</p>

  <!-- FILTERS (UNCHANGED LOGIC) -->
  <div class="filters">
    <div>
      <label>From Date</label>
      <input type="date" id="f_from">
    </div>
    <div>
      <label>To Date</label>
      <input type="date" id="f_to">
    </div>
    <div>
      <label>Month</label>
      <select id="f_month"><option value="">All</option></select>
    </div>
    <div>
      <label>Batch</label>
      <select id="f_batch">
        <option value="">All</option>
        {% for b in batches %}<option value="{{b}}">{{b}}</option>{% endfor %}
      </select>
    </div>

    <div>
      <label>Contractor</label>
      <select id="f_contractor">
        <option value="">All</option>
        {% for c in contractors %}<option value="{{c}}">{{c}}</option>{% endfor %}
      </select>
    </div>
    <div>
      <label>HOSO Count</label>
      <select id="f_count">
        <option value="">All</option>
        {% for c in counts %}<option value="{{c}}">{{c}}</option>{% endfor %}
      </select>
    </div>
    <div>
      <label>Search</label>
      <input id="searchBox" placeholder="Batch / Contractor">
    </div>
  </div>

  <div class="actions">
    <div id="rowCount">0 rows</div>
    <div class="menu">
      <button class="menu-btn" onclick="toggleMenu()">â‹®</button>
      <div class="menu-list" id="menu">
        <div onclick="printReport()">ðŸ–¨ Print Report</div>
        <div onclick="printBill()">ðŸ§¾ Contractor Bill</div>
        <div onclick="pdfReport()">ðŸ“„ Export PDF</div>
        <div onclick="excelReport()">ðŸ“Š Export Excel</div>
      </div>
    </div>
  </div>
</div>

<div class="section">
<div class="table-wrap">
<table>
<thead>
<tr>
  <th>Date</th>
  <th>Batch</th>
  <th>Contractor</th>
  <th>HOSO Count</th>
  <th>HOSO Qty</th>
  <th>HLSO Qty</th>
  <th>Yield %</th>
  <th>Target Yield %</th>
  <th>Difference</th>
  <th>Rate (â‚¹)</th>
  <th>Amount (â‚¹)</th>
</tr>
</thead>

<tbody id="tbody">
{% for r in rows %}
<tr>
  <td class="date">{{r.date}}</td>
  <td>{{r.batch_number}}</td>
  <td class="contractor">{{r.contractor}}</td>
  <td>{{r.hoso_count}}</td>
  <td class="hoso">{{r.hoso_qty}}</td>
  <td class="hlso">{{r.hlso_qty}}</td>
  <td>{{r.yield_percent}}%</td>
  <td class="target">{{r.target_yield}}</td>
  <td class="diff"></td>
  <td>â‚¹ {{r.rate_per_kg}}</td>
  <td class="amount" data-val="{{r.amount}}">â‚¹ {{r.amount}}</td>
</tr>
{% endfor %}
</tbody>

<tfoot>
<tr>
  <td colspan="4">GRAND TOTAL</td>
  <td id="gt_hoso">0</td>
  <td id="gt_hlso">0</td>
  <td></td>
  <td></td>
  <td></td>
  <td></td>
  <td>â‚¹ <span id="gt_amount">0</span></td>
</tr>
</tfoot>
</table>
</div>
</div>

<script>
const rows=[...document.querySelectorAll("#tbody tr")];
const num=v=>parseFloat(v)||0;

/* MENU */
function toggleMenu(){
 const m=document.getElementById("menu");
 m.style.display=m.style.display==="block"?"none":"block";
}
document.addEventListener("click",e=>{
 if(!e.target.closest(".menu")){
  document.getElementById("menu").style.display="none";
 }
});

/* MONTH DROPDOWN â€“ NOV 2025 */
const monthMap={};
rows.forEach(r=>{
 const d=r.querySelector(".date").innerText;
 if(!d) return;
 const [y,m]=d.split("-");
 const key=`${y}-${m}`;
 if(!monthMap[key]){
  monthMap[key]=new Date(y,m-1).toLocaleString("en",{month:"short",year:"numeric"});
 }
});
Object.keys(monthMap).sort().reverse().forEach(k=>{
 f_month.innerHTML+=`<option value="${k.split("-")[1]}">${monthMap[k].toUpperCase()}</option>`;
});

/* FILTERS */
function applyFilters(){
 let visible=[];
 rows.forEach(r=>{
  let ok=true;
  const d=r.querySelector(".date").innerText;
  const m=d?d.split("-")[1]:"";
  if(f_from.value && d<f_from.value) ok=false;
  if(f_to.value && d>f_to.value) ok=false;
  if(f_month.value && m!==f_month.value) ok=false;
  if(f_batch.value && r.children[1].innerText!==f_batch.value) ok=false;
  if(f_contractor.value && r.children[2].innerText!==f_contractor.value) ok=false;
  if(f_count.value && r.children[3].innerText!==f_count.value) ok=false;
  if(searchBox.value && !r.innerText.toLowerCase().includes(searchBox.value.toLowerCase())) ok=false;
  r.style.display=ok?"":"none";
  if(ok) visible.push(r);
 });
 rowCount.innerText=visible.length+" rows";
 totals(visible);
 calcDiff();
}

/* TOTALS */
function totals(v){
 let h=0,l=0,a=0;
 v.forEach(r=>{
  h+=num(r.querySelector(".hoso").innerText);
  l+=num(r.querySelector(".hlso").innerText);
  a+=num(r.querySelector(".amount").dataset.val);
 });
 gt_hoso.innerText=h.toFixed(2);
 gt_hlso.innerText=l.toFixed(2);
 gt_amount.innerText=a.toFixed(2);
}

/* DIFFERENCE */
function calcDiff(){
 rows.forEach(r=>{
  if(r.style.display==="none") return;
  const h=num(r.querySelector(".hoso").innerText);
  const l=num(r.querySelector(".hlso").innerText);
  const t=num(r.querySelector(".target").innerText);
  if(!h||!l||!t){r.querySelector(".diff").innerText="";return;}
  const base=l/(t/100);
  const diff=base-h;
  const pct=(diff/h)*100;
  r.querySelector(".diff").innerText=`${diff.toFixed(2)} (${Math.abs(pct).toFixed(2)}%)`;
 });
}

/* ACTIONS */
function printReport(){window.open(`/reports/de_heading/print?ids=all`);}
function pdfReport(){location=`/reports/de_heading/export_pdf?ids=all`;}
function excelReport(){location=`/reports/de_heading/export_excel?ids=all`;}
function printBill(){
 if(!f_month.value||!f_contractor.value){
  alert("Select Month and Contractor");
  return;
 }
 window.open(`/reports/de_heading/contractor_monthly_bill?month=${f_month.value}&contractor=${encodeURIComponent(f_contractor.value)}`);
}

[f_from,f_to,f_batch,f_contractor,f_count,f_month].forEach(e=>e.onchange=applyFilters);
searchBox.oninput=applyFilters;
applyFilters();
</script>

</body>
</html>
