<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>PEELING - BKNR SOLUTIONS</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<style>
body{font-family:Arial,sans-serif;background:#e6f2ff;margin:0}
h2{text-align:center;color:#003366;margin:15px 0;font-weight:700}

.form-container{
  width:96%;max-width:1200px;margin:0 auto;
  background:#fff;padding:10px;border-radius:15px;
  box-shadow:0 0 8px rgba(0,0,0,.15)
}

/* GRID */
.row{
  display:grid;
  grid-template-columns:repeat(6, minmax(0,1fr));
  gap:10px;margin-bottom:10px
}
.col{display:flex;flex-direction:column}

@media(max-width:900px){.row{grid-template-columns:repeat(3,1fr)}}
@media(max-width:600px){.row{grid-template-columns:1fr}}

label{font-weight:600;color:#003366;margin-bottom:6px}
input,select{
  padding:10px;border:1px solid #a3bcd6;
  background:#f9fcff;border-radius:6px;font-size:14px
}
input[readonly]{background:#eee}

/* BUTTONS */
.actions{text-align:center;margin-top:20px}
.btn{
  background:#003366;color:#fff;border:none;
  padding:10px 20px;border-radius:6px;
  font-weight:600;cursor:pointer
}
.btn-clear{background:#777}

/* TABLE */
table{
  width:92%;max-width:1200px;margin:20px auto;
  border-collapse:collapse;background:#fff;
  border-radius:10px;overflow:hidden;
  box-shadow:0 0 8px rgba(0,0,0,.15)
}
th,td{padding:10px;border-bottom:1px solid #ccc;font-size:14px}
th{background:#003366;color:#fff}
tr:hover{background:#e6f2ff;cursor:pointer}
tr.selected{background:#cce5ff!important}

/* 3 DOT MENU */
#threeDotsMenu{
  width:92%;max-width:1200px;margin:10px auto;
  text-align:right;display:none;position:relative
}
#dropdownMenu{
  display:none;position:absolute;right:0;
  background:#fff;border:1px solid #ccc;
  border-radius:8px;width:180px;
  box-shadow:0 2px 6px rgba(0,0,0,.3)
}
.menu-item{padding:10px;cursor:pointer}
.menu-item:hover{background:#e6f2ff}
</style>
</head>

<body>

<h2>{% if edit_data %}EDIT PEELING{% else %}PEELING ENTRY{% endif %}</h2>

<form method="post"
 action="{% if edit_data %}/processing/peeling/update/{{edit_data.id}}{% else %}/processing/peeling{% endif %}">

<div class="form-container">

<!-- ================= ROW 1 ================= -->
<div class="row">

  <div class="col">
    <label>Batch</label>
    <select name="batch_number" id="batch" required onchange="loadHLSO()">
      <option value="" disabled selected>Select Batch</option>
      {% for b in batches %}
      <option value="{{b}}" {% if edit_data and edit_data.batch_number==b %}selected{% endif %}>{{b}}</option>
      {% endfor %}
    </select>
  </div>

  <div class="col">
    <label>Species</label>
    <select name="species_name" id="species" required onchange="loadAvailableQty()">
      <option value="" disabled selected>Select Species</option>
      {% for s in species %}
      <option value="{{s}}" {% if edit_data and edit_data.species==s %}selected{% endif %}>{{s}}</option>
      {% endfor %}
    </select>
  </div>

  <div class="col">
    <label>HLSO Count</label>
    <select name="hlso_count" id="hlso" required onchange="loadAvailableQty()">
      <option value="" disabled selected>Select Batch First</option>
    </select>
  </div>

  <div class="col">
    <label>HLSO Qty (kg)</label>
    <input type="number" step="0.01" name="hlso_qty" id="hlso_qty" required>
    <small id="availableText" style="margin-top:4px;font-weight:600;color:#006400">
      Available Qty : 0 kg
    </small>
  </div>

  <div class="col">
    <label>Variety</label>
    <select name="variety_name" id="variety" onchange="loadRate()" required>
      <option value="" disabled selected>Select Variety</option>
      {% for v in varieties %}
      <option value="{{v}}" {% if edit_data and edit_data.variety_name==v %}selected{% endif %}>{{v}}</option>
      {% endfor %}
    </select>
  </div>

  <div class="col">
    <label>Peeled Qty (kg)</label>
    <input type="number" step="0.01" id="peeled" name="peeled_qty" required>
  </div>

</div>

<!-- ================= ROW 2 ================= -->
<div class="row">

  <div class="col">
    <label>Contractor</label>
    <select name="contractor_name" id="contractor" onchange="loadRate()" required>
      <option value="" disabled selected>Select Contractor</option>
      {% for c in contractors %}
      <option value="{{c}}" {% if edit_data and edit_data.contractor_name==c %}selected{% endif %}>{{c}}</option>
      {% endfor %}
    </select>
  </div>

  <div class="col">
    <label>Rate (‚Çπ/kg)</label>
    <input type="text" id="rate" name="rate" readonly>
  </div>

  <div class="col">
    <label>Yield %</label>
    <input type="text" id="yield" name="yield_percent" readonly>
  </div>

  <div class="col">
    <label>Amount (‚Çπ)</label>
    <input type="text" id="amount" name="amount" readonly>
  </div>

</div>

<div class="actions">
  <button class="btn" type="submit">{% if edit_data %}UPDATE{% else %}SAVE{% endif %}</button>
  <button class="btn btn-clear" type="reset"
    onclick="{% if edit_data %}location.href='/processing/peeling'{% endif %}">
    CLEAR
  </button>
</div>

</div>
</form>

{% if today_data %}
<div id="threeDotsMenu">
  <button class="btn" id="dotsBtn">‚ãÆ</button>
  <div id="dropdownMenu">
    <div class="menu-item" onclick="editRow()">‚úè Edit</div>
    <div class="menu-item" onclick="deleteRow()">üóë Delete</div>
  </div>
</div>

<table id="dataTable">
<thead>
<tr>
  <th>ID</th>
  <th>Batch</th>
  <th>Species</th>
  <th>HLSO</th>
  <th>HLSO Qty</th>
  <th>Peeled Qty</th>
  <th>Yield %</th>
  <th>Contractor</th>
  <th>Rate</th>
  <th>Amount</th>
  <th>Date</th>
</tr>
</thead>
<tbody>
{% for r in today_data %}
<tr data-id="{{r.id}}">
  <td>{{r.id}}</td>
  <td>{{r.batch_number}}</td>
  <td>{{r.species}}</td>
  <td>{{r.hlso_count}}</td>
  <td>{{r.hlso_qty}}</td>
  <td>{{r.peeled_qty}}</td>
  <td>{{r.yield_percent}}</td>
  <td>{{r.contractor_name}}</td>
  <td>{{r.rate}}</td>
  <td>{{r.amount}}</td>
  <td>{{r.date}}</td>
</tr>
{% endfor %}
</tbody>
</table>
{% endif %}

<script>
let selected=null;

// LOAD HLSO COUNTS
async function loadHLSO(){
  if(!batch.value)return;
  let r=await fetch("/processing/peeling/get_hlso/"+batch.value);
  let d=await r.json();
  hlso.innerHTML='<option disabled selected>Select HLSO</option>'+
    d.counts.map(v=>`<option value="${v}">${v}</option>`).join("");
  hlso_qty.value="";
  availableText.innerText="Available Qty : 0 kg";
}

// AVAILABLE QTY (WITH SPECIES)
async function loadAvailableQty(){
  if(!batch.value||!hlso.value||!species.value)return;
  let r=await fetch(
    `/processing/peeling/get_available_qty/${batch.value}/${hlso.value}/${species.value}`
  );
  let d=await r.json();
  availableText.innerText=`Available Qty : ${d.available_qty} kg`;
}

// RATE
async function loadRate(){
  if(!contractor.value||!variety.value)return;
  let r=await fetch(
    `/processing/peeling/get_rate?contractor=${contractor.value}&variety=${variety.value}`
  );
  let d=await r.json();
  rate.value=d.rate;
  calc();
}

// CALC
function calc(){
  let h=parseFloat(hlso_qty.value)||0;
  let p=parseFloat(peeled.value)||0;
  let r=parseFloat(rate.value)||0;
  yield.value=h?((p/h)*100).toFixed(2):0;
  amount.value=(p*r).toFixed(2);
}
hlso_qty.oninput=calc;
peeled.oninput=calc;

// TABLE SELECT
document.querySelectorAll("#dataTable tbody tr").forEach(tr=>{
  tr.onclick=()=>{
    document.querySelectorAll("tr").forEach(x=>x.classList.remove("selected"));
    tr.classList.add("selected");selected=tr;
    threeDotsMenu.style.display="block";
  }
});

dotsBtn?.addEventListener("click",()=>{
  dropdownMenu.style.display=
    dropdownMenu.style.display==="block"?"none":"block";
});

function editRow(){ if(selected) location=`/processing/peeling/edit/${selected.dataset.id}` }
function deleteRow(){
  if(!selected)return;
  Swal.fire({icon:"warning",title:"Delete?",showCancelButton:true})
  .then(r=>r.isConfirmed &&
    fetch(`/processing/peeling/delete/${selected.dataset.id}`,{method:"POST"})
    .then(()=>location.reload()))
}
</script>

</body>
</html>
