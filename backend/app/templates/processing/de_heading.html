<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>DE-HEADING - BKNR SOLUTIONS</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
  body {font-family:Arial,sans-serif; background:#e6f2ff; margin:0; padding:0;}
  h2 {text-align:center; color:#003366; margin:20px 0; font-weight:700;}

  .form-container {
      width:92%; max-width:1200px; margin:0 auto;
      background:white; padding:22px;
      border-radius:10px; box-shadow:0 0 8px rgba(0,0,0,0.15);
  }

  .row {display:flex; flex-wrap:wrap; justify-content:space-between; margin-bottom:15px;}
  .col {width:32%; display:flex; flex-direction:column; margin-bottom:15px;}

  @media(max-width:900px){ .col { width:48%; } }
  @media(max-width:600px){ .col { width:100%; } }

  label {font-weight:600; color:#003366; margin-bottom:6px;}

  input, select {
      padding:10px; border:1px solid #a3bcd6; background:#f9fcff;
      border-radius:6px; font-size:14px;
  }

  .actions {text-align:center; margin-top:20px;}
  .btn {background:#003366; color:white; border:none;
        padding:10px 20px; border-radius:6px; font-weight:600; cursor:pointer;}
  .btn-clear {background:#777;}

  table {
      width:92%; max-width:1200px; margin:20px auto;
      border-collapse:collapse; background:white;
      border-radius:10px; overflow:hidden;
      box-shadow:0 0 8px rgba(0,0,0,0.15);
  }
  th,td {padding:10px; border-bottom:1px solid #ccc; font-size:14px;}
  th {background:#003366; color:white;}
  tr:hover {background:#e6f2ff; cursor:pointer;}
  tr.selected {background:#cce5ff !important;}

  #threeDotsMenu {
      width:92%; max-width:1200px; margin:10px auto;
      text-align:right; position:relative; display:none;
  }

  #dropdownMenu {
      display:none; position:absolute; right:0; background:white;
      border:1px solid #ccc; border-radius:8px;
      width:180px; box-shadow:0 2px 6px rgba(0,0,0,0.3); z-index:1000;
  }
  .menu-item {padding:10px; cursor:pointer;}
  .menu-item:hover {background:#e6f2ff;}

  #lookupModal {
      display:none; position:fixed; top:0; left:0; width:100%; height:100%;
      background:rgba(0,0,0,0.45); justify-content:center; align-items:center;
      z-index:9999;
  }

  .lookup-box {
      background:white; width:90%; max-width:900px; height:85vh;
      border-radius:10px; overflow:hidden; position:relative;
  }

  .close-popup {
      position:absolute; top:10px; right:20px;
      font-size:22px; font-weight:bold; cursor:pointer; color:#003366;
  }

  iframe {width:100%; height:100%; border:none;}
</style>
</head>

<body>

<h2>DE-HEADING</h2>

<!-- FORM -->
<form method="post"
      action="{% if edit_data %}/processing/de_heading/update/{{ edit_data.id }}{% else %}/processing/de_heading{% endif %}">
  <div class="form-container">

    <!-- ROW 1 -->
    <div class="row">
      <div class="col">
        <label>Batch Number</label>
        <select name="batch_number" id="batch_number" required>
          <option value="" disabled {% if not edit_data %}selected{% endif %}>Select Batch</option>
          {% for b in batches %}
          <option value="{{ b }}" {% if edit_data and edit_data.batch_number == b %}selected{% endif %}>{{ b }}</option>
          {% endfor %}
          <option value="__add__">‚ûï Add New Batch</option>
        </select>
      </div>

      <div class="col">
        <label>HOSO Count</label>
        <select name="hoso_count" id="hoso_count" required>
          <option value="" {% if not edit_data %}selected{% endif %}>Select Count</option>
          {% if edit_data %}
            <option value="{{ edit_data.hoso_count }}" selected>{{ edit_data.hoso_count }}</option>
          {% endif %}
        </select>
      </div>

      <div class="col">
        <label>HOSO Qty (KG)</label>
        <input type="number" step="0.01" name="hoso_qty" id="hoso_qty"
          value="{% if edit_data %}{{ edit_data.hoso_qty }}{% endif %}" required>
      </div>
    </div>

    <!-- ROW 2 -->
    <div class="row">
      <div class="col">
        <label>HLSO Qty (KG)</label>
        <input type="number" step="0.01" name="hlso_qty" id="hlso_qty"
          value="{% if edit_data %}{{ edit_data.hlso_qty }}{% endif %}" required>
      </div>

      <div class="col">
        <label>Yield %</label>
        <input type="number" step="0.01" name="yield_percent" id="yield_percent"
          value="{% if edit_data %}{{ edit_data.yield_percent }}{% endif %}" readonly>
      </div>

      <div class="col">
        <label>Contractor</label>
        <select name="contractor" id="contractor" required>
          <option value="" disabled {% if not edit_data %}selected{% endif %}>Select Contractor</option>
          {% for c in contractors %}
            <option value="{{ c }}" {% if edit_data and edit_data.contractor == c %}selected{% endif %}>{{ c }}</option>
          {% endfor %}
          <option value="__add__">‚ûï Add New Contractor</option>
        </select>
      </div>
    </div>

    <!-- ROW 3 -->
    <div class="row">
      <div class="col">
        <label>Rate per KG</label>
        <input type="number" step="0.01" name="rate_per_kg" id="rate_per_kg"
          value="{% if edit_data %}{{ edit_data.rate_per_kg }}{% endif %}" readonly>
      </div>

      <div class="col">
        <label>Amount</label>
        <input type="number" step="0.01" name="amount" id="amount"
          value="{% if edit_data %}{{ edit_data.amount }}{% endif %}" readonly>
      </div>

      <div class="col">
        <label>Remarks</label>
        <input type="text" name="remarks"
          value="{% if edit_data %}{{ edit_data.remarks }}{% endif %}">
      </div>
    </div>

    <!-- DATE/TIME (only for new entries) -->
    {% if not edit_data %}
    <div class="row">
      <div class="col">
        <label>Date</label>
        <input type="date" name="date_value" value="{{ date.today() }}" required>
      </div>

      <div class="col">
        <label>Time</label>
        <input type="time" name="time_value" value="{{ datetime.now().strftime('%H:%M:%S') }}" required>
      </div>
      <div class="col"></div>
    </div>
    {% endif %}

    <div class="actions">
      <button class="btn" type="submit">{% if edit_data %}UPDATE{% else %}SAVE{% endif %}</button>
      <button class="btn btn-clear" type="button" onclick="window.location='/processing/de_heading'">CLEAR</button>
    </div>

  </div>
</form>

{% if message %}
<p style="text-align:center; color:green; font-weight:700;">{{ message }}</p>
{% endif %}

<!-- 3 DOT MENU -->
{% if today_data %}
<div id="threeDotsMenu">
  <button id="dotsBtn" class="btn">‚ãÆ</button>

  <div id="dropdownMenu">
    <div class="menu-item" onclick="editSelected()">‚úèÔ∏è Edit</div>
    <div class="menu-item" onclick="deleteSelected()">üóë Delete</div>
    <div class="menu-item" onclick="printSelected()">üñ® Print</div>
  </div>
</div>

<!-- TABLE -->
<table id="dataTable">
<thead>
<tr>
  <th>ID</th>
  <th>Batch</th>
  <th>HOSO Count</th>
  <th>HOSO (Kg)</th>
  <th>HLSO (Kg)</th>
  <th>Yield %</th>
  <th>Contractor</th>
  <th>Rate/Kg</th>
  <th>Amount</th>
  <th>Date</th>
</tr>
</thead>

<tbody>
{% for r in today_data %}
<tr data-id="{{ r.id }}">
  <td>{{ r.id }}</td>
  <td>{{ r.batch_number }}</td>
  <td>{{ r.hoso_count }}</td>
  <td>{{ r.hoso_qty }}</td>
  <td>{{ r.hlso_qty }}</td>
  <td>{{ r.yield_percent }}</td>
  <td>{{ r.contractor }}</td>
  <td>{{ r.rate_per_kg }}</td>
  <td>{{ r.amount }}</td>
  <td>{{ r.date }}</td>
</tr>
{% endfor %}
</tbody>
</table>
{% endif %}

<!-- LOOKUP POPUP -->
<div id="lookupModal">
  <div class="lookup-box">
    <span class="close-popup" onclick="closeLookup()">√ó</span>
    <iframe id="lookupFrame"></iframe>
  </div>
</div>

<script>
let selectedRow = null;

/*** SELECT ROW ***/
document.addEventListener("DOMContentLoaded", () => {
  document.querySelectorAll("#dataTable tbody tr").forEach(row => {
    row.addEventListener("click", () => {
      document.querySelectorAll("tr").forEach(r => r.classList.remove("selected"));
      row.classList.add("selected");
      selectedRow = row;
      document.getElementById("threeDotsMenu").style.display = "block";
    });
  });

  // Hook: batch change on load if edit_data present (prepopulated)
  const batchSelect = document.getElementById("batch_number");
  if(batchSelect && batchSelect.value){
    loadHosoCounts(batchSelect.value);
  }
});

/*** MENU TOGGLE ***/
document.getElementById("dotsBtn").addEventListener("click", () => {
  const d = document.getElementById("dropdownMenu");
  d.style.display = (d.style.display === "block") ? "none" : "block";
});

/*** EDIT BUTTON ‚Äî Redirect ***/
function editSelected(){
  if(!selectedRow) return alert("Select a row!");
  window.location = `/processing/de_heading/edit/${selectedRow.dataset.id}`;
}

/*** DELETE ***/
function deleteSelected(){
  if(!selectedRow) return alert("Select a row!");
  if(!confirm("Delete?")) return;
  fetch(`/processing/de_heading/delete/${selectedRow.dataset.id}`, { method: "POST" })
    .then(res => res.json())
    .then(() => location.reload())
    .catch(err => { alert("Delete failed"); console.error(err); });
}

/*** PRINT ***/
function printSelected(){
  if(!selectedRow) return alert("Select row!");
  const win = window.open("", "_blank");
  win.document.write("<h3>De-heading Record</h3>");
  win.document.write("<table border='1'><tr>");
  selectedRow.querySelectorAll("td").forEach((td) => {
    win.document.write("<td style='padding:6px'>" + td.innerText + "</td>");
  });
  win.document.write("</tr></table>");
  win.print();
}

/*** LOAD HOSO COUNTS ON BATCH CHANGE ***/
document.getElementById("batch_number").addEventListener("change", function(){
  if(this.value === "__add__"){
    // open lookup to add batch
    document.getElementById("lookupFrame").src = "/processing/batch_lookup";
    document.getElementById("lookupModal").style.display = "flex";
    this.value = "";
    return;
  }
  loadHosoCounts(this.value);
});

function loadHosoCounts(batch) {
  fetch(`/processing/get_hoso/${encodeURIComponent(batch)}`)
    .then(res => res.json())
    .then(data => {
      const h = document.getElementById("hoso_count");
      h.innerHTML = "<option value=''>Select Count</option>";
      data.counts.forEach(c => {
        const opt = document.createElement("option");
        opt.value = c;
        opt.text = c;
        h.appendChild(opt);
      });
    })
    .catch(err => console.error("Failed to load HOSO counts", err));
}

/*** CONTRACTOR CHANGE => LOAD RATE ***/
document.getElementById("contractor").addEventListener("change", function(){
  if(this.value === "__add__"){
    document.getElementById("lookupFrame").src = "/criteria/contractors";
    document.getElementById("lookupModal").style.display = "flex";
    this.value = "";
    return;
  }
  fetch(`/processing/get_rate/${encodeURIComponent(this.value)}`)
    .then(res => res.json())
    .then(data => {
      document.getElementById("rate_per_kg").value = data.rate || 0;
      calcAmounts();
    })
    .catch(err => console.error("Failed to load rate", err));
});

/*** AUTO CALC Yield% and Amount ***/
document.getElementById("hlso_qty").addEventListener("input", calcAmounts);
document.getElementById("hoso_qty").addEventListener("input", calcAmounts);

function calcAmounts(){
  const hlso = parseFloat(document.getElementById("hlso_qty").value) || 0;
  const hoso = parseFloat(document.getElementById("hoso_qty").value) || 0;
  const rate = parseFloat(document.getElementById("rate_per_kg").value) || 0;

  if(hoso > 0){
    document.getElementById("yield_percent").value = ((hlso / hoso) * 100).toFixed(2);
  } else {
    document.getElementById("yield_percent").value = "";
  }
  document.getElementById("amount").value = (hlso * rate).toFixed(2);
}

/*** POPUP LOOKUP ***/
document.querySelectorAll("select").forEach(sel => {
  sel.addEventListener("change", function(){
    if(this.value !== "__add__") return;
    let url = "";
    if(this.name === "batch_number") url = "/processing/batch_lookup";
    if(this.name === "contractor") url = "/criteria/contractors";
    document.getElementById("lookupFrame").src = url;
    document.getElementById("lookupModal").style.display = "flex";
    this.value = "";
  });
});

function closeLookup(){
  document.getElementById("lookupModal").style.display = "none";
  // reload to pick up newly added lookup data
  window.location.reload();
}
</script>

</body>
</html>
