<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>GRADING - BKNR SOLUTIONS</title>

<style>
  body{font-family:Arial,sans-serif;background:#e6f2ff;margin:0;padding:0;}
  h2{text-align:center;color:#003366;margin:20px 0;font-weight:700;}

  .form-container{
    width:95%;max-width:1100px;margin:0 auto;background:#fff;
    box-shadow:0 0 8px rgba(0,0,0,0.15);padding:25px;border-radius:8px;
  }

  .row{display:flex;flex-wrap:wrap;justify-content:space-between;margin-bottom:18px;}
  .col{width:32%;min-width:250px;display:flex;flex-direction:column;}

  label{font-weight:600;color:#003366;margin-bottom:6px;}
  input,select{
    padding:8px;border:1px solid #a3bcd6;border-radius:6px;background:#f9fcff;font-size:14px;
  }
  input[disabled]{background:#eee;color:#666;}

  .actions{text-align:center;margin-top:20px;}
  button{
    background:#003366;color:#fff;border:none;padding:9px 18px;border-radius:6px;
    font-weight:600;cursor:pointer;margin:0 8px;
  }
  .btn-clear{background:#777;}

  /* LOOKUP POPUP */
  #lookupModal{
    display:none;position:fixed;top:0;left:0;width:100%;height:100%;
    background:rgba(0,0,0,0.45);justify-content:center;align-items:center;z-index:9999;
  }
  #lookupModal .frame-box{
    width:90%;max-width:900px;height:85vh;background:white;border-radius:10px;overflow:hidden;
  }
  #lookupFrame{width:100%;height:100%;border:none;}

  .close-btn{
    font-size:22px;font-weight:bold;color:#003366;cursor:pointer;position:absolute;top:10px;right:20px;
  }
</style>

</head>
<body>

<h2>GRADING FORM</h2>

<form action="/processing/grading" method="post" onsubmit="fillMeta(this)">
  <div class="form-container">

    <!-- Row 1 -->
    <div class="row">

      <div class="col">
        <label>Batch Number</label>
        <select id="batch_number" name="batch_number" required onchange="openLookup(this,'batches')">
          <option value="" disabled selected>Select Batch</option>
          {% for b in batches %}
            <option value="{{ b }}">{{ b }}</option>
          {% endfor %}
          <option value="__add__">➕ Add New Batch</option>
        </select>
      </div>

      <div class="col">
        <label>HOSO Count</label>
        <select id="hoso_count" name="hoso_count" required onchange="openLookup(this,'hoso')">
          <option value="" disabled selected>Select Count</option>
          {% for h in hoso_counts %}
            <option value="{{ h }}">{{ h }}</option>
          {% endfor %}
          <option value="__add__">➕ Add New Count</option>
        </select>
      </div>

      <div class="col">
        <label>Variety</label>
        <select id="variety" name="variety" required onchange="openLookup(this,'varieties')">
          <option value="" disabled selected>Select Variety</option>
          {% for v in varieties %}
            <option value="{{ v }}">{{ v }}</option>
          {% endfor %}
          <option value="__add__">➕ Add Variety</option>
        </select>
      </div>

    </div>

    <!-- Row 2 -->
    <div class="row">

      <div class="col">
        <label>Graded Count</label>
        <input type="text" id="graded_count" name="graded_count" required>
      </div>

      <div class="col">
        <label>Quantity (kg)</label>
        <input type="number" step="0.01" min="0" id="quantity" name="quantity" required>
      </div>

    </div>

    <!-- Hidden meta -->
    <input type="hidden" name="date" id="meta_date">
    <input type="hidden" name="time" id="meta_time">
    <input type="hidden" name="email" id="meta_email">
    <input type="hidden" name="company_id" id="meta_company_id">

    <div class="actions">
      <button type="submit">SAVE</button>
      <button type="reset" class="btn-clear">CLEAR</button>
    </div>

  </div>
</form>

<!-- LOOKUP POPUP -->
<div id="lookupModal">
  <div class="frame-box">
    <span class="close-btn" onclick="closeLookup()">×</span>
    <iframe id="lookupFrame"></iframe>
  </div>
</div>

<script>
// META AUTO-FILL
function fillMeta(form){
  const now=new Date();
  form.date.value=now.toISOString().slice(0,10);
  form.time.value=now.toTimeString().slice(0,8);
  form.email.value="bknr.solutions@gmail.com";
  form.company_id.value="BKNR001";
}

// LOOKUP POPUP
function openLookup(sel, type){
  if(sel.value !== "__add__") return;

  let url="";
  if(type==="batches") url="/processing/gate_entry";
  if(type==="hoso") url="/criteria/grade_to_hoso";
  if(type==="varieties") url="/criteria/varieties";

  document.getElementById("lookupFrame").src=url;
  document.getElementById("lookupModal").style.display="flex";
  sel.value="";
}

function closeLookup(){
  document.getElementById("lookupModal").style.display="none";
  location.reload();
}

// Initialize meta
fillMeta(document.forms[0]);
</script>

</body>
</html>
