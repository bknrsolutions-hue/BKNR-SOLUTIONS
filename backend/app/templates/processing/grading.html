<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>GRADING - BKNR SOLUTIONS</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<style>
  body{font-family:Arial,sans-serif;background:#e6f2ff;margin:0}
  h2{text-align:center;color:#003366;margin:20px 0;font-weight:700}

  .form-container{
    width:95%;max-width:1280px;margin:0 auto;
    background:#fff;padding:25px;border-radius:10px;
    box-shadow:0 0 8px rgba(0,0,0,.2)
  }

  .row{display:flex;flex-wrap:wrap;justify-content:space-between;margin-bottom:15px}

  .col{
    width:15.5%;
    display:flex;flex-direction:column;margin-bottom:10px
  }

  @media(max-width:900px){.col{width:48%}}
  @media(max-width:600px){.col{width:100%}}

  label{font-weight:600;color:#003366;margin-bottom:4px}

  input,select{
    padding:8px;border:1px solid #aac1dd;background:#f9fcff;
    border-radius:6px;font-size:14px
  }

  .actions{text-align:center;margin-top:20px}
  .btn{
    background:#003366;color:#fff;border:none;
    padding:10px 25px;border-radius:7px;
    font-weight:700;cursor:pointer
  }
  .btn-clear{background:#777}

  table{
    width:95%;max-width:1280px;margin:25px auto;
    border-collapse:collapse;background:#fff;
    box-shadow:0 0 8px rgba(0,0,0,.15)
  }
  th,td{
    padding:6px 8px;border-bottom:1px solid #ccc;
    font-size:13px;white-space:nowrap
  }
  th{background:#003366;color:#fff}
  tr:hover{background:#e9f1ff;cursor:pointer}
  tr.selected{background:#bed6ff!important}

  #threeDotsMenu{
    width:95%;max-width:1280px;margin:5px auto;
    text-align:right;display:none
  }

  #dropdownMenu{
    display:none;position:absolute;right:50px;background:#fff;
    width:160px;border-radius:8px;z-index:1000;
    border:1px solid #ccc
  }
  .menu-item{padding:10px;cursor:pointer}
  .menu-item:hover{background:#e6f2ff}

  #lookupModal{
    display:none;position:fixed;left:0;top:0;width:100%;height:100%;
    background:rgba(0,0,0,.45);justify-content:center;align-items:center;
    z-index:9999
  }

  .lookup-box{
    background:#fff;width:90%;max-width:900px;height:85vh;
    border-radius:10px;position:relative;overflow:hidden
  }

  .close-popup{
    position:absolute;top:10px;right:20px;
    font-size:22px;font-weight:bold;cursor:pointer;color:#003366
  }

  iframe{width:100%;height:100%;border:none}
</style>
</head>

<body>

<h2>GRADING</h2>

<form method="post"
action="{% if edit_data %}/processing/grading/update/{{edit_data.id}}{% else %}/processing/grading{% endif %}">
<div class="form-container">

<!-- ROW 1 -->
<div class="row">
  <div class="col">
    <label>Batch</label>
    <select id="batch" name="batch_number" required>
      <option disabled {% if not edit_data %}selected{% endif %}>Select</option>
      {% for b in batches %}
      <option value="{{b}}" {% if edit_data and edit_data.batch_number==b %}selected{% endif %}>{{b}}</option>
      {% endfor %}
      <option value="__lookup_batch__">+ add new</option>
    </select>
  </div>

  <div class="col">
    <label>HOSO Count</label>
    <select id="hoso" name="hoso_count" required>
      {% if edit_data %}
      <option value="{{edit_data.hoso_count}}">{{edit_data.hoso_count}}</option>
      {% else %}
      <option disabled selected>Select Batch</option>
      {% endif %}
    </select>
  </div>

  <div class="col">
    <label>Variety</label>
    <select id="variety" name="variety_name" required>
      <option disabled>Select</option>
      {% for v in variety_list %}
      <option value="{{v}}" {% if edit_data and edit_data.variety_name==v %}selected{% endif %}>{{v}}</option>
      {% endfor %}
      <option value="__lookup_variety__">+ add new</option>
    </select>
  </div>

  <div class="col">
    <label>Graded Count</label>
    <input name="graded_count" value="{{edit_data.graded_count if edit_data else ''}}">
  </div>

  <div class="col">
    <label>Quantity (kg)</label>
    <input type="number" step="0.01" name="quantity"
    value="{{edit_data.quantity if edit_data else ''}}">
  </div>

  <div class="col">
    <label>Species</label>
    <select id="species" name="species_val" required>
      <option disabled>Select</option>
      {% for s in species_list %}
      <option value="{{s}}" {% if edit_data and edit_data.species==s %}selected{% endif %}>{{s}}</option>
      {% endfor %}
      <option value="__lookup_species__">+ add new</option>
    </select>
  </div>
</div>

<div class="actions">
  <button class="btn">{% if edit_data %}UPDATE{% else %}SAVE{% endif %}</button>
  <button type="button" class="btn btn-clear"
  onclick="window.location='/processing/grading'">CLEAR</button>
</div>

</div>
</form>

{% if today_data %}
<div id="threeDotsMenu">
  <button class="btn" id="dotsBtn">‚ãÆ</button>
  <div id="dropdownMenu">
    <div class="menu-item" onclick="editSelected()">‚úèÔ∏è Edit</div>
    <div class="menu-item" onclick="deleteSelected()">üóë Delete</div>
  </div>
</div>

<table id="dataTable">
<thead>
<tr>
  <th>ID</th>
  <th>Batch</th>
  <th>HOSO</th>
  <th>Variety</th>
  <th>Grade</th>
  <th>Qty</th>
  <th>Species</th>
  <th>Date</th>
  <th>Time</th>
</tr>
</thead>
<tbody>
{% for r in today_data %}
<tr data-id="{{r.id}}">
  <td>{{r.id}}</td>
  <td>{{r.batch_number}}</td>
  <td>{{r.hoso_count}}</td>
  <td>{{r.variety_name}}</td>
  <td>{{r.graded_count}}</td>
  <td>{{r.quantity}}</td>
  <td>{{r.species}}</td>
  <td>{{r.date}}</td>
  <td>{{r.time}}</td>
</tr>
{% endfor %}
</tbody>
</table>
{% endif %}

<!-- LOOKUP POPUP -->
<div id="lookupModal">
  <div class="lookup-box">
    <span class="close-popup" onclick="closeLookup()">√ó</span>
    <iframe id="lookupFrame"></iframe>
  </div>
</div>

<script>
function openLookup(url){
  lookupFrame.src=url;
  lookupModal.style.display="flex";
}
function closeLookup(){
  lookupModal.style.display="none";
  location.reload();
}

batch.onchange=()=>{
  if(batch.value==="__lookup_batch__"){
    openLookup("/processing/raw_material_purchasing");
    batch.value="";
  }else{
    fetch("/processing/grading/get_hoso/"+batch.value)
    .then(r=>r.json()).then(d=>{
      hoso.innerHTML="";
      d.counts.forEach(c=>{
        let o=document.createElement("option");
        o.value=o.text=c;hoso.appendChild(o);
      });
    });
  }
};

variety.onchange=()=>{if(variety.value==="__lookup_variety__"){openLookup("/criteria/varieties");variety.value="";}}
species.onchange=()=>{if(species.value==="__lookup_species__"){openLookup("/criteria/species");species.value="";}}

let selectedRow=null;
document.querySelectorAll("#dataTable tbody tr").forEach(r=>{
  r.onclick=()=>{
    document.querySelectorAll("tr").forEach(x=>x.classList.remove("selected"));
    r.classList.add("selected");
    selectedRow=r;
    threeDotsMenu.style.display="block";
  };
});

dotsBtn.onclick=()=>dropdownMenu.style.display=
  dropdownMenu.style.display==="block"?"none":"block";

function editSelected(){
  if(!selectedRow)return Swal.fire("Select row");
  location="/processing/grading/edit/"+selectedRow.dataset.id;
}
function deleteSelected(){
  if(!selectedRow)return Swal.fire("Select row");
  fetch("/processing/grading/delete/"+selectedRow.dataset.id,{method:"POST"})
  .then(()=>location.reload());
}
</script>

</body>
</html>
