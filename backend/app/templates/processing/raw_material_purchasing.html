<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>RAW MATERIAL PURCHASING - BKNR SOLUTIONS</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<style>
  body {font-family:Arial,sans-serif;background:#e6f2ff;margin:0;padding:0;}
  h2{text-align:center;color:#003366;margin:20px 0;font-weight:700;}

  .form-container{
      width:95%;max-width:1280px;margin:0 auto;
      background:white;padding:25px;border-radius:10px;
      box-shadow:0 0 8px rgba(0,0,0,0.2);
  }

  .row{display:flex;flex-wrap:wrap;justify-content:space-between;margin-bottom:15px;}

  /* ‚≠ê 6 columns perfect */
  .col{
      width:15.5%;
      display:flex;
      flex-direction:column;
      margin-bottom:10px;
  }

  @media(max-width:900px){ .col{width:48%;}}
  @media(max-width:600px){ .col{width:100%;}}

  label{font-weight:600;color:#003366;margin-bottom:4px;}

  input, select, textarea{
      padding:8px;border:1px solid #aac1dd;background:#f9fcff;
      border-radius:6px;font-size:14px;
  }

  textarea{height:50px;}

  .actions{text-align:center;margin-top:20px;}
  .btn{background:#003366;color:white;border:none;padding:10px 25px;
       border-radius:7px;font-weight:700;cursor:pointer;}
  .btn-clear{background:#777;}

  table{
      width:95%;max-width:1280px;margin:25px auto;
      border-collapse:collapse;background:white;
      box-shadow:0 0 8px rgba(0,0,0,0.15);
  }
  th,td{
      padding:6px 8px;
      border-bottom:1px solid #ccc;
      font-size:13px;
      white-space:nowrap;
  }
  th{
      background:#003366;color:white;
      font-size:13px;
  }

  tr:hover{background:#e9f1ff;cursor:pointer;}
  tr.selected{background:#bed6ff!important;}

  #threeDotsMenu{
      width:95%;max-width:1280px;margin:5px auto;
      text-align:right;display:none;
  }

  #dropdownMenu{
      display:none;position:absolute;right:50px;background:white;
      width:160px;border-radius:8px;z-index:1000;
      border:1px solid #ccc;
  }
  .menu-item{padding:10px;cursor:pointer;}
  .menu-item:hover{background:#e6f2ff;}

  #lookupModal{
      display:none;position:fixed;left:0;top:0;width:100%;height:100%;
      background:rgba(0,0,0,0.45);justify-content:center;align-items:center;
      z-index:9999;
  }

  .lookup-box{
      background:white;width:90%;max-width:900px;height:85vh;
      border-radius:10px;position:relative;overflow:hidden;
  }

  .close-popup{
      position:absolute;top:10px;right:20px;
      font-size:22px;font-weight:bold;cursor:pointer;color:#003366;
  }

  iframe{width:100%;height:100%;border:none;}
</style>
</head>

<body>

<h2>RAW MATERIAL PURCHASING</h2>

<form method="post"
action="{% if edit_data %}/processing/raw_material_purchasing/update/{{edit_data.id}}{% else %}/processing/raw_material_purchasing{% endif %}">
  <div class="form-container">

    <input type="hidden" name="email" value="{{request.session.get('email')}}">

    <!-- ROW 1 -->
    <div class="row">
      <div class="col">
        <label>Batch</label>
        <select id="batch" name="batch_number" required>
          <option disabled {% if not edit_data %}selected{% endif %}>Select</option>
          {% for b in batch_list %}
          <option value="{{b}}" {% if edit_data and edit_data.batch_number==b %}selected{% endif %}>{{b}}</option>
          {% endfor %}
          <option value="__lookup_batch__">+ add new</option>
        </select>
      </div>

      <div class="col">
        <label>Supplier</label>
        <select id="supplier" name="supplier_name" required>
          <option disabled {% if not edit_data %}selected{% endif %}>Select</option>
          {% for s in supplier_list %}
          <option value="{{s}}" {% if edit_data and edit_data.supplier_name==s %}selected{% endif %}>{{s}}</option>
          {% endfor %}
          <option value="__lookup_supplier__">+ add new</option>
        </select>
      </div>

      <div class="col">
        <label>Variety</label>
        <select id="variety" name="variety_name">
          <option disabled>Select</option>
          {% for v in variety_list %}
          <option value="{{v}}" {% if edit_data and edit_data.variety_name==v %}selected{% endif %}>{{v}}</option>
          {% endfor %}
          <option value="__lookup_variety__">+ add new</option>
        </select>
      </div>

      <div class="col">
        <label>Species</label>
        <select id="species" name="species">
          <option disabled>Select</option>
          {% for s in species_list %}
          <option value="{{s}}" {% if edit_data and edit_data.species==s %}selected{% endif %}>{{s}}</option>
          {% endfor %}
          <option value="__lookup_species__">+ add new</option>
        </select>
      </div>

      <div class="col">
        <label>Count</label>
        <input name="count" value="{{edit_data.count if edit_data else ''}}">
      </div>

      <div class="col">
        <label>Material Boxes</label>
        <input type="number" name="material_boxes"
        value="{{edit_data.material_boxes if edit_data else ''}}">
      </div>
    </div>

    <!-- ROW 2 -->
    <div class="row">
      <div class="col">
        <label>G1 quantity</label>
        <input type="number" step="0.01" id="g1" name="g1_qty"
        value="{{edit_data.g1_qty if edit_data else ''}}">
      </div>

      <div class="col">
        <label>G2 quantity</label>
        <input type="number" step="0.01" id="g2" name="g2_qty"
        value="{{edit_data.g2_qty if edit_data else ''}}">
      </div>

      <div class="col">
        <label>DC quantity</label>
        <input type="number" step="0.01" id="dc" name="dc_qty"
        value="{{edit_data.dc_qty if edit_data else ''}}">
      </div>

      <div class="col">
        <label>Received quantity</label>
        <input type="number" id="received_qty" name="received_qty" readonly
        value="{{edit_data.received_qty if edit_data else ''}}">
      </div>

      <div class="col">
        <label>Rate/kg</label>
        <input type="number" step="0.01" id="rate" name="rate_per_kg"
        value="{{edit_data.rate_per_kg if edit_data else ''}}">
      </div>

      <div class="col">
        <label>Amount</label>
        <input type="number" id="amount" name="amount" readonly
        value="{{edit_data.amount if edit_data else ''}}">
      </div>
    </div>

    <!-- ROW 3 -->
    <div class="row">
      <div class="col">
        <label>Remarks</label>
        <textarea name="remarks">{{edit_data.remarks if edit_data else ''}}</textarea>
      </div>
    </div>

    <div class="actions">
      <button class="btn" type="submit">{% if edit_data %}UPDATE{% else %}SAVE{% endif %}</button>
      <button class="btn btn-clear" type="button"
      onclick="window.location='/processing/raw_material_purchasing'">CLEAR</button>
    </div>

  </div>
</form>

{% if today_data %}
<div id="threeDotsMenu">
  <button class="btn" id="dotsBtn">‚ãÆ</button>
  <div id="dropdownMenu">
    <div class="menu-item" onclick="editSelected()">‚úèÔ∏è Edit</div>
    <div class="menu-item" onclick="deleteSelected()">üóë Delete</div>
  </div>
</div>

<table id="dataTable">
<thead>
<tr>
  <th>ID</th>
  <th>Batch</th>
  <th>Supplier</th>
  <th>Variety</th>
  <th>Species</th>
  <th>Count</th>
  <th>G1</th>
  <th>G2</th>
  <th>DC</th>
  <th>Received</th>
  <th>Rate</th>
  <th>Amount</th>
  <th>Email</th>
  <th>Remarks</th>
  <th>Date</th>
  <th>Time</th>
</tr>
</thead>

<tbody>
{% for r in today_data %}
<tr data-id="{{r.id}}">
  <td>{{r.id}}</td>
  <td>{{r.batch_number}}</td>
  <td>{{r.supplier_name}}</td>
  <td>{{r.variety_name}}</td>
  <td>{{r.species}}</td>
  <td>{{r.count}}</td>
  <td>{{r.g1_qty}}</td>
  <td>{{r.g2_qty}}</td>
  <td>{{r.dc_qty}}</td>
  <td>{{r.received_qty}}</td>
  <td>{{r.rate_per_kg}}</td>
  <td>{{r.amount}}</td>
  <td>{{r.email}}</td>
  <td>{{r.remarks}}</td>
  <td>{{r.date}}</td>
  <td>{{r.time}}</td>
</tr>
{% endfor %}
</tbody>
</table>
{% endif %}

<!-- LOOKUP POPUP -->
<div id="lookupModal">
  <div class="lookup-box">
    <span class="close-popup" onclick="closeLookup()">√ó</span>
    <iframe id="lookupFrame"></iframe>
  </div>
</div>

<script>
/* LOOKUP */
function openLookup(url) {
  document.getElementById("lookupFrame").src = url;
  document.getElementById("lookupModal").style.display = "flex";
}

document.getElementById("batch").addEventListener("change", function(){
  if(this.value==="__lookup_batch__") {
     openLookup("/processing/gate_entry");
     this.value="";
  }
});

document.getElementById("supplier").addEventListener("change", function(){
  if(this.value==="__lookup_supplier__") {
     openLookup("/criteria/suppliers");
     this.value="";
  }
});

document.getElementById("variety").addEventListener("change", function(){
  if(this.value==="__lookup_variety__") {
     openLookup("/criteria/varieties");
     this.value="";
  }
});

document.getElementById("species").addEventListener("change", function(){
  if(this.value==="__lookup_species__") {
     openLookup("/criteria/species");
     this.value="";
  }
});

function closeLookup(){
  document.getElementById("lookupModal").style.display="none";
  location.reload();
}


/* ‚≠ê AUTO FILL SUPPLIER BASED ON BATCH */
const batchSupplierMap = {{ batch_supplier_map_json | safe }};

document.getElementById("batch").addEventListener("change", function () {
    let b = this.value;
    if (b === "__lookup_batch__") return;

    if (batchSupplierMap[b]) {
        document.getElementById("supplier").value = batchSupplierMap[b];
    }
});


/* CALCULATIONS */
function calc(){
  let g1=parseFloat(document.getElementById("g1").value)||0;
  let g2=parseFloat(document.getElementById("g2").value)||0;
  let dc=parseFloat(document.getElementById("dc").value)||0;
  let rate=parseFloat(document.getElementById("rate").value)||0;

  document.getElementById("received_qty").value=(g1+g2+dc).toFixed(2);
  document.getElementById("amount").value=(g1*rate).toFixed(2);
}

["g1","g2","dc","rate"].forEach(id=>{
  document.getElementById(id)?.addEventListener("input", calc);
});

calc();


/* TABLE SELECT */
let selectedRow=null;
document.querySelectorAll("#dataTable tbody tr").forEach(row=>{
  row.addEventListener("click",()=>{
    document.querySelectorAll("tr").forEach(r=>r.classList.remove("selected"));
    row.classList.add("selected");
    selectedRow=row;
    document.getElementById("threeDotsMenu").style.display="block";
  });
});


/* MENU */
document.getElementById("dotsBtn")?.addEventListener("click",()=>{
  let x=document.getElementById("dropdownMenu");
  x.style.display=x.style.display==="block"?"none":"block";
});


function editSelected(){
  if(!selectedRow) return Swal.fire("No row selected");
  window.location="/processing/raw_material_purchasing/edit/"+selectedRow.dataset.id;
}

function deleteSelected(){
  if(!selectedRow) return Swal.fire("No row selected");
  fetch("/processing/raw_material_purchasing/delete/"+selectedRow.dataset.id,{method:"POST"})
  .then(()=>location.reload());
}

</script>

</body>
</html>
