<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>RAW MATERIAL PURCHASING - BKNR SOLUTIONS</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<style>
body{
  font-family:Arial,sans-serif;
  background:#e6f2ff;
  margin:0;
}
h2{
  text-align:center;
  color:#003366;
  margin:20px 0;
}

/* ================= FORM ================= */
.form-container{
  width:96%;
  max-width:1400px;
  margin:0 auto;
  background:#fff;
  padding:22px;
  border-radius:10px;
  box-shadow:0 0 8px rgba(0,0,0,.15);
  overflow-x:auto; /* mobile safety */
}

/* ALWAYS 6 COLUMNS */
.row{
  display:grid;
  grid-template-columns:repeat(6,1fr);
  gap:14px;
  margin-bottom:16px;
}

.col{
  display:flex;
  flex-direction:column;
}

label{
  font-size:13px;
  font-weight:600;
  color:#003366;
  margin-bottom:6px;
}

input,select{
  padding:8px;
  border:1px solid #a3bcd6;
  border-radius:6px;
  background:#f9fcff;
  font-size:14px;
}

/* Disabled (formula fields) */
input:disabled{
  background:#eef2f7;
  color:#374151;
  font-weight:600;
}

/* BUTTONS */
.actions{
  text-align:center;
  margin-top:18px;
}
.btn{
  background:#003366;
  color:#fff;
  border:none;
  padding:10px 22px;
  border-radius:6px;
  font-weight:600;
  cursor:pointer;
}
.btn-clear{background:#777}

/* ================= TABLE ================= */
table{
  width:96%;
  max-width:1400px;
  margin:22px auto;
  border-collapse:collapse;
  background:#fff;
  border-radius:10px;
  overflow:hidden;
  box-shadow:0 0 8px rgba(0,0,0,.15);
}
th,td{
  padding:9px;
  border-bottom:1px solid #ccc;
  font-size:13px;
}
th{
  background:#003366;
  color:#fff;
}
tr:hover{background:#e6f2ff;cursor:pointer}
tr.selected{background:#cce5ff!important}

/* ================= MENU ================= */
#threeDotsMenu{
  width:96%;
  max-width:1400px;
  margin:10px auto;
  text-align:right;
  position:relative;
  display:none;
}
#dropdownMenu{
  display:none;
  position:absolute;
  right:0;
  background:#fff;
  border:1px solid #ccc;
  border-radius:8px;
  width:180px;
  box-shadow:0 2px 6px rgba(0,0,0,.35);
  z-index:1000;
}
.menu-item{
  padding:10px;
  cursor:pointer;
}
.menu-item:hover{background:#e6f2ff}
</style>
</head>

<body>

<h2>RAW MATERIAL PURCHASING</h2>

<form method="post"
action="{% if edit_data %}/processing/raw_material_purchasing/update/{{edit_data.id}}{% else %}/processing/raw_material_purchasing{% endif %}">

<div class="form-container">

<!-- ================= ROW 1 ================= -->
<div class="row">
  <div class="col">
    <label>Batch Number</label>
    <select name="batch_number" id="batch_dd" required>
      <option disabled selected>Select Batch</option>
      {% for b in batch_list %}
      <option value="{{b}}" {% if edit_data and edit_data.batch_number==b %}selected{% endif %}>{{b}}</option>
      {% endfor %}
    </select>
  </div>

  <div class="col">
    <label>Supplier Name</label>
    <input name="supplier_name" id="supplier_name" readonly
           value="{{edit_data.supplier_name if edit_data else ''}}">
  </div>

  <div class="col">
    <label>Variety</label>
    <select name="variety_name" required>
      <option disabled selected>Select Variety</option>
      {% for v in variety_list %}
      <option value="{{v}}" {% if edit_data and edit_data.variety_name==v %}selected{% endif %}>{{v}}</option>
      {% endfor %}
    </select>
  </div>

  <div class="col">
    <label>Species</label>
    <select name="species">
      <option disabled selected>Select Species</option>
      {% for s in species_list %}
      <option value="{{s}}" {% if edit_data and edit_data.species==s %}selected{% endif %}>{{s}}</option>
      {% endfor %}
    </select>
  </div>

  <div class="col">
    <label>Count</label>
    <input name="count" value="{{edit_data.count if edit_data else ''}}">
  </div>

  <div class="col">
    <label>Material Boxes</label>
    <input type="number" step="0.01" name="material_boxes"
           value="{{edit_data.material_boxes if edit_data else 0}}">
  </div>
</div>

<!-- ================= ROW 2 ================= -->
<div class="row">
  <div class="col">
    <label>G1 Qty (kg)</label>
    <input type="number" step="0.01" name="g1_qty" id="g1"
           value="{{edit_data.g1_qty if edit_data else 0}}">
  </div>

  <div class="col">
    <label>G2 Qty (kg)</label>
    <input type="number" step="0.01" name="g2_qty" id="g2"
           value="{{edit_data.g2_qty if edit_data else 0}}">
  </div>

  <div class="col">
    <label>DC Qty (kg)</label>
    <input type="number" step="0.01" name="dc_qty" id="dc"
           value="{{edit_data.dc_qty if edit_data else 0}}">
  </div>

  <!-- FORMULA -->
  <div class="col">
    <label>Received Qty</label>
    <input type="number" step="0.01"
           id="received_qty"
           value="{{edit_data.received_qty if edit_data else 0}}"
           disabled>
  </div>

  <div class="col">
    <label>Rate / KG</label>
    <input type="number" step="0.01" name="rate_per_kg" id="rate"
           value="{{edit_data.rate_per_kg if edit_data else 0}}">
  </div>

  <!-- FORMULA -->
  <div class="col">
    <label>Amount</label>
    <input type="number" step="0.01"
           id="amount"
           value="{{edit_data.amount if edit_data else 0}}"
           disabled>
  </div>
</div>

<!-- ================= ROW 3 ================= -->
<div class="row">
  <div class="col">
    <label>Remarks</label>
    <input name="remarks" value="{{edit_data.remarks if edit_data else ''}}">
  </div>
</div>

<div class="actions">
  <button class="btn" type="submit">
    {% if edit_data %}UPDATE{% else %}SAVE{% endif %}
  </button>
  <button class="btn btn-clear" type="button"
          onclick="window.location='/processing/raw_material_purchasing'">
    RESET
  </button>
</div>

</div>
</form>

{% if today_data %}
<!-- ================= MENU ================= -->
<div id="threeDotsMenu">
  <button class="btn" id="dotsBtn">‚ãÆ</button>
  <div id="dropdownMenu">
    <div class="menu-item" onclick="editSelected()">‚úèÔ∏è Edit</div>
    <div class="menu-item" onclick="deleteSelected()">üóë Delete</div>
    <div class="menu-item" onclick="printSelected()">üñ® Print</div>
  </div>
</div>

<!-- ================= TABLE ================= -->
<table id="dataTable">
<thead>
<tr>
  <th>ID</th><th>Batch</th><th>Supplier</th><th>Variety</th>
  <th>Species</th><th>Count</th>
  <th>G1</th><th>G2</th><th>DC</th>
  <th>Received</th><th>Rate</th><th>Amount</th>
  <th>Boxes</th><th>Date</th><th>Time</th>
  <th>Email</th><th>Company</th>
</tr>
</thead>
<tbody>
{% for r in today_data %}
<tr data-id="{{r.id}}">
  <td>{{r.id}}</td>
  <td>{{r.batch_number}}</td>
  <td>{{r.supplier_name}}</td>
  <td>{{r.variety_name}}</td>
  <td>{{r.species}}</td>
  <td>{{r.count}}</td>
  <td>{{r.g1_qty}}</td>
  <td>{{r.g2_qty}}</td>
  <td>{{r.dc_qty}}</td>
  <td>{{r.received_qty}}</td>
  <td>{{r.rate_per_kg}}</td>
  <td>{{r.amount}}</td>
  <td>{{r.material_boxes}}</td>
  <td>{{r.date}}</td>
  <td>{{r.time}}</td>
  <td>{{r.email}}</td>
  <td>{{r.company_id}}</td>
</tr>
{% endfor %}
</tbody>
</table>
{% endif %}

<script>
let batchSupplierMap = {{ batch_supplier_map_json | safe }};
let selectedRow = null;

/* Batch -> Supplier */
batch_dd.addEventListener("change",()=>{
  supplier_name.value = batchSupplierMap[batch_dd.value] || "";
});

/* FORMULA CALCULATIONS */
function calcFormula(){
  let g1v = parseFloat(g1.value) || 0;
  let g2v = parseFloat(g2.value) || 0;
  let dcv = parseFloat(dc.value) || 0;
  let ratev = parseFloat(rate.value) || 0;

  let recv = g1v + g2v + dcv;
  received_qty.value = recv.toFixed(2);
  amount.value = (recv * ratev).toFixed(2);
}
[g1,g2,dc,rate].forEach(el=>{
  el.addEventListener("input",calcFormula);
});

/* ROW SELECT */
document.querySelectorAll("#dataTable tbody tr").forEach(r=>{
  r.addEventListener("click",()=>{
    document.querySelectorAll("#dataTable tr").forEach(x=>x.classList.remove("selected"));
    r.classList.add("selected");
    selectedRow=r;
    threeDotsMenu.style.display="block";
  });
});

/* MENU */
dotsBtn?.addEventListener("click",()=>{
  dropdownMenu.style.display =
    dropdownMenu.style.display==="block"?"none":"block";
});

function editSelected(){
  if(!selectedRow) return alert("Select row");
  location="/processing/raw_material_purchasing/edit/"+selectedRow.dataset.id;
}
function deleteSelected(){
  if(!selectedRow) return;
  if(!confirm("Delete record?")) return;
  fetch("/processing/raw_material_purchasing/delete/"+selectedRow.dataset.id,
        {method:"POST"}).then(()=>location.reload());
}
function printSelected(){
  if(!selectedRow) return;
  let w=window.open("","_blank");
  w.document.write("<h3>RAW MATERIAL PURCHASING</h3><table border='1'>"+selectedRow.innerHTML+"</table>");
  w.print();
}
</script>

</body>
</html>
